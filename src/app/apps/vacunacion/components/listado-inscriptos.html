<plex-layout main="{{mainSize}}">
    <plex-layout-main>
        <plex-title titulo="Listado de inscriptos para vacunación" size="lg"> </plex-title>

        <filtros-vacunacion></filtros-vacunacion>

        <table class="table table-striped table-hover table-lista-vacunacion">
            <thead>
                <tr>
                    <th class="w-20">Grupo</th>
                    <th>Documento</th>
                    <th class="w-20">Apellido y nombre</th>
                    <th>Sexo</th>
                    <th>Edad</th>
                    <th>Teléfono</th>
                    <th>Localidad</th>
                    <th>Fecha de registro</th>
                    <th>Estado</th>
                </tr>
            </thead>
            <tbody infiniteScroll [infiniteScrollDistance]="2" [infiniteScrollThrottle]="80" (scrolled)="onScroll()"
                   [scrollWindow]="false">
                <tr *ngFor="let paciente of listado" (click)="showInSidebar(paciente)">
                    <td class="w-20" *ngIf="paciente.grupo"> {{ grupoPoblacional(paciente.grupo.nombre) }} </td>
                    <td class="w-20" *ngIf="!paciente.grupo"> No indica </td>
                    <td> {{ paciente.documento }} </td>
                    <td class="w-20"> {{ paciente.apellido + ', ' + paciente.nombre }} </td>
                    <td> {{ paciente.sexo }} </td>
                    <td> {{ paciente | edad }} </td>
                    <td> {{ paciente.telefono }} </td>
                    <td> {{ paciente.localidad?.nombre || 'Sin datos' }} </td>
                    <td> {{ paciente.fechaRegistro | fecha }} </td>
                    <td> {{ paciente.estado }} </td>
                </tr>
            </tbody>
        </table>
    </plex-layout-main>

    <plex-layout-sidebar *ngIf="showSidebar" type="invert">
        <plex-title titulo="Detalle paciente" size="md">
            <plex-button class="pr-1" *ngIf="!pacienteSelected.paciente" type="warning" size="sm"
                         label="Asociar paciente" [disabled]="candidatosBuscados" (click)="buscarCandidatos()">
            </plex-button>
            <plex-button type="warning" size="sm" (click)="editPaciente()"
                         *ngIf="pacienteSelected.estado === 'pendiente' && permisosEdicion.length && !editando">
                EDITAR
            </plex-button>
            <plex-button type="success" *ngIf="!domicilioValidado(pacienteSelected)" size="sm"
                         (click)="validarDomicilio(pacienteSelected)" class='ml-2'>
                VALIDAR DOMICILIO
            </plex-button>
            <plex-button type="danger" icon="close" size="sm" (click)="closeSidebar()" class='ml-2'></plex-button>
        </plex-title>

        <ng-container *ngIf="pacienteSelected">
            <!-- Si no tiene paciente de mpi asociado -->
            <ng-container *ngIf="!pacienteSelected.paciente">

                <plex-label *ngIf="!candidatosBuscados" titulo="No se encontró ningún paciente asociado">
                </plex-label>


                <plex-list *ngIf="candidatos?.length">
                    <plex-item *ngFor="let candidato of candidatos">
                        <img [ngClass]="{'img-fallecido' : candidato.fechaFallecimiento}"
                             [mpiFotoPaciente]="candidato" />

                        <plex-label *ngIf="!candidato.numeroIdentificacion" titulo="{{ candidato | nombre }}"
                                    subtitulo="{{ (candidato.documento | number) || 'Sin DNI' }}">
                        </plex-label>

                        <plex-label *ngIf="candidato.numeroIdentificacion" titulo="{{ candidato | nombre }}"
                                    subtitulo="{{ candidato.numeroIdentificacion }}"></plex-label>

                        <plex-label titulo="{{ candidato | edad }}"
                                    subtitulo="{{ candidato.fechaNacimiento | fecha:'utc' }}">
                        </plex-label>

                        <plex-badge *ngIf="candidato.fechaFallecimiento" type="danger">Fallecido:
                            {{ candidato.fechaFallecimiento | fecha:'utc'}}
                        </plex-badge>

                        <plex-badge type="info">{{ candidato | sexo }}
                        </plex-badge>

                        <plex-badge type="" class=""
                                    [ngClass]="{'text-success' : candidato.estado === 'validado' , 'text-warning' : candidato.estado === 'temporal'} ">
                            {{ candidato.estado }}
                        </plex-badge>

                        <plex-button type="info" size="sm" label="Seleccionar" (click)="asociarCandidato(candidato)">
                        </plex-button>
                    </plex-item>
                </plex-list>

                <div class="pt-2" *ngIf="!candidatos?.length && candidatosBuscados" grow="full">
                    No se encontró ningún paciente candidato para asociar. Asegúrese de que
                    el paciente se encuentra registrado en MPI.</div>
            </ng-container>

            <!-- Seccion datos personales -->
            <paciente-detalle *ngIf="pacienteSelected.paciente" [paciente]="pacienteSelected.paciente" reload="true"
                              orientacion="horizontal">
            </paciente-detalle>

            <!-- formulario para editar inscripción -->
            <editar-inscripcion *ngIf="editando" [inscripcion]="pacienteSelected"
                                (returnEdicion)="returnEdicion($event)"></editar-inscripcion>

            <!-- datos de inscripción -->
            <plex-title *ngIf="!editando" titulo="Datos de la inscripción" size="sm"></plex-title>
            <plex-grid *ngIf="!editando" type="full" size="md">
                <plex-label titulo="Email"
                            subtitulo="{{ pacienteSelected.email? pacienteSelected.email : 'No indica' }}"
                            case="lowercase">
                </plex-label>
                <plex-label titulo="Teléfono"
                            subtitulo="{{ pacienteSelected.telefono? pacienteSelected.telefono : 'No inidica' }}">
                </plex-label>
                <plex-label titulo="Alergia" subtitulo="{{ pacienteSelected.alergia ? 'Si' : 'No' }}">
                </plex-label>
                <plex-label *ngIf="pacienteSelected.cud" titulo="CUD" subtitulo="{{ pacienteSelected.cud }}">
                </plex-label>

                <plex-label titulo="En aislamiento" subtitulo="{{ pacienteSelected.aislamiento ? 'Si' : 'No' }}"> :
                </plex-label>
                <plex-label *ngIf="pacienteSelected.sexo === 'femenino'" titulo="Amamantando"
                            subtitulo="{{ pacienteSelected.amamantando ? 'Si' : 'No' }}">
                </plex-label>
                <plex-label *ngIf="pacienteSelected.sexo === 'femenino'" titulo="Embarazada"
                            subtitulo="{{ pacienteSelected.embarazada ? 'Si' : 'No' }}">
                </plex-label>
                <plex-label titulo="Enfermedad" subtitulo="{{ pacienteSelected.enfermedad ? 'Si' : 'No' }}">
                </plex-label>
                <plex-label titulo="Condición" subtitulo="{{ pacienteSelected.condicion ? 'Si' : 'No' }}">
                </plex-label>
                <plex-label titulo="Convaleciente" subtitulo="{{ pacienteSelected.convaleciente ? 'Si' : 'No' }}">
                </plex-label>

                <!-- personal salud -->
                <ng-container *ngIf="pacienteSelected.personal_salud">
                    <plex-label titulo="Profesión" subtitulo="{{ pacienteSelected.profesion }}"></plex-label>
                    <plex-label titulo="Establecimiento" subtitulo="{{ pacienteSelected.establecimiento }}">
                    </plex-label>
                    <plex-label titulo="Relación" subtitulo="{{ pacienteSelected.relacion }}"></plex-label>
                    <plex-label titulo="Matricula" subtitulo="{{ pacienteSelected.matricula }}"></plex-label>
                </ng-container>

                <!-- inscripcion -->
                <plex-label titulo="Estado" subtitulo="{{ pacienteSelected.estado }}"></plex-label>
                <plex-label titulo="Fecha de registro" subtitulo="{{ pacienteSelected.fechaRegistro | fecha }}">
                </plex-label>
                <plex-label titulo="Plasma" subtitulo="{{ pacienteSelected.plasma ? 'Si' : 'No' }}"></plex-label>
                <plex-label titulo="Validado" subtitulo="{{ pacienteSelected.validado ? 'Si' : 'No' }}">
                </plex-label>

                <div *ngIf="pacienteSelected.validaciones?.length">
                    <label>Validaciones</label>
                    <div *ngFor="let item of pacienteSelected.validaciones"><small>{{item}}</small></div>
                </div>
            </plex-grid>
        </ng-container>
    </plex-layout-sidebar>
</plex-layout>

<plex-layout main="{{mainSize}}">
    <plex-layout-main>
        <plex-title titulo="Llamador de inscriptos para vacunación" size="lg">
        </plex-title>
        <form #formulario="ngForm">
            <plex-wrapper>
                <plex-select name="grupo" label="Grupo" [(ngModel)]="grupoSelected" idField="nombre"
                             labelField="descripcion" [data]="gruposPoblacionales" [required]="true">
                </plex-select>
                <plex-select name="localidad" label="Localidad" [(ngModel)]="localidadSelected" idField="nombre"
                             labelField="nombre" [data]="localidades$ | async" [required]="true">
                </plex-select>
                <plex-button size="md" type="success" label="Próximo llamado" (click)="asignarInscripcion()"
                             [disabled]="!formulario.valid || !pacienteProcesado" [validateForm]="formulario">
                </plex-button>
            </plex-wrapper>
        </form>

        <plex-table [columns]="columns" #table="plTable" [offset]="170">
            <plex-table-columns>
            </plex-table-columns>
            <tr *ngIf="paciente" (click)="showInSidebar(paciente)" class='selectable'
                [class.selected]="paciente.id===pacienteSelected?.id">
                <td *plTableCol="'grupo'"> {{ grupoPoblacional(paciente.grupo.nombre) }} </td>
                <td *plTableCol="'documento'"> {{ paciente.documento }} </td>
                <td *plTableCol="'apellido-nombre'"> {{ paciente.apellido + ', ' + paciente.nombre }} </td>
                <td *plTableCol="'sexo'"> {{ paciente.sexo === 'femenino' ? 'F' : 'M' }} </td>
                <td *plTableCol="'edad'"> {{ paciente | edad }} </td>
                <td *plTableCol="'localidad'"> {{ paciente.localidad?.nombre || 'Sin datos' }} </td>
                <td *plTableCol="'fecha-registro'"> {{ paciente.fechaRegistro | fecha }} </td>
                <td *plTableCol="'estado'">
                    <plex-badge
                                type="{{paciente.estado === 'habilitado' ? 'success' : (paciente.estado === 'pendiente' ? 'warning' : 'danger')}}">
                        {{ paciente.estado }}
                    </plex-badge>
                    <span class="pl-1" *ngIf="paciente.nota">
                        <i title="{{ paciente.nota }}" class="mdi mdi-comment-outline"></i>
                    </span>
                </td>
                <td *plTableCol="'certificado'">
                    <plex-label *ngIf="paciente.grupo.nombre === 'factores-riesgo'"
                                type="{{ paciente.idPrestacionCertificado ? 'success' : 'danger' }}" titulo=""
                                subtitulo="" icon="{{ paciente.idPrestacionCertificado ? 'check' : 'close' }}">
                    </plex-label>
                    <plex-label *ngIf="paciente.grupo.nombre !== 'factores-riesgo'">No corresponde
                    </plex-label>
                </td>
            </tr>
        </plex-table>
    </plex-layout-main>
    <plex-layout-sidebar *ngIf="showSidebar" type="invert">
        <plex-title titulo="Detalle paciente" size="md">
            <plex-button type="danger" icon="close" size="sm" (click)="closeSidebar()" class='ml-1 mr-1'></plex-button>
        </plex-title>
        <plex-badge type="warning" size="block" class="mb-2" *ngIf="!pacienteSelected.paciente" grow="full">
            La inscripción no tiene paciente asociado</plex-badge>
        <!-- Seccion datos personales -->
        <paciente-detalle *ngIf="pacienteSelected.paciente" [paciente]="pacienteSelected.paciente" reload="true"
                          orientacion="horizontal">
        </paciente-detalle>
        <plex-title titulo="Datos de la inscripción" size="sm" *ngIf="!editando && !dacionTurno && !showAgregarNota">
            <plex-button type="info" icon="{{ pacienteSelected.nota ? 'comment' : 'comment-outline' }}" size="sm"
                         (click)="showAgregarNota = true"
                         title="{{ pacienteSelected.nota ? 'Modificar nota' : 'Agregar nota' }}">
            </plex-button>
            <plex-button type="warning" size="sm" (click)="editPaciente()" icon="pencil"
                         *ngIf="permisosEdicion.length && !editando" title="Editar inscripción">
            </plex-button>
            <plex-button type="success" size="sm" title="{{ pacienteSelected.turno ? 'Modificar turno' : 'Dar turno' }}"
                         icon="calendar-plus" class='mr-1' (click)="darTurno()"></plex-button>
        </plex-title>
        <notas *ngIf="showAgregarNota" [inscripcion]="pacienteSelected" (returnNotas)="returnNotas($event)">
        </notas>
        <!-- formulario para editar inscripción -->
        <editar-inscripcion *ngIf="editando" [inscripcion]="pacienteSelected" (returnEdicion)="returnEdicion($event)">
        </editar-inscripcion>
        <detalle-inscripcion *ngIf="!editando && !dacionTurno && !showAgregarNota" [inscripcion]="pacienteSelected">
        </detalle-inscripcion>
        <!-- formulario para dar turno -->
        <dacion-turno *ngIf="dacionTurno" [inscripcion]="pacienteSelected"
                      (returnDacionTurno)="returnDacionTurno($event)">
        </dacion-turno>
    </plex-layout-sidebar>
</plex-layout>

<plex-layout main="8">
    <plex-layout-main>
        <header [hidden]="mainView !== 'mapa-camas'">
            <plex-title titulo="Mapa de Camas">
                <plex-button *ngIf="capa === 'estadistica'" class="mr-1" size="sm" label="LISTA DE ESPERA"
                             type="primary" (click)="gotoListaEspera()">
                </plex-button>
                <plex-button *ngIf="capa === 'estadistica'" class="mr-1" size="sm" label="LISTADO DE INTERNACIÃ“N"
                             type="primary" (click)="verListadoInternacion()">
                </plex-button>
                <plex-dropdown *ngIf="capa === 'estadistica' && permisoCenso" size="sm" label="VER CENSO" type="primary"
                               class="d-inline-block" [right]="true" [items]="itemsDropdown">
                </plex-dropdown>
            </plex-title>

            <app-filtros-camas></app-filtros-camas>

            <plex-title titulo="LISTADO DE CAMAS" size="sm">
                <plex-button *ngIf="permisoIngreso" class="mr-1" label="INTERNAR PACIENTE" type="info" size="sm"
                             (click)="selectCama(null, {'nombre' : 'Internar Paciente', 'accion' : 'internarPaciente'})">
                </plex-button>
                <plex-button *ngIf="permisoCrearCama" label="AGREGAR CAMA" type="success" size="sm"
                             (click)="agregarCama()">
                </plex-button>
            </plex-title>

        </header>
        <fieldset [hidden]="mainView !== 'mapa-camas'">
            <cdk-virtual-scroll-viewport #scrollViewport [itemSize]="65.56">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th class="sortable" (click)="sortTable('cama')">
                                CAMA
                                <span *ngIf="sortBy === 'cama'">
                                    <plex-icon *ngIf="sortOrder === 'desc'" name="chevron-down"></plex-icon>
                                    <plex-icon *ngIf="sortOrder === 'asc'" name="chevron-up"></plex-icon>
                                </span>
                            </th>
                            <th class="sortable" (click)="sortTable('paciente')">
                                PACIENTE
                                <span *ngIf="sortBy === 'paciente'">
                                    <plex-icon *ngIf="sortOrder === 'desc'" name="chevron-down"></plex-icon>
                                    <plex-icon *ngIf="sortOrder === 'asc'" name="chevron-up"></plex-icon>
                                </span>
                            </th>
                            <th class="sortable" (click)="sortTable('unidadOrganizativa')">
                                UNIDAD ORGANIZATIVA
                                <span *ngIf="sortBy === 'unidadOrganizativa'">
                                    <plex-icon *ngIf="sortOrder === 'desc'" name="chevron-down"></plex-icon>
                                    <plex-icon *ngIf="sortOrder === 'asc'" name="chevron-up"></plex-icon>
                                </span>
                            </th>
                            <th class="sortable col-estado" (click)="sortTable('estado')">
                                ESTADO
                                <span *ngIf="sortBy === 'estado'">
                                    <plex-icon *ngIf="sortOrder === 'desc'" name="chevron-down"></plex-icon>
                                    <plex-icon *ngIf="sortOrder === 'asc'" name="chevron-up"></plex-icon>
                                </span>
                            </th>
                            <th class="col-acciones">ACCIONES</th>
                        </tr>
                    </thead>
                    <tbody>
                        <ng-container *ngIf="(selectedCama$ | async) as selectedCama">
                            <tr app-item-cama *cdkVirtualFor="let cama of camas | async" [cama]="cama" [capa]="capa"
                                [estadoCama]="mapaCamasService.getEstadoCama(cama) | async"
                                [relacionesPosibles]="mapaCamasService.getRelacionesPosibles(cama) | async"
                                [permisoIngreso]="permisoIngreso" [permisoBloqueo]="permisoBloqueo"
                                (accionCama)="selectCama(cama, $event)" (click)="verDetalle(cama, selectedCama)"
                                [class.invert]="(cama.estado !== 'ocupada') ? selectedCama.id === cama.id : selectedCama.idInternacion && cama.idInternacion === selectedCama.idInternacion">
                            </tr>
                        </ng-container>
                    </tbody>
                </table>
            </cdk-virtual-scroll-viewport>
        </fieldset>
        <ng-container *ngIf="mainView !== 'mapa-camas'">
            <vista-prestacion [idPrestacion]="mainView.id">
                <plex-button type="danger" size="sm" icon="close" (click)="mapaCamasService.resetView()"></plex-button>
            </vista-prestacion>
        </ng-container>
    </plex-layout-main>
    <plex-layout-sidebar type="invert">
        <app-estado-servicio *ngIf="!accion"></app-estado-servicio>

        <app-ingreso-paciente-workflow *ngIf="accion === 'internarPaciente'" (cancel)="volverADetalle()"
                                       (save)="volverAResumen()">
        </app-ingreso-paciente-workflow>
        <app-desocupar-cama *ngIf="accion === 'desocuparCama'" (accionDesocupar)="accionDesocupar($event)">
            <plex-button title="Volver" icon="arrow-left" type="danger" size="sm" (click)="volverADetalle()">
            </plex-button>
        </app-desocupar-cama>
        <app-cambiar-cama *ngIf="accion === 'cambiarCama'" cambiarUO="{{ cambiarUO }}" (onSave)="volverAResumen()">
            <plex-button title="Volver" icon="arrow-left" type="danger" size="sm" (click)="volverADetalle()">
            </plex-button>
        </app-cambiar-cama>
        <app-egresar-paciente *ngIf="accion === 'egresarPaciente'" (onSave)="volverAResumen()"
                              (cancel)="volverAResumen()">
            <plex-button title="Volver" icon="arrow-left" type="danger" size="sm" (click)="volverADesocupar()">
            </plex-button>
        </app-egresar-paciente>
        <app-cama-destino-generico *ngIf="accion === 'accionGenerica'" [relacion]="estadoRelacion"
                                   (onSave)="volverAResumen()">
            <plex-button title="Volver" icon="arrow-left" type="danger" size="sm" (click)="volverADetalle()">
            </plex-button>
        </app-cama-destino-generico>
        <ng-container *ngIf="(selectedCama$ | async) as selectedCama">
            <app-cama-detalle *ngIf="accion === 'verDetalle'" (cancel)="volverAResumen()"
                              (accionCama)="selectCama(selectedCama, $event)" (refresh)="refresh($event)">
            </app-cama-detalle>
        </ng-container>
        <app-nuevo-registro-salud *ngIf="accion === 'nuevo-registro'">
            <plex-button title="Volver" icon="arrow-left" type="danger" size="sm" (click)="volverADetalle()">
            </plex-button>
        </app-nuevo-registro-salud>
    </plex-layout-sidebar>
</plex-layout>
<form #formEgreso="ngForm">
    <plex-title justify titulo="EGRESO" size="md">
        <plex-button class="mr-1" title="{{ (!prestacionValidada) ? 'Guardar' : 'Prestación validada' }}"
                     tooltipPosition="left" icon="check" type="success" size="sm" [validateForm]="formEgreso"
                     (click)="guardar($event)" [disabled]="inProgress || (checkDisableSave$ | async)">
        </plex-button>
        <ng-content></ng-content>
    </plex-title>

    <plex-wrapper>
        <plex-datetime grow="2" label="Fecha y hora de egreso" [(ngModel)]="fecha" name="fechaEgreso" required
                       [max]="fechaMax || (mapaCamasService.fechaActual$ | async)" [min]="fechaMin"
                       (change)="setFecha()" [debounce]="600" grow="full" (typing)="onType()">
        </plex-datetime>
        <plex-select grow="2" label="Tipo de egreso" [(ngModel)]="registro.valor.InformeEgreso.tipoEgreso"
                     name="InformeEgreso.tipoEgreso" [data]="listaTipoEgreso" placeholder="Seleccione... "
                     [required]="true" grow="full">
        </plex-select>


        <ng-container *ngIf="registro.valor.InformeEgreso.tipoEgreso?.id === 'Traslado'">
            <plex-bool class="pt-2" [(ngModel)]="checkTraslado" type="checkbox" label="Otra organización"
                       name="checkTraslado" (change)="onChangeTraslado($event)">
            </plex-bool>
            <ng-container *ngIf="!checkTraslado">
                <plex-select grow="full" label="Organización destino"
                             [(ngModel)]="registro.valor.InformeEgreso.tipoEgreso.OrganizacionDestino"
                             name="InformeEgreso.OrganizacionDestino" (getData)="loadOrganizacion($event)"
                             placeholder="Seleccione..." [required]="true">
                </plex-select>
            </ng-container>
            <ng-container *ngIf="checkTraslado">
                <plex-text grow="full" label="Organización destino" name="otraOrganizacion"
                           [(ngModel)]="registro.valor.InformeEgreso.tipoEgreso.otraOrganizacion" [required]="true">
                </plex-text>
            </ng-container>
        </ng-container>
    </plex-wrapper>

    <ng-container *ngIf="capa === 'estadistica' || capa === 'estadistica-v2'">
        <ng-container *ngIf="registrosEgresoResumen$ | async as registros">
            <plex-title *ngIf="registros?.length > 1" size="sm" justify titulo="Diagnosticos al egreso"></plex-title>
            <plex-list size="sm" [selectable]="false">
                <ng-container *ngFor="let registro of registros || []">
                    <plex-item>
                        <plex-label [titulo]="registro.concepto.term"></plex-label>
                        <plex-badge *ngIf="registro.esDiagnosticoPrincipal" type="success" ngProjectAs="plex-label">
                            Principal
                        </plex-badge>
                    </plex-item>
                </ng-container>
            </plex-list>
        </ng-container>


        <plex-title justify size="sm" titulo="Datos Estadísticos"></plex-title>

        <plex-wrapper>
            <plex-int grow="1" name="diasEstada" label="Días de estada" suffix="Días"
                      [(ngModel)]="registro.valor.InformeEgreso.diasDeEstada" required readonly>
            </plex-int>


            <plex-select grow="3" label="Diagnóstico Principal al egreso"
                         [(ngModel)]="registro.valor.InformeEgreso.diagnosticos.principal" name="diagnosticoPrincipal"
                         (getData)="codigoCIE10($event, 'diagnostico')" placeholder="Buscar..." labelField="nombre"
                         (change)="showProcedimientos_causas()">
            </plex-select>


            <plex-select grow="full" (change)="showProcedimientos_causas()" label="Otros Diagnósticos"
                         [(ngModel)]="registro.valor.InformeEgreso.otrosDiagnosticos" name="otrosDiagnosticos"
                         (getData)="codigoCIE10($event,'diagnostico')" [multiple]="true" placeholder="buscar..."
                         labelField="nombre">
            </plex-select>

        </plex-wrapper>

        <plex-wrapper>
            <plex-select grow="full" label="Otras circunstancias que prolongan la internación"
                         [(ngModel)]="registro.valor.InformeEgreso.diagnosticos.otrasCircunstancias"
                         name="otrasCircunstancias" (getData)="codigoCIE10($event, 'circunstancia')"
                         placeholder="Buscar...">
            </plex-select>

            <ng-container *ngIf="registro.valor.InformeEgreso.diagnosticos.otrasCircunstancias">
                <plex-int grow="2" name="diasEstadaOtrasCircunstancias" label="Otros días de estada" suffix="Días"
                          [(ngModel)]="registro.valor.InformeEgreso.diagnosticos.diasEstadaOtrasCircunstancias">
                </plex-int>

                <plex-int grow="2" name="diasDePermisoDeSalida" label="Días de permiso de salida" suffix="Días"
                          [(ngModel)]="registro.valor.InformeEgreso.diagnosticos.diasDePermisoDeSalida">
                </plex-int>
            </ng-container>
        </plex-wrapper>

        <ng-container *ngIf="existeCausaExterna">
            <plex-title justify size="sm" titulo="Causa Externa"></plex-title>
            <plex-wrapper>
                <plex-select label="Producido por:" [(ngModel)]="registro.valor.InformeEgreso.causaExterna.producidaPor"
                             name="producidaPor" [data]="causaExterna.producidaPor" labelField="nombre" required>
                </plex-select>


                <plex-select label="Lugar donde ocurrió" [(ngModel)]="registro.valor.InformeEgreso.causaExterna.lugar"
                             name="lugar" [data]="causaExterna.lugar" labelField="nombre" required>
                </plex-select>

                <plex-select label="Cómo se produjo"
                             [(ngModel)]="registro.valor.InformeEgreso.causaExterna.comoSeProdujo" name="comoSeProdujo"
                             (getData)="searchComoSeProdujo($event)" labelField="nombre" required>
                </plex-select>
            </plex-wrapper>
        </ng-container>

        <ng-container *ngIf="procedimientosObstetricos || procedimientosObstetricosNoReq">
            <plex-title justify size="sm" titulo="Eventos Obstetricos"></plex-title>
            <plex-wrapper>
                <plex-datetime name="fechaTerminacion" label="Fecha terminación" type="date"
                               [(ngModel)]="registro.valor.InformeEgreso.terminacionEmbarazo"
                               [required]="procedimientosObstetricos" [debounce]="600">
                </plex-datetime>
                <plex-int name="edadGestacional" label="Edad gestacional"
                          [(ngModel)]="registro.valor.InformeEgreso.edadGestacional" placeholder=""
                          [required]="procedimientosObstetricos"></plex-int>


                <plex-int name="paridad" label="Paridad" [(ngModel)]="registro.valor.InformeEgreso.paridad"
                          placeholder="" [required]="procedimientosObstetricos">
                </plex-int>

                <plex-radio [(ngModel)]="registro.valor.InformeEgreso.tipoParto" label="Tipo de parto" type="horizontal"
                            [data]="opcionesTipoParto" name="opcionTipoParto">
                </plex-radio>

                <ng-container *ngFor="let nacimiento of registro.valor.InformeEgreso.nacimientos; let i = index">
                    <plex-int suffix="g" name="peso-{{i}}" label="Peso al nacer" [(ngModel)]="nacimiento.pesoAlNacer"
                              placeholder=""></plex-int>

                    <plex-radio [(ngModel)]="nacimiento.condicionAlNacer" label="Condición al nacer" type="horizontal"
                                [data]="opcionesCondicionAlNacer" name="opcionCondNacer-{{i}}">
                    </plex-radio>

                    <plex-radio [(ngModel)]="nacimiento.terminacion" label="Terminacion" type="horizontal"
                                [data]="opcionesTerminacion" name="Terminacion-{{i}}">
                    </plex-radio>
                    <plex-radio [(ngModel)]="nacimiento.sexo" label="Sexo" type="horizontal" [data]="opcionesSexo"
                                name="Sexo-{{i}}">
                    </plex-radio>
                    <plex-button *ngIf="i > 0" label="" type="danger btn-sm" icon="close" (click)="removeNacimiento(i)"
                                 [disabled]="prestacionValidada">
                    </plex-button>
                </ng-container>
                <plex-button *ngIf="registro.valor.InformeEgreso.tipoParto == 'Multiple'" label="Agregar"
                             type="primary btn-sm" icon="" [disabled]="prestacionValidada" (click)="addNacimiento()">
                </plex-button>
            </plex-wrapper>
        </ng-container>

        <plex-title justify size="sm" titulo="Procedimientos Quirúrgicos">
            <plex-button type="success" icon="plus" size="sm" tooltip="Nuevo Procedimiento" tooltipPosition="left"
                         [disabled]="prestacionValidada" (click)="addProcedimientoQuirurgico()">
            </plex-button>
        </plex-title>

        <ng-container *ngIf="registro.valor.InformeEgreso.procedimientosQuirurgicos?.length">
            <ng-container
                          *ngFor="let procedimiento of registro.valor.InformeEgreso.procedimientosQuirurgicos; let i = index">
                <plex-grid size="sm" type="full" cols="6">
                    <plex-select label="Procedimiento" [(ngModel)]="procedimiento.procedimiento"
                                 name="procedimiento-{{i}}" (getData)="getListaProcedimientosQuirurgicos($event)"
                                 placeholder="Seleccione..." labelField="nom" span="6">
                    </plex-select>

                    <plex-datetime name="fechaProcedimiento-{{i}}" label="Fecha" type="date"
                                   [(ngModel)]="procedimiento.fecha" [max]="fechaMaxProcedimiento" [debounce]="600"
                                   span="5">
                    </plex-datetime>

                    <plex-button align="end" type="danger" size="md" icon="trash-can"
                                 ariaLabel="Borrar procedimiento quirúrgico" (click)="removeProcedimiento(i)">
                    </plex-button>
                </plex-grid>
            </ng-container>
        </ng-container>
    </ng-container>

</form>
<plex-layout>
    <plex-layout-main>
        <header justify responsive>
            <div class="marca">
                <div svgLogo></div>
                <div svgAcronimo></div>
                <div class="provincia">
                    <div>
                        {{ provincia }}
                    </div>
                </div>
            </div>
            <div class="bienvenida">
                <div class="efector">
                    {{ auth.organizacion.nombre }}
                </div>
                <div class="hola">
                    Hola <b>{{ auth.usuario.nombre }}</b>
                </div>
                <div *ngIf="!denied" class="mensaje">
                    ¿En qué vas a trabajar hoy?
                </div>
                <div *ngIf="denied" class="mensaje">
                    ¡Bienvenida/o a ANDES!
                </div>
            </div>

        </header>
        <hr>
        <main *ngIf="!denied && !loading" responsive cdkDropListGroup>
            <plex-loader *ngIf="loading" type="linear"></plex-loader>

            <!-- MÓDULOS PRINCIPALES -->
            <div class="modulos">
                <!-- MIS MÓDULOS Y SECCIONES -->
                <div class="modulo usuarios">
                    <div class="principal">
                        <b class="titulo" justify="start">
                            <!-- <plex-icon type="warning" size="lg" name="chevron-double-right"></plex-icon> -->
                            <span>Mis Módulos</span>
                            <plex-button *ngIf="!getEditarModulos" type="link" size="md" icon="pencil"
                                         (click)="toggleEditarModulos()" tooltip="Editar 'Mis Módulos'">
                            </plex-button>
                            <plex-button *ngIf="getEditarModulos" type="link" size="md" icon="tilde"
                                         (click)="toggleEditarModulos()" tooltip="Finalizar edición">
                            </plex-button>
                        </b>
                        <div class="descripcion">Acceso rápido a módulos frecuentes</div>
                    </div>
                    <div *ngIf="editarModulos && modulosUsuario?.length === 0" class="sin-modulos-usuario">
                        Podés arrastrar módulos dentro de este recuadro para tener un acceso más rápido a los más
                        frecuentes
                    </div>
                    <div [class.position-absolute]="modulosUsuario?.length === 0"
                         class="submodulos usuario drop d-flex align-items-start" cdkDropList
                         [cdkDropListDisabled]="!getEditarModulos" [cdkDropListData]="modulosUsuario"
                         (cdkDropListDropped)="drop($event)">
                        <ng-container *ngFor="let submodulo of modulosUsuario; let k = index">
                            <span cdkDragBoundary=".plex-box-content">
                                <a cdkDrag href="javascript:void();" *ngIf="submodulo.activo"
                                   class="submodulo {{submodulo.class}} hover" [style.background]="submodulo.color"
                                   (click)="redirect(submodulo)">
                                    <plex-icon [name]="submodulo.icono" size="lg"></plex-icon>
                                    <div class="titulo" [innerHTML]="submodulo.nombre"></div>
                                </a>
                                <plex-icon *ngIf="getEditarModulos" type="light" size="md" name="close"
                                           (click)="removeItem(k)" tooltip="Quitar">
                                </plex-icon>
                            </span>
                            <a href="javascript:void();" class="custom-placeholder seccion" *cdkDragPlaceholder>
                            </a>
                        </ng-container>
                    </div>
                </div>

                <ng-container *ngFor="let modulo of modulos; let i = index">

                    <!-- Módulo principal -->
                    <div *ngIf="modulo.activo" class="modulo">
                        <div class="principal" [style.color]="modulo.color">
                            <b class="titulo">{{ modulo.nombre }}
                                <a href="#" *ngIf="novedades[modulo._id]?.length > 0" hintType="info"
                                   hint="Novedades del módulo {{ modulo.nombre }}" detach="both" hintIcon="bell"
                                   (click)="irANovedades(modulo._id, $event)"></a>
                            </b>
                            <div class="descripcion">{{ modulo.descripcion }}</div>
                        </div>
                        <!-- Permisos en módulo y submódulos -->
                        <div class="submodulos d-flex align-items-start" *ngIf="modulo?.submodulos?.main?.length"
                             cdkDropList [cdkDropListData]="modulos[i].submodulos">
                            <ng-container *ngFor="let submodulo of modulo.submodulos.main">
                                <span cdkDragBoundary=".plex-box-content">
                                    <a cdkDrag href="#" *ngIf="submodulo.activo"
                                       class="submodulo {{submodulo.class}} hover"
                                       [class.mini]="modulo.submodulos.main.length >= 4"
                                       [style.background]="submodulo.color" (click)="redirect(submodulo, $event)">
                                        <plex-icon [name]="submodulo.icono" size="lg"></plex-icon>
                                        <div class="titulo" [innerHTML]="submodulo.nombre"></div>
                                    </a>
                                    <a href="javascript:void();" class="submodulo {{submodulo.class}} hover"
                                       *cdkDragPlaceholder>
                                    </a>
                                </span>
                            </ng-container>
                        </div>
                        <div class="submodulos d-flex align-items-start" *ngIf="modulo?.submodulos?.secondary?.length"
                             cdkDropList [cdkDropListData]="modulos[i].submodulos">
                            <ng-container *ngFor="let submodulo of modulo.submodulos.secondary">
                                <span cdkDragBoundary=".plex-box-content">
                                    <a cdkDrag href="#" *ngIf="submodulo.activo"
                                       class="submodulo {{submodulo.class}} hover"
                                       [class.mini]="modulo.submodulos.main.length >= 4"
                                       [style.background]="submodulo.color" (click)="redirect(submodulo, $event)">
                                        <plex-icon [name]="submodulo.icono" size="lg"></plex-icon>
                                        <div class="titulo" [innerHTML]="submodulo.nombre"></div>
                                    </a>
                                    <a href="javascript:void();" class="submodulo {{submodulo.class}} hover"
                                       *cdkDragPlaceholder>
                                    </a>
                                </span>
                            </ng-container>
                        </div>
                        <!-- Sólo con permisos en submódulos -->
                        <div class="submodulos d-flex align-items-start" *ngIf="!modulo?.submodulos?.length">
                            <a href="#" *ngIf="modulo.activo" class="submodulo hover" [style.background]="modulo.color"
                               (click)="redirect(modulo, $event)">
                                <plex-icon [name]="modulo.icono" size="lg"></plex-icon>
                                <div class="titulo" [innerHTML]="modulo.nombreSubmodulo"></div>
                            </a>

                        </div>
                    </div>
                </ng-container>
                <div class="modulo" cdkDrag>
                    <div class="principal">
                        <b class="titulo">Mis Módulos</b>
                        <div class="descripcion">Acceso rápido a módulos frecuentes</div>
                        <div class="hover" cdkDragHandle>
                            <plex-icon type="default" size="md" name="pan">
                            </plex-icon>
                        </div>
                    </div>
                    <div class="submodulos drop d-flex align-items-start" cdkDropList
                         [cdkDropListDisabled]="!getEditarModulos" [cdkDropListData]="modulos[i].submodulos"
                         (cdkDropListDropped)="dropBack($event)" cdkDropListSortingDisabled>
                        <ng-container *ngFor="let submodulo of modulosUsuario">
                            <span cdkDragBoundary=".plex-box-content">
                                <a cdkDrag href="javascript:void();" *ngIf="submodulo.activo"
                                   class="submodulo {{submodulo.class}} hover" [style.background]="submodulo.color"
                                   (click)="redirect(submodulo)">
                                    <plex-icon [name]="submodulo.icono" size="lg"></plex-icon>
                                    <div class="titulo" [innerHTML]="submodulo.nombre"></div>
                                </a>
                        </ng-container>
                    </div>

                </div>
                </ng-container>


            </div>

            <!-- SECCIONES -->
            <div class="secciones" cdkDropList [cdkDropListData]="secciones" (cdkDropListDropped)="dropBack($event)"
                 cdkDropListSortingDisabled [cdkDropListDisabled]="!getEditarModulos">
                <ng-container *ngFor="let seccion of secciones">
                    <div class="seccion">
                        <div cdkDrag cdkDragDisabled="getEditarModulos" class="principal hover"
                             [style.background]="seccion.color" (click)="redirect(seccion)">
                            <div class="band"></div>
                            <plex-icon class="main" [name]="seccion.icono" type="light" size="lg"></plex-icon>
                            <plex-icon class="animated" name="chevron-right" type="light" size="lg"></plex-icon>
                        </div>
                        <div class="secundario">
                            <div class="titulo ml-2">{{ seccion.nombre }}</div>
                            <div class="subtitulo ml-2">{{ seccion.subtitulo }}</div>
                        </div>
                        <span class="hover" *ngIf="novedades[seccion._id]?.length > 0" hintType="info"
                              hint="Novedades del módulo {{ seccion.nombre }}" detach="both" hintIcon="bell"
                              (click)="irANovedades(seccion._id, $event)"></span>
                    </div>
                </ng-container>
            </div>

        </main>
        <div *ngIf="denied && !loading" class="denegado" justify="center">
            <main role="main" class="inner">
                <plex-label icon="llave" type="warning" size="xl" direction="column"
                            titulo="No tenés permisos para ningún módulo de ANDES"
                            subtitulo="Ponete en contacto con el informático local o coordinador de área">
                </plex-label>
            </main>
        </div>
    </plex-layout-main>
</plex-layout>

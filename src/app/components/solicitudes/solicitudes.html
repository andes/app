<form *ngIf="!showDarTurnos" class="plex-layout" #form="ngForm">
    <section>

        <div class="row">
            <!--Panel de Agendas-->
            <div class="col">
                <plex-box>
                    <header>
                        <div class="clearfix">
                            <div class="page-title float-left">Módulo de Solicitudes</div>
                            <!-- <div class="float-right">
                                <span *ngIf="DT">
                                    <plex-button icon="mdi mdi-calendar-plus" (click)="darTurno()" title="Dar Turno">
                                    </plex-button>
                                </span>
                                <span *ngIf="Auditar">
                                    <plex-button icon="mdi mdi-check" (click)="auditar()" title="Auditar Solicitud">
                                    </plex-button>
                                </span>
                                <span *ngIf="visualizar">
                                    <plex-button icon="mdi mdi-eye" (click)="verTurno()" title="Ver Turno">
                                    </plex-button>
                                </span>
                            </div> -->
                            <!-- <botones-agenda *ngIf="agendasSeleccionadas?.length > 0 && agendas?.length" class="float-right" [agendasSeleccionadas]="agendasSeleccionadas"
                                (clonarEmit)="clonar()" (agregarNotaAgendaEmit)="agregarNotaAgenda()" (agregarSobreturnoEmit)="agregarSobreturno()"
                                (editarAgendaEmit)="editarAgenda($event)" (actualizarEstadoEmit)="actualizarEstadoEmit($event)"
                                (listarTurnosEmit)="listarTurnos($event)" (listarCarpetasEmit)="listarCarpetas($event)" (revisionAgendaEmit)="revisionAgenda($event)"
                                (reasignarTurnosEmit)="reasignarTurnos($event)" [turnosSuspendidos]="turnosSuspendidos">
                            </botones-agenda> -->
                        </div>
                        <div class="row">
                            <div class="col-3">
                                <plex-datetime type="date" [(ngModel)]="fechaDesde" (change)="refreshSelection($event,'fechaDesde')" name="fechaDesde" label="Desde"
                                    class="fechas">
                                </plex-datetime>
                                <!-- <plex-button type="info" icon="chevron-right"></plex-button> -->
                            </div>
                            <div class="col-3">
                                <plex-datetime type="date" [(ngModel)]="fechaHasta" (change)="cargarSolicitudes()" name="fechaHasta" label="Hasta" class="fechas">
                                </plex-datetime>
                            </div>

                        </div>
                    </header>
                    <plex-tabs>
                        <plex-tab label="Solicitudes de Entrada" icon="arrow-down-box">
                            <table class="table table-striped table-sm">
                                <thead>
                                    <th>Fecha</th>
                                    <th>Paciente</th>
                                    <th>Organización (Solicitante)</th>
                                    <th>Profesional (Solicitante)</th>
                                    <th>Tipo de prestación (Solicitada)</th>
                                    <th>Profesional (Solicitado)</th>
                                    <th>Estado</th>
                                    <th>Operaciones</th>
                                </thead>
                                <tbody>
                                    <tr *ngFor="let prestacion of prestaciones; let i=index" class="hover" (click)="seleccionar(i)" [ngClass]="{'bg-inverse text-white': (prestacion.seleccionada===true)}">
                                        <td>{{prestacion.solicitud.fecha | date: 'dd/MM/yyyy'}}</td>
                                        <td>{{prestacion.paciente | paciente}}</td>
                                        <td *ngIf="prestacion.solicitud.organizacionOrigen">{{prestacion.solicitud.organizacionOrigen.nombre}}</td>
                                        <td *ngIf="!prestacion.solicitud.organizacionOrigen"></td>
                                        <td *ngIf="prestacion.solicitud.profesionalOrigen">{{prestacion.solicitud.profesionalOrigen | profesional}}</td>
                                        <td *ngIf="!prestacion.solicitud.profesionalOrigen"></td>
                                        <td>{{prestacion.solicitud.tipoPrestacion.term}}</td>
                                        <td>{{prestacion.solicitud.profesional | profesional}}</td>
                                        <td *ngIf="!prestacion.solicitud.turno" class="text-right estado">{{prestacion.estados[prestacion.estados.length-1].tipo}}</td>
                                        <td *ngIf="prestacion.solicitud.turno" class="text-right estado">turno asignado</td>
                                        <td style="text-align:center">
                                            <span *ngIf="darTurnoArray[i] && prestacion?.paciente">
                                                <button class="btn btn-sm btn-success" (click)="darTurno(prestacion)" title="Dar Turno">
                                                    <span class="mdi mdi-calendar-plus"></span>
                                                </button>
                                            </span>
                                            <span *ngIf="auditarArray[i]">
                                                <button class="btn btn-sm btn-warning" (click)="auditar()" title="Auditar Solicitud">
                                                    <span class="mdi mdi-check"></span>
                                                </button>
                                            </span>
                                            <span *ngIf="visualizar[i]">
                                                <!-- <button class="btn btn-sm btn-info" (click)="verTurno()" title="Ver Turno">
                                                    <span class="mdi mdi-eye"></span>
                                                </button> -->
                                                <span class="badge badge-success">Turno dado</span>
                                            </span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </plex-tab>
                        <plex-tab label="Solicitudes de Salida" icon="arrow-up-box">
                            <plex-button *ngIf="showBotonCargarSolicitud" type="info" label="Cargar Solicitud nueva" (click)="formularioSolicitud()"></plex-button>

                            <form #form="ngForm" *ngIf="showCargarSolicitud">

                                <pacientesSearch *ngIf="showSeleccionarPaciente" [bloquearCreate]="true" [modoCompleto]="false" [hideFooter]="true" (selected)="seleccionarPaciente($event)"></pacientesSearch>

                                <fieldset>
                                    <div class="row" *ngIf="paciente?.id">
                                        <div class="col-12">
                                            <label>Paciente</label> {{ paciente | paciente }}
                                            <span>Documento:
                                                <span *ngIf="paciente.documento !== ''">{{ paciente.documento | number }}</span>
                                                <span *ngIf="paciente.documento === ''" class="text-danger">Sin documento</span>
                                            </span>
                                            <span>Fecha de nacimiento
                                                <span *ngIf="paciente.fechaNacimiento !== null">{{ paciente.fechaNacimiento | date:'dd-MM-yyyy' }} ({{ paciente | edad }})</span>
                                                <span *ngIf="paciente.fechaNacimiento === null">Sin fecha de nacimiento</span>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-12">
                                        </div>
                                    </div>

                                    <!-- Fecha Origen -->
                                    <div class="row">
                                        <div class="col-12">
                                            <plex-datetime type="date" [(ngModel)]="modelo.solicitud.fecha" name="fechaSolicitud" label="Fecha de solicitud" [required]="true"
                                                [required]="true"></plex-datetime>
                                        </div>
                                    </div>

                                    <!-- Profesional Origen -->
                                    <div class="row">
                                        <div class="col-12">
                                            <plex-select [(ngModel)]="modelo.solicitud.profesional" name="profesionalOrigen" (getData)="loadProfesionales($event)" label="Profesional solicitante"
                                                placeholder="Escriba el apellido del Profesional" labelField="apellido + ' ' + nombre"
                                                [required]="true">
                                            </plex-select>
                                        </div>
                                    </div>

                                    <!-- Tipo Prestación -->
                                    <div class="row">
                                        <div class="col-12">
                                            <plex-select [(ngModel)]="modelo.solicitud.tipoPrestacion" name="tipoPrestacion" (getData)="loadTipoPrestaciones($event)"
                                                label="Tipo de Prestación" placeholder="Tipos de Prestación solicitada" [required]="true">
                                            </plex-select>
                                        </div>
                                    </div>

                                    <!-- Autocitado? -->
                                    <div class="row">
                                        <div class="col-12">
                                            <plex-bool [(ngModel)]="registros.solicitudPrestacion.autocitado" label="Autocitado" name="autocitado"></plex-bool>
                                        </div>
                                    </div>

                                    <!-- Organización Destino -->
                                    <div class="row">
                                        <div class="col-12">
                                            <plex-select [(ngModel)]="organizacionDestino" name="organizacionDestino" (getData)="loadOrganizacion($event)" label="Organización destino"
                                                placeholder="Seleccione la organización" labelField="nombre" [required]="true">
                                            </plex-select>
                                        </div>
                                    </div>

                                    <!-- Profesional Destino -->
                                    <div class="row" *ngIf="!registros.solicitudPrestacion.autocitado">
                                        <div class="col-12">
                                            <plex-select [(ngModel)]="profesionalDestino" label="Profesional destino" name="profesional" (getData)="loadProfesionales($event)"
                                                placeholder="Escriba el apellido de un Profesional" labelField="apellido + ' ' + nombre">
                                            </plex-select>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-12">
                                            <!-- <plex-text [(ngModel)]="registros" label="Notas / Diagnóstico / Motivo" name="registros" multiline="true"></plex-text> -->
                                            <label for="registros">Notas / Diagnóstico / Motivo</label>
                                            <textarea class="form-control" [(ngModel)]="registros.solicitudPrestacion.motivo" name="motivo" id="registros" rows="5"></textarea>
                                        </div>
                                    </div>
                                    <div class="mt-3 float-right">
                                        <plex-button type="danger" label="Cancelar" (click)="cancelar()">
                                        </plex-button>
                                        <plex-button type="success" label="Guardar" (click)="guardarSolicitud($event);" title="Guardar Solicitud" validateForm="true">
                                        </plex-button>
                                    </div>
                                </fieldset>
                            </form>

                            <table class="table table-striped table-sm">
                                <thead>
                                    <th>Fecha</th>
                                    <th>Paciente</th>
                                    <th>Organización (Solicitante)</th>
                                    <th>Profesional (Solicitante)</th>
                                    <th>Tipo de prestación (Solicitada)</th>
                                    <th>Profesional (Solicitado)</th>
                                    <th>Estado</th>
                                    <th>Turno</th>
                                </thead>
                                <tbody>
                                    <tr *ngFor="let prestacion of prestaciones; let i=index" class="hover" (click)="seleccionar(i)" [ngClass]="{'bg-inverse text-white': (prestacion.seleccionada===true)}">
                                        <td>{{prestacion.solicitud.fecha | date: 'dd/MM/yyyy'}}</td>
                                        <td>{{prestacion.paciente | paciente}}</td>
                                        <td *ngIf="prestacion.solicitud.organizacionOrigen">{{prestacion.solicitud.organizacionOrigen.nombre}}</td>
                                        <td *ngIf="!prestacion.solicitud.organizacionOrigen"></td>
                                        <td *ngIf="prestacion.solicitud.profesionalOrigen">{{prestacion.solicitud.profesionalOrigen | profesional}}</td>
                                        <td *ngIf="!prestacion.solicitud.profesionalOrigen"></td>
                                        <td>{{prestacion.solicitud.tipoPrestacion.term}}</td>
                                        <td>{{prestacion.solicitud.profesional | profesional}}</td>
                                        <td *ngIf="!prestacion.solicitud.turno" class="text-right estado">{{prestacion.estados[prestacion.estados.length-1].tipo}}</td>
                                        <td *ngIf="prestacion.solicitud.turno" class="text-right estado">turno asignado</td>
                                        <td style="text-align:center">
                                            <span *ngIf="darTurnoArray[i] && prestacion?.paciente">
                                                <!-- <button class="btn btn-sm btn-success" (click)="darTurno(prestacion)" title="Dar Turno">
                                                            <span class="mdi mdi-calendar-plus"></span>
                                                        </button> -->
                                                <span class="badge badge-warning">Turno pendiente</span>
                                            </span>
                                            <span *ngIf="auditarArray[i]">
                                                <!-- <button class="btn btn-sm btn-warning" (click)="auditar()" title="Auditar Solicitud">
                                                            <span class="mdi mdi-check"></span>
                                                        </button> -->
                                                <span class="badge badge-danger">Auditoría pendiente</span>
                                            </span>
                                            <span *ngIf="visualizar[i]">
                                                <!-- <button class="btn btn-sm btn-info" (click)="verTurno()" title="Ver Turno">
                                                            <span class="mdi mdi-eye"></span>
                                                        </button> -->
                                                <span class="badge badge-success">Turno ya dado</span>
                                            </span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </plex-tab>
                    </plex-tabs>
                </plex-box>
            </div>
            <div *ngIf="solicitudSelccionada" class="col-3">
                <plex-box>
                    <header>
                        <div class="clearfix">
                            <div *ngIf="turnoSeleccionado" class="page-title float-left">Datos del Turno</div>
                            <div class="float-right">
                                <button class="btn btn-sm btn-danger" (click)="solicitudSelccionada = null">
                                    <i class="mdi mdi-close"></i>
                                </button>
                            </div>
                        </div>
                    </header>

                    <div class="container-fluid">
                        <div class="row">
                            <div class="col">
                            </div>
                        </div>
                        <div *ngIf="turnoSeleccionado" class="row">
                            <div class="col">
                                <b>Fecha:</b>
                                {{ turnoSeleccionado.bloques[0].turnos[0].horaInicio | fecha }}
                                <br>
                                <b>Organización:</b>
                                {{ turnoSeleccionado.organizacion.nombre }}
                                <br>
                                <b>Profesional(es):</b>
                                {{ turnoSeleccionado.profesionales | enumerar:['apellido', 'nombre'] }}
                                <br>
                                <b>Tipo de Prestación:</b>
                                {{ turnoSeleccionado.bloques[0].turnos[0].tipoPrestacion.term }}
                            </div>
                        </div>
                    </div>
                </plex-box>
            </div>
        </div>
    </section>
</form>

<!-- Calendario para dar turnos -->
<dar-turnos *ngIf="showDarTurnos && solicitudTurno" (cancelarDarTurno)="volverDarTurno($event)" (volverValidacion)="volverDarTurno($event)"
    [opcionesVolver]="{ label: labelVolver, componente: 'solicitudes'}" [pacienteSeleccionado]="pacienteSeleccionado" [solicitudPrestacion]="solicitudTurno"></dar-turnos>

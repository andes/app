<plex-layout main="{{ showPrestacion  ? '6' : '12'}}">
    <plex-layout-main>
        <header>
            <!--Botones / Acciones-->
            <div class="clearfix">
                <div class="page-title float-left">Buscador de turnos y prestaciones</div>
            </div>

            <!--Filtros-->
            <div class="row">
                <div class='col-3'>
                    <plex-datetime type="date" [(ngModel)]="fechaDesde" (change)="refreshSelection($event,'fechaDesde')"
                        name="fechaDesde" label="Desde" class="fechas" [max]="fechaHasta">
                    </plex-datetime>
                    <!-- <plex-button type="info" icon="chevron-right"></plex-button> -->
                </div>
                <div class='col-3'>
                    <plex-datetime type="date" [(ngModel)]="fechaHasta" (change)="refreshSelection($event,'fechaHasta')"
                        name="fechaHasta" label="Hasta" class="fechas" [min]="fechaDesde">
                    </plex-datetime>
                </div>
                <div class='col-3'>
                    <plex-select [(ngModel)]="prestaciones" (change)="refreshSelection($event,'prestaciones')"
                        (getData)="loadPrestaciones($event)" name="prestaciones" label="Prestación"
                        ngModelOptions="{standalone: true}">
                    </plex-select>
                </div>
                <div class='col-2'>
                    <plex-button type="success" icon="calendar-search" label="Buscar"
                        (click)="refreshSelection($event, 'filter')"></plex-button>
                </div>
                <div class='col-1 text-right'>
                    <plex-button type="default" [icon]="mostrarMasOpciones ? 'chevron-up' : 'chevron-down'"
                        (click)="mostrarMasOpciones = !mostrarMasOpciones" name="mostrar"></plex-button>
                </div>
            </div>
            <div class="row" *ngIf="mostrarMasOpciones">
                <div class="col-4">
                    <plex-select [(ngModel)]="profesionales" (change)="refreshSelection($event, 'profesionales')"
                        (getData)="loadEquipoSalud($event)" name="profesionales" label="Equipo de salud"
                        placeholder="Buscar por equipo de salud" labelField="apellido+' '+nombre"
                        ngModelOptions="{standalone: true}">
                    </plex-select>
                </div>
                <div class="col-3">
                    <plex-select [(ngModel)]="estado" (change)="refreshSelection($event,'estado')" name="estado"
                        [data]="arrayEstados" label="Estado" placeholder="Buscar por estado"
                        ngModelOptions="{standalone: true}">
                    </plex-select>
                </div>
                <div *ngIf="!sumar && !sinOS" class="col-3">
                    <plex-select [(ngModel)]="financiadores" (change)="refreshSelection($event,'financiador')"
                        name="financiador" (getData)="loadFinanciadores($event)" label="Financiador"
                        placeholder="Buscar por financiador">
                    </plex-select>

                </div>
                <div class="col-2">
                    <plex-bool *ngIf="!sinOS" [(ngModel)]="sumar" type="slide"
                        (change)="refreshSelection($event, 'sumar')" label="Sumar" name="sumar"></plex-bool>
                    <plex-bool *ngIf="!sumar" [(ngModel)]="sinOS" type="slide"
                        (change)="refreshSelection($event, 'sinOS')" label="Sin obra social" name="sinOS"></plex-bool>
                </div>
            </div>
        </header>
        <!-- Resultados -->
        <plex-loader *ngIf="loading"></plex-loader>
        <table *ngIf="busquedas?.length && !loading" class="table table-striped table-sm">
            <thead>
                <th>Fecha</th>
                <th>Paciente</th>
                <th>Financiador</th>
                <th>Tipo de Prestación</th>
                <th>Equipo de Salud</th>
                <th>Estado</th>
            </thead>
            <tbody>
                <tr *ngFor="let busqueda of busquedas; let i=index" class="hover" (click)="mostrarPrestacion(busqueda)"
                    [ngClass]="{'bg-inverse text-white': busqueda.seleccionada}">
                    <td>{{busqueda.fecha | date: "dd/MM/yyyy HH:mm " }}</td>
                    <td>{{busqueda.paciente | paciente}}</td>
                    <td>{{busqueda.financiador ? busqueda.financiador.financiador : 'No posee'}}</td>
                    <td>{{busqueda.prestacion?.term}}</td>
                    <div class="nombres-profesionales">
                        <span *ngIf="busqueda.profesionales?.length == 0" class="text-danger">Profesional
                            no asignado</span>
                        <ng-container *ngIf="busqueda.profesionales">
                            <div *ngIf="busqueda.profesionales.length > 0">{{ busqueda.profesionales |
                                enumerar:['apellido','nombre'] }}</div>
                        </ng-container>
                    </div>
                    <td>{{busqueda.estado}}</td>
                </tr>
            </tbody>
        </table>
    </plex-layout-main>
    <!-- Prestacion -->
    <plex-layout-sidebar *ngIf="showPrestacion">
        <header>
            <div class="clearfix">
                <div class="page-title float-left">Detalle de la prestación</div>
            </div>
        </header>
        <div class="clearfix">
            <div class="page-subtitle float-left">Paciente</div>
        </div>
        <div class="col">
            <div class="full-col" *ngIf="prestacion.paciente.apellido">
                <label class="block">Apellido y nombre</label>
                <span>{{prestacion.paciente | paciente}}</span>
            </div>

            <div *ngIf="prestacion.paciente.documento !== ''">
                <label class="block">Documento</label>
                <span>{{ prestacion.paciente.documento | number }}</span>
            </div>

            <div *ngIf="prestacion.paciente.estado">
                <label class="block">Estado</label>
                <span *ngIf="prestacion.paciente.estado === 'validado'" class="badge badge-success">
                    {{ prestacion.paciente.estado | uppercase }}
                </span>
                <span *ngIf="_paciente.estado !== 'validado'" class="badge-warning">
                    {{ prestacion.paciente.estado | uppercase }}
                </span>
            </div>

            <div *ngIf="prestacion.paciente.documento === ''">
                <label class="block">Documento</label>
                <span class="text-danger">Sin documento</span>
            </div>
            <div *ngIf="prestacion.paciente.fechaNacimiento !== null">
                <label>Fecha de Nacimiento</label>
                <span>{{ prestacion.paciente.fechaNacimiento | date: "dd/MM/yyyy " }}</span>
            </div>
            <div *ngIf="prestacion.paciente.fechaNacimiento === null">
                <label>Fecha de Nacimiento</label>
                <span class="text-danger">Sin fecha de nacimiento</span>
            </div>
            <div>
                <label>Edad</label>
                <span>{{ prestacion.paciente | edad }}</span>
            </div>
            <div class="full-col" *ngIf="prestacion.paciente.sexo">
                <label>Sexo / Género</label>
                <span>{{ prestacion.paciente | sexo }}</span>
            </div>
            <div class="full-col" *ngIf="prestacion.paciente.cuil">
                <div>
                    <label>Cuil</label>
                    <span>{{ prestacion.paciente.cuil }}</span>
                </div>
                <div>
                    <label>Obra Social</label>
                    <span *ngIf="obraSocial">{{ prestacion.paciente.obraSocial.financiador }}</span>
                    <span *ngIf="!obraSocial">Sin obra social</span>
                </div>
            </div>
        </div>
        <div class="clearfix">
            <div class="page-subtitle float-left">Detalle de la prestación</div>
        </div>
        <div *ngIf="!prestacion.idPrestacion" class="col">
            <span class="text-danger">La prestación no ha sido iniciada</span>
        </div>

        <div *ngIf="prestacion.idPrestacion" class="col">
            <div *ngIf="prestacion.prestacion">
                <label>Tipo de prestación</label>{{prestacion.prestacion?.term}}</div>
            <div *ngIf="prestacion.profesionales">
                <label>Profesional</label>
                <div *ngFor="let profesional of prestacion.profesionales let i = index">{{profesional |
                    profesional}}
                </div>
            </div>
            <div>
                <label>Fecha de la prestación</label>
                <span>{{ prestacion.fecha | fecha }}</span>
            </div>
            <div>
                <label>Estado</label>
                <span>{{ prestacion.estado }}</span>
            </div>
            <div *ngIf="prestacion.financiador?.financiador">
                <label>Obra social</label>
                <span>{{prestacion.financiador.financiador}}</span>
            </div>
            <div *ngIf="!prestacion.financiador">
                <label>Obra social</label>
                <span>No posee</span>
            </div>
            <div *ngIf="prestacion.prestacion.term">
                <label>Prestación</label>
                <span>{{prestacion.prestacion.term}}</span>
            </div>
        </div>
        <div *ngIf="prestacion.idPrestacion">
            <rup-vistaPrestacion [idPrestacion]="prestacion.idPrestacion"></rup-vistaPrestacion>
        </div>

        <br>
        <plex-button label="Cerrar" type="info" (click)="onClose()"></plex-button>

    </plex-layout-sidebar>
</plex-layout>
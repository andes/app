<plex-layout main="8">
    <plex-layout-main>
        <plex-title main titulo="NUEVA SOLICITUD DE {{tipoSolicitud.toUpperCase()}}">
            <plex-button class="float-left mr-1" position="left" type="danger" label="Cancelar" (click)="cancelar()">
            </plex-button>
            <plex-button position="right" class="float-right mr-1" type="success" label="Guardar"
                         (click)="guardarSolicitud($event)" [validateForm]="form"> </plex-button>
        </plex-title>
        <ng-container *ngIf="showSeleccionarPaciente">
            <label *ngIf="showSeleccionarPaciente">Paciente</label>

            <!-- ----------- Búsqueda de pacientes -------------- -->

            <paciente-buscar (searchStart)="searchStart()" (searchClear)="onSearchClear()"
                             (searchEnd)="searchEnd($event)" (selected)="seleccionarPaciente($event)">
            </paciente-buscar>
            <!-- <plex-loader *ngIf="loading"></plex-loader> -->
            <!-- <paciente-listado *ngIf="resultadoBusqueda && resultadoBusqueda.length" [pacientes]="resultadoBusqueda"
                              [autoselect]="false" (selected)="seleccionarPaciente($event)"
                              (scrolled)="toPacienteBuscarOnScroll()">
            </paciente-listado>
            <div *ngIf="resultadoBusqueda && !resultadoBusqueda.length" class="alert alert-default">
                ¡No se encontró ningún paciente!
            </div> -->
        </ng-container>

        <form #form="ngForm">
            <!-- SOLICITUD ENTRADA -->
            <ng-container *ngIf="!showSeleccionarPaciente && tipoSolicitud == 'entrada'">
                <plex-wrapper>
                    <plex-datetime [plexWizard]="0" type="date" [(ngModel)]="modelo.solicitud.fecha"
                                   name="fechaSolicitud" label="Fecha de solicitud" [required]="true">
                    </plex-datetime>
                    <plex-select [(ngModel)]="modelo.solicitud.tipoPrestacion" name="tipoPrestacionDestino"
                                 (getData)="loadTipoPrestaciones($event)" label="Tipo de Prestación Solicitada"
                                 placeholder="Tipos de Prestación solicitada" [required]="true"
                                 (change)="onSelectPrestacionOrigen()">
                    </plex-select>
                    <plex-select [plexWizard]="0" *ngIf="!autocitado" [(ngModel)]="modelo.solicitud.organizacionOrigen"
                                 name="organizacionOrigen" [data]="dataOrganizacionesOrigen" label="Organización origen"
                                 placeholder="Seleccione la organización" labelField="nombre"
                                 (change)="onSelectOrganizacionOrigen(); checkProfesional()" [required]="true">
                    </plex-select>
                </plex-wrapper>
                <plex-grid type="full" cols="4">
                    <plex-bool [(ngModel)]="autocitado" label="Autocitado" grow="1" name="autocitado">
                    </plex-bool>
                </plex-grid>
                <plex-grid type="full" cols="2">
                    <plex-wrapper>
                        <plex-select *ngIf="!autocitado" [(ngModel)]="prestacionOrigen"
                                     [data]="dataTipoPrestacionesOrigen" name="tipoPrestacion" (change)="onSelect()"
                                     label="Tipos de Prestación Origen" placeholder="Tipos de Prestación Origen"
                                     [required]="true" grow="full">
                        </plex-select>
                        <plex-select [(ngModel)]="modelo.solicitud.profesionalOrigen" name="profesionalOrigen"
                                     (getData)="loadProfesionales($event)" label="Profesional solicitante"
                                     placeholder="Escriba el apellido del Profesional"
                                     labelField="apellido + ' ' + nombre" [required]="true"
                                     (change)="checkProfesional()" grow="full">
                        </plex-select>
                        <plex-select *ngIf="!autocitado" [(ngModel)]="modelo.solicitud.profesional"
                                     label="Profesional destino" name="profesional"
                                     (getData)="loadProfesionales($event)" (change)="checkProfesional()"
                                     placeholder="Escriba el apellido de un Profesional"
                                     labelField="apellido + ' ' + nombre" grow="full">
                        </plex-select>
                    </plex-wrapper>
                    <plex-wrapper>
                        <plex-text [(ngModel)]="motivo" label="Notas / Diagnóstico / Motivo" name="motivo"
                                   [required]="true" multiline="true"></plex-text>
                    </plex-wrapper>
                </plex-grid>
            </ng-container>
            <!-- /SOLICITUD ENTRADA -->
            <!-- SOLICITUD SALIDA -->
            <ng-container *ngIf="!showSeleccionarPaciente && tipoSolicitud == 'salida'">
                <plex-wrapper>
                    <plex-datetime [plexWizard]="0" type="date" [(ngModel)]="modelo.solicitud.fecha"
                                   name="fechaSolicitud" label="Fecha de solicitud" [required]="true">
                    </plex-datetime>
                    <plex-select [plexWizard]="0" [(ngModel)]="modelo.solicitud.tipoPrestacionOrigen"
                                 name="tipoPrestacionOrigen" (change)="onSelect()"
                                 (getData)="loadTipoPrestaciones($event)" label="Tipos de Prestación Origen"
                                 placeholder="Tipos de Prestación Origen" [required]="true">
                    </plex-select>
                    <plex-select [plexWizard]="0" *ngIf="!autocitado" [(ngModel)]="modelo.solicitud.organizacion"
                                 name="organizacionDestino" label="Organización destino"
                                 placeholder="Seleccione la organización" labelField="nombre"
                                 [data]="dataOrganizacionesDestino" [required]="true"
                                 (change)="onSelectOrganizacionDestino()">
                    </plex-select>
                </plex-wrapper>
                <plex-grid type="full" cols="2">
                    <plex-wrapper>
                        <plex-select [(ngModel)]="modelo.solicitud.profesionalOrigen" name="profesionalOrigen"
                                     (getData)="loadProfesionales($event)" label="Profesional solicitante"
                                     placeholder="Escriba el apellido del Profesional"
                                     labelField="apellido + ' ' + nombre" [required]="true" grow="full">
                        </plex-select>
                        <plex-select [(ngModel)]="prestacionDestino" name="tipoPrestacionDestino"
                                     [data]="dataReglasDestino" label="Tipo de Prestación Solicitada"
                                     placeholder="Tipos de Prestación solicitada" [required]="true"
                                     (change)="onSelectPrestacionDestino()" grow="full">
                        </plex-select>
                        <plex-select *ngIf="!autocitado" [(ngModel)]="modelo.solicitud.profesional"
                                     label="Profesional destino" name="profesional"
                                     (getData)="loadProfesionales($event)"
                                     placeholder="Escriba el apellido de un Profesional"
                                     labelField="apellido + ' ' + nombre" grow="full">
                        </plex-select>
                    </plex-wrapper>
                    <plex-wrapper>
                        <plex-text [(ngModel)]="motivo" label="Notas / Diagnóstico / Motivo" name="motivo"
                                   [required]="true" multiline="true"></plex-text>
                    </plex-wrapper>
                </plex-grid>
            </ng-container>
            <!-- /SOLICITUD SALIDA -->
            <!-- Adjuntar Archivos -->
            <plex-title titulo="Cargar documentos" *ngIf="!showSeleccionarPaciente">
                <input type="file" (change)="changeListener($event)" style="display:none;" #upload>
                <plex-button *ngIf="!waiting" type="primary" size="sm" label="Desde mi PC" (click)="upload.click()">
                </plex-button>
            </plex-title>
            <plex-wrapper *ngIf="!showSeleccionarPaciente">
                <span *ngIf="!waiting">
                    <span *ngIf="errorExt">
                        <plex-badge type="danger"> Archivo inválido </plex-badge>
                    </span>
                </span>
                <span *ngIf="waiting">
                    <plex-loader class="app-waiting" type="ball-pulse-sync"></plex-loader>
                    <plex-button type="danger" class="btn-sm" label="Cancelar" (click)="cancelarAdjunto()">
                    </plex-button>
                </span>
                <div class="image-container hr-inline-group" *ngIf="fotos && fileToken">
                    <ng-container *ngFor="let doc of fotos; let i = index">
                        <plex-visualizador [files]="documentosUrl" #visualizador></plex-visualizador>
                        <div class="image hover">
                            <img [src]="createUrl(doc)" alt="" *ngIf="esImagen(doc.ext)" (click)="visualizador.open(i)">
                            <a [href]="createUrl(doc)" target="_blank" *ngIf="!esImagen(doc.ext)" class="adjunto"
                               (click)="visualizador.open(i)">
                                {{ doc.ext }}
                            </a>
                            <div class="x-mark" (click)="imageRemoved(doc)">
                                <span class="close"></span>
                            </div>
                        </div>
                    </ng-container>
                </div>
            </plex-wrapper>
            <!-- /Adjuntar Archivos -->
        </form>
    </plex-layout-main>
    <plex-layout-sidebar type="invert">
        <plex-title titulo="Detalle del paciente"></plex-title>
        <paciente-detalle *ngIf="!showSeleccionarPaciente" [paciente]="paciente"></paciente-detalle>
    </plex-layout-sidebar>
</plex-layout>
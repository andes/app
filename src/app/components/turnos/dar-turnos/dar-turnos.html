<plex-layout main="8">
    <plex-layout-main>
        <ng-container>
            <plex-title titulo="Calendario de Agendas" size="sm">
                <plex-bool *ngIf="mostrarCalendario" [(ngModel)]="mostrarNoDisponibles" type="slide"
                           name="mostrarNoDisponibles" label="Agendas sin turnos"
                           title="{{mostrarNoDisponibles ? 'Ocultar agendas sin turnos' : 'Mostrar agendas sin turnos'}}"
                           (change)="actualizar()"></plex-bool>
                <plex-bool *ngIf="mostrarCalendario" class="ml-2" [(ngModel)]="mostrarFinesDeSemana" type="slide"
                           name="mostrarFinesDeSemana" label="Sábados y domingos"
                           title="{{mostrarFinesDeSemana ? 'Mostrar sábados y domingos' : 'Ocultar sábados y domingos'}}"
                           (change)="actualizar()">
                </plex-bool>

                <plex-button class="mx-2" type="info" size="sm" icon="chevron-left" (click)="cambiarMes('-')">
                </plex-button>
                <span class="text-120">{{ opciones.fecha | date: "MMM yyyy" | uppercase }}</span>
                <plex-button class="ml-2" size="sm" type="info" icon="chevron-right" (click)="cambiarMes('+')">
                </plex-button>
                <plex-button label="Cancelar" size="sm" class="ml-2" type="danger" icon="danger"
                             (click)="noSeAsignaTurno()">
                </plex-button>
            </plex-title>

            <plex-grid size="lg" type="full">
                <plex-wrapper>
                    <plex-select *ngIf="!_solicitudPrestacion?.solicitud && !tipoPrestacionesPermitidas"
                                 [(ngModel)]="opciones.tipoPrestacion" (getData)="loadTipoPrestaciones($event)"
                                 label="Tipos de Prestación" (change)="filtrar()" name="tipoPrestacion">
                    </plex-select>
                    <plex-select *ngIf="_solicitudPrestacion?.solicitud?.tipoPrestacion && !tipoPrestacionesPermitidas"
                                 [(ngModel)]="_solicitudPrestacion.solicitud.tipoPrestacion"
                                 (getData)="loadTipoPrestaciones($event)" label="Tipos de Prestación"
                                 (change)="filtrar()" name="tipoPrestacion" [readonly]="true">
                    </plex-select>

                    <plex-select *ngIf="tipoPrestacionesPermitidas" [(ngModel)]="opciones.tipoPrestacion"
                                 [data]="tipoPrestacionesPermitidas" label="Tipos de Prestación" (change)="filtrar()"
                                 name="tipoPrestacion">
                    </plex-select>

                    <plex-select *ngIf="!_solicitudPrestacion?.solicitud" [(ngModel)]="opciones.profesional"
                                 (getData)="loadProfesionales($event)" label="Equipo de Salud"
                                 labelField="apellido + ' ' + nombre" (change)="filtrar()" name="profesional">
                    </plex-select>
                    <plex-select *ngIf="_solicitudPrestacion?.solicitud?.profesional && autocitado" label="Profesional"
                                 [(ngModel)]="_solicitudPrestacion.solicitud.profesional"
                                 (getData)="loadProfesionales($event)" labelField="apellido + ' ' + nombre"
                                 (change)="filtrar()" name="profesional">
                    </plex-select>
                    <plex-select *ngIf="(_solicitudPrestacion?.solicitud && !autocitado) " label="Profesional"
                                 [(ngModel)]="opciones.profesional" (getData)="loadProfesionales($event)"
                                 labelField="apellido + ' ' + nombre" (change)="filtrar()" name="profesional">
                    </plex-select>
                </plex-wrapper>
            </plex-grid>
            <div *ngIf="!mostrarCalendario">
                Por favor elija una prestación para mostrar las agendas disponibles
            </div>
            <!--Calendario-->
            <app-calendario *ngIf="mostrarCalendario" [agendas]="agendas" [fecha]="opciones.fecha" [agenda]="agenda"
                            [estado]="estadoT" [opcionesCalendario]="!mostrarFinesDeSemana"
                            [mostrarNoDisponibles]="mostrarNoDisponibles" [_solicitudPrestacion]="_solicitudPrestacion"
                            [filtroPrestacion]="opciones.tipoPrestacion" [tipoTurno]="tipoTurno"
                            (agendaChanged)="seleccionarAgenda($event)"></app-calendario>
        </ng-container>
    </plex-layout-main>
    <plex-layout-sidebar type="invert">
        <plex-title *ngIf="estadoT === 'noSeleccionada' && !_solicitudPrestacion?.solicitud"
                    titulo="Búsquedas recientes" size="sm"></plex-title>
        <plex-list *ngIf="estadoT === 'noSeleccionada' && !_solicitudPrestacion?.solicitud" [selectable]="true">
            <plex-item *ngFor="let busqueda of busquedas; let i = index" (click)="seleccionarBusqueda(i)">
                <plex-label *ngIf="busqueda.tipoPrestacion" titulo="{{busqueda.tipoPrestacion.term}}">
                </plex-label>
                <plex-label *ngIf="busqueda.profesional" titulo="{{busqueda.profesional | nombre}}">
                </plex-label>
            </plex-item>
        </plex-list>
        <ng-container *ngIf="estadoT === 'seleccionada' || estadoT === 'noTurnos' || estadoT === 'dinamica'">
            <plex-title titulo="Dar turno" size="sm"></plex-title>
            <!--Header agenda-->
            <div class="pt-3 text-center">
                <div>Agenda seleccionada
                    <plex-icon *ngIf="agenda.link" tooltip="Agenda Virtual" name="monitor"></plex-icon>
                </div>
                <!-- Botones para ver más agendas -->
                <plex-button *ngIf="agendasDelDia && agendasDelDia[indice-1]" type="info" size="sm" icon="chevron-left"
                             class="text-lg" title="Agenda anterior" (click)="verAgenda('izq')"></plex-button>
                <span class="mx-2">{{ agenda.horaInicio | date: 'EEE d MMM' }}
                    <plex-badge type="{{ estadosAgenda[agenda.estado].class }}">
                        {{ estadosAgenda[agenda.estado].nombre }}</plex-badge>
                    <plex-button *ngIf="puedeDarSobreturno" class="ml-1" ariaLabel="agregar sobreturno" type="success"
                                 size="sm" icon="account-plus" (click)="agregarSobreturno()" title="Agregar Sobreturno">
                    </plex-button>
                </span>
                <span class="mx-2" *ngIf="estadoT==='dinamica'">
                    {{agenda.horaInicio | date: 'HH:mm'}} a {{agenda.horaFin | date: 'HH:mm'}} hs
                </span>
                <plex-button *ngIf="agendasDelDia && agendasDelDia[indice+1]" type="info" size="sm" icon="chevron-right"
                             class="text-lg" title="Agenda siguiente" (click)="verAgenda('der')"></plex-button>
                <!-- Listado de prestaciones -->
                <div *ngIf="agenda && agenda.tipoPrestaciones">
                    <div *ngFor="let tipoPrestacion of agenda.tipoPrestaciones">
                        {{ tipoPrestacion.term }}
                    </div>
                </div>
                <div *ngIf="agenda && agenda.profesionales">
                    <!-- Listado de Equipo de Salud -->
                    <div *ngFor="let profesional of agenda.profesionales let i = index">
                        {{profesional | nombre}}
                    </div>
                </div>
                <div *ngIf="agenda | espacioFisico" class='text-capitalize'>
                    {{ agenda | espacioFisico }}
                </div>
            </div>

            <!--Paciente detalle -->
            <paciente-detalle [paciente]="paciente" orientacion="horizontal" size="xs" [fields]="pacienteFields">
            </paciente-detalle>

            <!--Información Adicional -->
            <plex-title titulo="Información Adicional" size="sm"></plex-title>
            <plex-grid type="auto" size="md" cols="{{desplegarOS && obraSocialPaciente?3:1}}">
                <plex-select *ngIf="desplegarOS" span="2" label="Obra Social" [(ngModel)]="obraSocialPaciente"
                             name="obraSocialPaciente" (getData)="loadObrasSociales($event)" labelField="financiador">
                </plex-select>
                <plex-text *ngIf="desplegarOS && obraSocialPaciente" label="Número de Afiliado"
                           name="obraSocialPaciente.numeroAfiliado" [(ngModel)]="obraSocialPaciente.numeroAfiliado">
                </plex-text>
            </plex-grid>
            <plex-text label="Motivo de consulta / Diagnóstico" name="motivoConsulta" [(ngModel)]="motivoConsulta">
            </plex-text>
            <plex-grid type="auto" size="md" cols="2">
                <plex-phone label="Celular" [(ngModel)]="telefono" (change)="cambiarTelefono()" name="telefono">
                </plex-phone>
                <plex-text *ngIf="carpetaEfector" (change)="cambiarCarpeta()" label="Nro Carpeta" name="nroCarpeta"
                           [(ngModel)]="carpetaEfector.nroCarpeta"></plex-text>
            </plex-grid>
            <plex-select *ngIf="bloque && (!turno.tipoPrestacion || (dinamica && bloque.tipoPrestaciones.length > 1))"
                         label="Tipo de prestación" [(ngModel)]="turnoTipoPrestacion" [data]="bloque.tipoPrestaciones"
                         name="turnoTipoPrestacion"></plex-select>
            <plex-text label="Nota" name="nota" [(ngModel)]="nota" (change)="verificarNota()">
            </plex-text>
            <plex-text *ngIf="agenda.link" tooltip="Puede cambiar link de turno virtual" label="Link" name="link"
                       [(ngModel)]="link"></plex-text>

            <!-- Dependiendo el estado, se visualiza el plex-title aducuado -->
            <plex-title titulo="{{estadoT==='dinamica'?'Agenda dinámica':estadoT==='noTurnos'?'Agendas alternativas':'Selección horario'}}"
                        size="sm">
                <plex-bool *ngIf="estadoT !== 'noTurnos'" class="mr-2" label="Turno doble" [(ngModel)]='turnoDoble'
                           name="turnoDoble">
                </plex-bool>
                <plex-bool *ngIf="agenda.nominalizada && estadoT !== 'noTurnos'" label="Turno telefónico"
                           [(ngModel)]='turnoTelefonico' name="turnoTelefonico">
                </plex-bool>
            </plex-title>

            <!-- Agenda con turnos disponibles -->
            <ng-container *ngIf="estadoT === 'seleccionada'">
                <!--Lista de turnos, bloque por bloque-->
                <div *ngFor="let bloque of bloques">
                    <plex-label *ngIf="bloque.descripcion" titulo="Descripción: {{bloque.descripcion}}">
                    </plex-label>
                    <plex-grid *ngIf="tieneTurnos(bloque)" type="full" size="sm">
                        <plex-card type="dark" mode="filled" *ngFor="let turno of bloque.turnos; let i=index"
                                   selectable="true" [selected]="isActive(turno)" (click)="seleccionarTurno(bloque,i)"
                                   [ngClass]="{'disabled' : turno.estado !== 'disponible'}">
                            <plex-label size="md" direction="column" titulo="{{turno.horaInicio | date: 'HH:mm'}}hs">
                            </plex-label>
                        </plex-card>
                    </plex-grid>
                </div>
                <plex-button justify="end" label="Confirmar" type="success" (click)="darTurno()" [disabled]="!bloque">
                </plex-button>
            </ng-container>

            <!--Si no hay turnos disponibles, se muestran alternativas-->
            <h6 *ngIf="estadoT == 'noTurnos' && alternativas.length<=0 && !reqfiltros">No existen alternativas</h6>
            <h6 *ngIf="estadoT == 'noTurnos' && reqfiltros">Debe ingresar algún filtro para buscar alternativa</h6>
            <h6 *ngIf="estadoT == 'noTurnos' && alternativas.length > 0">No hay turnos en esta agenda,
                <strong>seleccione una agenda alternativa</strong>
            </h6>

            <plex-list *ngIf="estadoT == 'noTurnos' && alternativas.length > 0" [selectable]="true">
                <plex-item *ngFor="let alternativa of alternativas; let i=index" (click)="seleccionarAlternativa(i)">
                    <plex-label titulo="Fecha" subtitulo="{{alternativa.horaInicio | fecha}}" size="md">
                    </plex-label>
                    <plex-label titulo="Tipo de Prestación" subtitulo="{{alternativa.tipoPrestaciones[0].nombre}}"
                                size="md">
                    </plex-label>
                    <plex-label titulo="Equipo de Salud"
                                subtitulo="{{alternativa.profesionales.length?equipoSaludAlternativas(alternativa.profesionales):'Equipo de Salud no asignado'}}"
                                size="md">
                    </plex-label>
                </plex-item>
            </plex-list>

            <!--Agenda Dinámica -->
            <plex-list *ngIf="estadoT == 'dinamica'" size="md" [selectable]="false">
                <plex-item>
                    <plex-button label="Dar Turno" type="success" (click)="turnoDinamico()" size="sm"></plex-button>
                    <plex-label *ngIf="agenda.bloques[0].turnos.length > 0"
                                titulo="La agenda tiene {{agenda.bloques[0].turnos.length}} pacientes asignados"
                                subtitulo="" size="md"></plex-label>
                    <plex-label *ngIf="agenda.bloques[0].turnos.length === 0"
                                titulo="La agenda no tiene pacientes asignados" subtitulo="" size="md"></plex-label>
                    <plex-badge *ngIf="agenda.cupo > 1" size="md" type="info">{{agenda.cupo}} cupos disponibles
                    </plex-badge>
                    <plex-badge *ngIf="agenda.cupo === 1" size="md" type="info">{{agenda.cupo}} cupo disponible
                    </plex-badge>
                    <plex-badge *ngIf="agenda.cupo === -1" size="md" type="info">Agenda con cupos no limitados
                    </plex-badge>
                </plex-item>
            </plex-list>
        </ng-container>
    </plex-layout-sidebar>
</plex-layout>
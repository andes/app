<plex-layout [main]="main" *ngIf="autorizado">
    <plex-layout-main>
        <plex-title *ngIf="!editaAgenda" titulo="{{ !editaAgenda ? 'Crear agenda' : 'Editar agenda'}}">
        </plex-title>
        <form #form="ngForm">
            <div class="row">
                <div class="col-4">
                    <plex-datetime type="date" [(ngModel)]="modelo.fecha" [required]="true" autoFocus="true"
                                   (change)="validarTodo()" name="modelo.fecha" label="Fecha">
                    </plex-datetime>
                </div>
                <div *ngIf="modelo.fecha" class="col-4">
                    <plex-datetime type="time" [(ngModel)]="modelo.horaInicio" [required]="true"
                                   (change)="validarTodo()" name="modelo.horaInicio" label="Inicio">
                    </plex-datetime>
                </div>
                <div *ngIf="modelo.fecha" class="col-4">
                    <plex-datetime type="time" [(ngModel)]="modelo.horaFin" [min]="horaInicioPlus()" [required]="true"
                                   (change)="validarTodo()" name="modelo.horaFin" label="Fin">
                    </plex-datetime>
                </div>
            </div>
            <div *ngIf="modelo.horaInicio && modelo.horaFin" class="row">
                <div class="col-12">
                    <plex-select [(ngModel)]="modelo.tipoPrestaciones" name="modelo.tipoPrestaciones"
                                 label="Tipos de prestación" (getData)="loadTipoPrestaciones($event)" [multiple]="true"
                                 [required]="true" (change)="cambioPrestaciones()" [closeAfterSelect]="true">
                    </plex-select>
                </div>
            </div>
            <div *ngIf="modelo.horaInicio && modelo.horaFin" class="row">
                <div class="col-12">
                    <plex-select [(ngModel)]="modelo.profesionales" label="Equipo de Salud" name="modelo.profesionales"
                                 (getData)="loadProfesionales($event)" [multiple]="true"
                                 labelField="apellido + ' ' + nombre" (change)="validarTodo()"
                                 [closeAfterSelect]="true">
                    </plex-select>
                </div>
            </div>
        </form>
        <!--Opcion agenda no nominalizada o dinamica-->
        <div *ngIf="modelo.horaInicio && modelo.horaFin" class="row">
            <div class="col">
                <plex-bool [(ngModel)]="dinamica" name="dinamica" label="Dinámica"
                           (change)="seleccionarDinamica($event)">
                </plex-bool>
            </div>
        </div>

        <br>
        <div *ngIf="modelo.horaInicio && modelo.horaFin && showBloque && modelo.bloques && modelo.bloques.length > 0"
             class="row">
            <div class="col-12">
                <plex-title titulo="Espacio físico" size="sm"></plex-title>
                <div class="row">
                    <div class="col text-left">
                        <plex-bool [(ngModel)]="espacioFisicoPropios" name="espacioFisicoPropios" type="slide"
                                   label="{{textoEspacio}}" (change)="filtrarEspacioFisico()">
                        </plex-bool>
                    </div>
                </div>
                <div class="row" *ngIf="espacioFisicoPropios">
                    <div class="col">
                        <plex-select [(ngModel)]="modelo.espacioFisico" name="espacioFisico"
                                     (getData)="loadEspaciosFisicos($event)"
                                     label="Seleccione un espacio físico del efector"
                                     placeholder="Seleccione un espacio físico"
                                     labelField="nombre + ' ' + (servicio.nombre ? servicio.nombre : '') + (edificio.descripcion ? edificio.descripcion : '')"
                                     (change)="validarTodo()">
                        </plex-select>
                    </div>
                </div>
                <div class="row" *ngIf="!espacioFisicoPropios">
                    <div class="col">
                        <plex-select [(ngModel)]="modelo.espacioFisico" name="otrosEspacios"
                                     (getData)="loadEspaciosFisicos($event)" label="Seleccione un espacio físico"
                                     placeholder="Seleccione un espacio físico" labelField="nombre"
                                     (change)="validarTodo()">
                        </plex-select>
                    </div>
                </div>
            </div>
        </div>

        <!--Lista de Bloques-->
        <div *ngIf="showBloque && modelo.bloques && modelo.bloques.length > 0" class="row">
            <div class="col">
                <plex-title size="sm" titulo="Bloques">
                    <plex-button *ngIf="!dinamica" class="float-right" icon="plus" type="success btn-sm"
                                 title="Agregar Bloque" (click)="addBloque()">
                    </plex-button>
                </plex-title>
                <div class="list-group">
                    <div *ngFor="let unBloque of modelo.bloques; let i=index"
                         class="list-group-item justify-content-between hover" [ngClass]="{active: i==bloqueActivo}"
                         (click)="activarBloque(i)">
                        <div>
                            <span *ngIf="unBloque.horaInicio && unBloque.horaFin">
                                {{ unBloque.horaInicio | date: 'HH:mm'}} a {{unBloque.horaFin | date: 'HH:mm' }}
                            </span>
                        </div>
                        <div *ngIf="unBloque.descripcion">{{unBloque.descripcion}}</div>
                        <plex-button *ngIf="!dinamica && modelo.bloques.length > 1" icon="delete" type="primary"
                                     (click)="deleteBloque(i)">
                        </plex-button>
                    </div>
                </div>
            </div>
        </div>

    </plex-layout-main>
    <plex-layout-sidebar>
        <!--Edición del bloque activo-->
        <plex-title titulo="Bloque">
            <div *ngIf="alertas.length" role="alert">
                <div class="alert alert-warning mb-0">
                    <div *ngFor="let alert of alertas; let i=index">
                        <i class="mdi mdi-alert-outline float-left mr-3"></i>{{alert}}
                    </div>
                </div>
            </div>
        </plex-title>
        <ng-container *ngIf="elementoActivo && bloqueActivo >= 0 && !showMapaEspacioFisico && !dinamica">

            <div class="row">
                <div class="col-6">
                    <div class="row">
                        <div class="col-12">
                            <plex-text [(ngModel)]="elementoActivo.descripcion" name="descripcion" label="Descripción">
                            </plex-text>
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <label>Tipos de prestaciones asociadas</label>
                    <div *ngFor="let unaPrestacion of elementoActivo.tipoPrestaciones; let i=index">
                        <plex-bool [(ngModel)]="elementoActivo.tipoPrestaciones[i].activo" [name]=" 'activo' +
                                                    i" label="{{unaPrestacion.nombre}}" type="slide">
                        </plex-bool>
                    </div>
                </div>
            </div>
            <div class="row" *ngIf="!modelo.intercalar">
                <div class="col-6">
                    <plex-datetime type="time" [(ngModel)]="elementoActivo.horaInicio"
                                   [name]="'horaInicio' + bloqueActivo" [required]="true"
                                   (blur)="cambioHoraBloques( 'inicio' )" label="Hora Inicio">
                    </plex-datetime>
                </div>
                <div class="col-6">
                    <plex-datetime type="time" [(ngModel)]="elementoActivo.horaFin" name="horaFin" [required]="true"
                                   (blur)="cambioHoraBloques( 'fin' )" label="Hora Fin">
                    </plex-datetime>
                </div>
            </div>
            <ng-container *ngIf="modelo.nominalizada">
                <div class="row">
                    <div class="col-6">
                        <plex-int [(ngModel)]="elementoActivo.cantidadTurnos" name="cantidadTurnos"
                                  (keyup)="cambiaTurnos( 'cantidad' )" label="Cantidad de Turnos" [required]="true"
                                  min=1 placeholder="Ingrese un valor">
                        </plex-int>
                    </div>
                    <div class="col-6">
                        <plex-int [(ngModel)]="elementoActivo.duracionTurno" name="duracionTurno"
                                  (keyup)="cambiaTurnos( 'duracion' )" label="Duración del Turno" suffix="minutos"
                                  [required]="true" min=1 placeholder="Ingrese un valor">
                        </plex-int>
                    </div>
                    <div *ngIf="elementoActivo.duracionTurno" class="container">
                        <span class="text-primary">(turnos cada {{ elementoActivo.duracionTurno }}
                            minutos)</span>
                    </div>
                </div>
            </ng-container>
            <ng-container *ngIf="modelo.nominalizada">
                <div class="row pt-3">
                    <div class="col-6">
                        <plex-title size="sm" titulo="Acceso Directo"></plex-title>
                        <div class="row">
                            <div class="col">
                                <label class="w-100">Del día</label>
                                <plex-int [(ngModel)]="elementoActivo.accesoDirectoDelDia" [min]="0" [required]="true"
                                          (keyup)="cambiaCantTipo( 'accesoDirectoDelDia' )" name="accesoDirectoDelDia">
                                </plex-int>
                                <plex-int [(ngModel)]="elementoActivo.accesoDirectoDelDiaPorc" [min]="0"
                                          (keyup)="cambiaPorcentajeTipo( 'accesoDirectoDelDia' )"
                                          name="accesoDirectoDelDiaPorc" suffix="%">
                                </plex-int>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                <label class="w-100">Programados</label>
                                <plex-int [(ngModel)]="elementoActivo.accesoDirectoProgramado" [min]="0"
                                          [required]="true" (keyup)="cambiaCantTipo( 'accesoDirectoProgramado' )"
                                          name="accesoDirectoProgramado">
                                </plex-int>
                                <plex-int [(ngModel)]="elementoActivo.accesoDirectoProgramadoPorc" [min]="0"
                                          (keyup)="cambiaPorcentajeTipo( 'accesoDirectoProgramado' )"
                                          name="accesoDirectoProgramadoPorc" suffix="%">
                                </plex-int>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <plex-title size="sm" titulo="Reservados"></plex-title>
                        <div class="row">
                            <div class="col">
                                <label class="w-100">Con llave</label>
                                <plex-int [(ngModel)]="elementoActivo.reservadoGestion" [min]="0" [required]="true"
                                          (keyup)="cambiaCantTipo( 'reservadoGestion')" name="reservadoGestion">
                                </plex-int>
                                <plex-int [(ngModel)]="elementoActivo.reservadoGestionPorc" [min]="0"
                                          (keyup)="cambiaPorcentajeTipo( 'reservadoGestion')"
                                          name="reservadoGestionporc" suffix="%">
                                </plex-int>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                <label class="w-100">Para profesional</label>
                                <plex-int [(ngModel)]="elementoActivo.reservadoProfesional" [min]="0" [required]="true"
                                          (keyup)="cambiaCantTipo( 'reservadoProfesional')" name="reservadoProfesional">
                                </plex-int>
                                <plex-int [(ngModel)]="elementoActivo.reservadoProfesionalPorc" [min]="0"
                                          (keyup)="cambiaPorcentajeTipo( 'reservadoProfesional')"
                                          name="progReservadoPorc" suffix="%">
                                </plex-int>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row pt-3">
                    <div class="col-4">
                        <plex-bool *ngIf="elementoActivo.accesoDirectoProgramado > 0 && mobileEnabled"
                                   [(ngModel)]="elementoActivo.turnosMobile" label="Ventanilla virtual"
                                   name="turnosMobile">
                        </plex-bool>
                    </div>
                    <div class="col-4"
                         *ngIf="elementoActivo.turnosMobile && elementoActivo.accesoDirectoProgramado > 0 && mobileEnabled">
                        <plex-int [(ngModel)]="elementoActivo.cupoMobile" [max]="elementoActivo.accesoDirectoProgramado"
                                  name="cupoMobile" suffix="Turnos"
                                  title="Este no es un cupo extra, es parte del cupo de programados"
                                  titlePosition="top">
                        </plex-int>
                    </div>
                </div>
                <div class="row">
                    <div *ngIf="!elementoActivo.citarPorBloque" class="col-4">
                        <plex-bool [(ngModel)]="elementoActivo.pacienteSimultaneos" label="Pacientes simultáneos"
                                   name="pacienteSimultaneos"></plex-bool>
                    </div>
                    <div *ngIf="elementoActivo.pacienteSimultaneos" class="col-4">
                        <plex-int [(ngModel)]="elementoActivo.cantidadSimultaneos" name="cantidadSimultaneos"
                                  suffix="Pacientes" [min]=1 required>
                        </plex-int>
                    </div>
                </div>
                <div class="row">
                    <div *ngIf="!elementoActivo.pacienteSimultaneos" class="col-4">
                        <plex-bool [(ngModel)]="elementoActivo.citarPorBloque" label="Citar por segmento"
                                   name="citarPorBloque"></plex-bool>
                    </div>
                    <div *ngIf="elementoActivo.citarPorBloque" class="col-4">
                        <plex-int [(ngModel)]="elementoActivo.cantidadBloque" [min]=1
                                  [max]="elementoActivo.cantidadTurnos" name="cantidadBloque" suffix="Pacientes"
                                  required>
                        </plex-int>
                    </div>
                </div>
                <br>
            </ng-container>

            <div *ngIf="!showMapaEspacioFisico && dinamica">
                <header>
                    <div class="page-title">Agenda Dinámica</div>
                </header>
                <div class="row">
                    <div class="col-12">
                        <plex-text [(ngModel)]="elementoActivo.descripcion" name="descripcion" label="Descripción">
                        </plex-text>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <plex-bool [(ngModel)]="setCupo" name="cupo" label="Cupo máximo"> </plex-bool>
                    </div>
                </div>
                <div class="row" *ngIf="setCupo">
                    <div class="col-12">
                        <plex-int [(ngModel)]="cupoMaximo" name="cupoMaximo" min="1" max="1000" [required]="true">
                        </plex-int>
                    </div>
                </div>
            </div>

        </ng-container>

    </plex-layout-sidebar>
    <plex-layout-footer>
        <plex-button position="left" type="danger" label="Cancelar" (click)="cancelar()">
        </plex-button>
        <plex-button *ngIf="autorizado && !alertas.length && form.valid && !hideGuardar" position="right"
                     label="Guardar" type="success" (click)="onSave($event, false)" class="mr-2">
        </plex-button>
        <plex-button *ngIf="autorizado && !alertas.length && form.valid && !hideGuardar" position="right"
                     label="Guardar y clonar" type="success" (click)="onSave($event, true)">
        </plex-button>
    </plex-layout-footer>

</plex-layout>
<section *ngIf="showRevisionAgenda">
    <div class="row">
        <div class="col-4">
            <plex-box>
                <header class="header-fixed" [ngClass]="{'header-fixed-front': mostrarHeaderCompleto}">
                    <fieldset>
                        <legend>
                            <div class="clearfix">
                                <span class="float-left">Revisión de Agendas</span>
                            </div>
                        </legend>
                        <!--Header de la agenda-->
                        <div class="alert alert-default mb-0">
                            <div class="float-right">
                                <plex-button type="default" title="Mostrar detalle de la agenda" titlePosition="left" [icon]="mostrarHeaderCompleto ? 'chevron-up' : 'chevron-down'"
                                    (click)="mostrarHeaderCompleto = !mostrarHeaderCompleto"></plex-button>
                            </div>
                            <!--Header pequeño-->
                            <div *ngIf="!mostrarHeaderCompleto" class="row">
                                <div class="col-12">
                                    {{ agenda.horaInicio | date: 'EEE' | uppercase }} {{ agenda.horaInicio | date: 'dd/MM/yyyy'}}, {{ agenda.horaInicio | date:
                                    'HH:mm'}} a {{ agenda.horaFin | date: 'HH:mm'}} hs
                                    <div *ngFor="let tipoPrestacion of agenda.tipoPrestaciones">{{tipoPrestacion.nombre}}</div>
                                </div>
                            </div>
                            <!--Header completo-->
                            <div *ngIf="mostrarHeaderCompleto" class="row">
                                <div class="col-12">
                                    <label>Fecha</label> {{ agenda.horaInicio | date: 'EEE' | uppercase }} {{ agenda.horaInicio
                                    | date: 'dd/MM/yyyy'}}, {{ agenda.horaInicio | date: 'HH:mm'}} a {{ agenda.horaFin |
                                    date: 'HH:mm'}} hs
                                </div>
                            </div>
                            <div *ngIf="mostrarHeaderCompleto" class="row">
                                <div class="col-12">
                                    <label>Tipos de prestación</label>
                                    <div *ngFor="let tipoPrestacion of agenda.tipoPrestaciones">{{tipoPrestacion.nombre}}</div>
                                </div>
                            </div>
                            <div *ngIf="mostrarHeaderCompleto" class="row">
                                <div class="col-12">
                                    <label>Profesionales</label>
                                    <span *ngIf="agenda.profesionales?.length == 0" class="text-danger">Profesional no asignado</span>
                                    <ng-container *ngIf="agenda.profesionales">
                                        <div *ngFor="let profesional of agenda.profesionales">{{profesional | profesional}}</div>
                                    </ng-container>
                                </div>
                            </div>
                            <div *ngIf="mostrarHeaderCompleto" class="row">
                                <div class="col-12">
                                    <label>Espacio físico</label>
                                    <span *ngIf="agenda.espacioFisico?.nombre">{{agenda.espacioFisico.nombre}}</span>
                                    <span *ngIf="!agenda.espacioFisico?.nombre" class="text-danger">Espacio físico no asignado</span>
                                </div>
                            </div>
                        </div>
                        <!--Nota-->
                        <div *ngIf="agenda.nota" class="alert alert-default mb-0">
                            <i class="mdi mdi-comment mr-3"></i>{{ agenda.nota }}
                        </div>
                    </fieldset>
                </header>

                <table *ngFor="let bloque of agenda.bloques" class="table table-striped">
                    <thead *ngIf="bloque.descripcion">
                        <tr>
                            <th colspan="4">{{bloque.descripcion}}
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let turno of bloque.turnos; let i=index" class="hover" [ngClass]="{'bg-inverse text-white': estaSeleccionado(bloque.turnos[i])}">
                            <td (click)="seleccionarTurno(turno, bloque)">
                                <i *ngIf="estaSeleccionado(bloque.turnos[i])" class="mdi mdi-checkbox-marked"></i>
                                <i *ngIf="!estaSeleccionado(bloque.turnos[i])" class="mdi mdi-checkbox-blank-outline"></i>
                            </td>
                            <td (click)="seleccionarTurno(bloque.turnos[i], bloque)">
                                <strong *ngIf="turno">{{ turno.horaInicio | date: 'HH:mm' }}</strong>
                            </td>
                            <td (click)="seleccionarTurno(bloque.turnos[i], bloque)">
                                <span *ngIf="turno.paciente && turno.paciente.id">{{ turno.paciente | paciente }} </span>
                                <small *ngIf="turno.paciente && turno.paciente.id && turno.paciente.documento !== ''">
                                    <span *ngIf="turno.paciente.documento !== ''">| DNI: {{ turno.paciente.documento | number }}</span>
                                </small>
                                <small *ngIf="turno.paciente && turno.paciente.id && turno.paciente.documento === ''">
                                    <span>| Sin documento (temporal)</span>
                                </small>
                                <small>
                                    <span *ngIf="turno.paciente && turno.paciente.id && turno.paciente.carpetaEfectores && turno.paciente.carpetaEfectores.length > 0 && turno.paciente.carpetaEfectores[0].nroCarpeta!=''">
                                        | Nro Carpeta
                                        <span *ngFor="let carpeta of turno.paciente.carpetaEfectores | slice:0:1;">
                                            {{ carpeta.nroCarpeta }}
                                            <!-- <plex-text [(ngModel)]="carpeta.nroCarpeta"></plex-text> -->
                                        </span>
                                    </span>
                                </small>
                                <span *ngIf="turno && turno.estado === 'disponible'">Disponible</span>
                                <span [ngClass]="{'text-danger': turno.estado === 'turnoDoble'}" *ngIf="turno && turno.estado === 'turnoDoble'">Turno Doble</span>
                                <span [ngClass]="{'text-danger': turno.estado === 'suspendido'}" *ngIf="turno && turno.estado === 'suspendido'">Suspendido</span>
                                <span *ngIf="turno && turno.nota">
                                    <i title="{{turno.nota}}" class="text-warning warning mdi mdi-message"></i>
                                </span>
                                <span [ngClass]="{'text-warning': true}" *ngIf="turno?.asistencia && turno?.asistencia == 'asistio' && !turno?.diagnostico?.codificaciones[0]?.codificacionAuditoria?.codigo && !turno?.diagnostico?.codificaciones[0]?.codificacionProfesional?.snomed?.term">| Asistencia Verificada</span>
                                <span [ngClass]="{'text-success': true}" *ngIf="turno?.paciente?.id && !turno?.diagnostico?.codificaciones[0]?.codificacionAuditoria?.codigo && turno?.diagnostico?.codificaciones[0]?.codificacionProfesional?.snomed?.term">| Registrado por Profesional</span>
                                <span [ngClass]="{'text-success': true}" *ngIf="turno?.paciente?.id && turno?.asistencia && (turno.asistencia =='noAsistio'|| turno.asistencia=='sinDatos' ||  turno?.diagnostico?.codificaciones[0]?.codificacionAuditoria?.codigo) ">| Auditado</span>

                            </td>
                        </tr>

                    </tbody>
                </table>
                <table class="table table-striped">
                    <thead *ngIf="agenda.sobreturnos.length > 0">
                        <tr>
                            <th colspan="4">Sobreturnos </th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- SOBRETURNOS -->
                        <tr *ngFor="let sobreturno of agenda.sobreturnos; let i=index" class="hover" [ngClass]="{'bg-inverse text-white': estaSeleccionado(agenda.sobreturnos[i])}">
                            <td (click)="seleccionarTurno(sobreturno, -1)">
                                <i *ngIf="estaSeleccionado(agenda.sobreturnos[i])" class="mdi mdi-checkbox-marked"></i>
                                <i *ngIf="!estaSeleccionado(agenda.sobreturnos[i])" class="mdi mdi-checkbox-blank-outline"></i>
                            </td>
                            <td (click)="seleccionarTurno(agenda.sobreturnos[i], bloque)">
                                <strong *ngIf="sobreturno">{{ sobreturno.horaInicio | date: 'HH:mm' }}</strong>
                            </td>
                            <td (click)="seleccionarTurno(agenda.sobreturnos[i], -1)">
                                <span *ngIf="sobreturno.paciente && sobreturno.paciente.id">{{ sobreturno.paciente | paciente }} </span>
                                <small>
                                    <span *ngIf="sobreturno.paciente && sobreturno.paciente.id && sobreturno.paciente.documento !== ''">| DNI: {{ sobreturno.paciente.documento | number }}</span>
                                    <span *ngIf="sobreturno.paciente && sobreturno.paciente.id && sobreturno.paciente.documento === ''" class="text-danger">| DNI: Sin documento (temporal)</span>
                                </small>
                                <small>
                                    <span *ngIf="sobreturno.paciente && sobreturno.paciente.id && sobreturno.paciente.carpetaEfectores && sobreturno.paciente.carpetaEfectores.length > 0 && sobreturno.paciente.carpetaEfectores[0].nroCarpeta!=''">
                                        | Nro Carpeta
                                        <span *ngFor="let carpeta of sobreturno.paciente.carpetaEfectores | slice:0:1;">
                                            {{carpeta.nroCarpeta}}
                                            <!-- <plex-text [(ngModel)]="carpeta.nroCarpeta"></plex-text> -->
                                        </span>
                                    </span>
                                </small>
                                <span [ngClass]="{'text-danger': sobreturno.estado === 'suspendido'}" *ngIf="sobreturno && sobreturno.estado === 'suspendido'">Suspendido</span>
                                <span *ngIf="sobreturno && sobreturno.nota">
                                    <i title="{{sobreturno.nota}}" class="text-warning warning mdi mdi-message"></i>
                                </span>
                                <span [ngClass]="{'text-warning': true}" *ngIf="sobreturno?.asistencia && sobreturno?.asistencia == 'asistio' && !sobreturno?.diagnostico?.codificaciones[0]?.codificacionAuditoria?.codigo">| Asistencia Verificada</span>
                                <span [ngClass]="{'text-success': true}" *ngIf="sobreturno?.paciente?.id && (sobreturno?.diagnostico?.codificaciones[0]?.codificacionAuditoria?.codigo || (sobreturno?.asistencia && sobreturno.asistencia =='noAsistio'|| sobreturno.asistencia=='sinDatos'))">| Auditado</span>

                            </td>
                        </tr>
                    </tbody>
                    <!-- /SOBRETURNOS -->
                </table>
                <div class="row">
                    <div class="col-6">
                        <plex-button type="primary" label="Agregar Sobreturno" (click)="agregarSobreturno()"></plex-button>
                    </div>
                </div>
            </plex-box>
        </div>
        <div class="col-8" *ngIf="turnoSeleccionado && turnoSeleccionado.estado !== 'suspendido' && turnoSeleccionado.estado !== 'turnoDoble'">
            <plex-box>
                <!--REGISTRO DE ASISTENCIA-->
                <header>
                    <div class="clearfix">
                        <div class="page-title">REGISTROS DEL TURNO</div>
                    </div>
                </header>
                <div class="row" *ngIf="turnoSeleccionado && turnoSeleccionado.estado == 'disponible'">
                    <div class="col" *ngIf="paciente?.id">
                        <small>
                            <span *ngIf="paciente.documento !== ''"> DNI {{ paciente.documento | number }}</span>
                            <span *ngIf="paciente.documento === ''" class="text-danger"> Sin documento (temporal)</span>
                        </small>
                        <div *ngIf="paciente?.id"> {{paciente | paciente}}</div>
                    </div>
                    <div class="col" *ngIf="!paciente?.id && !turnoSeleccionado.paciente">
                        <small>
                            <span> No existe un paciente asociado</span>
                        </small>
                    </div>
                    <div class="col" *ngIf="!pacientesSearch">
                        <plex-button type="primary" icon="mdi mdi-calendar-multiple" label="Buscar Paciente" (click)="buscarPaciente()"></plex-button>
                    </div>
                </div>
                <div class="row">
                    <div class="col" *ngIf="turnoSeleccionado.paciente?.id">
                        <div *ngIf="turnoSeleccionado.paciente?.id"> {{ turnoSeleccionado.paciente | paciente }}
                            <span *ngIf="turnoSeleccionado.paciente.documento !== ''"> | DNI {{ turnoSeleccionado.paciente.documento | number}}</span>
                            <span *ngIf="turnoSeleccionado.paciente.documento === ''"> Sin documento (temporal)</span>
                            <span *ngIf="turnoSeleccionado.paciente.fechaNacimiento !== null">| Edad: {{ turnoSeleccionado.paciente | edad }}</span>
                            <span *ngIf="turnoSeleccionado?.paciente?.id && turnoSeleccionado?.paciente?.sexo">| Sexo: {{ turnoSeleccionado.paciente | sexo }}</span>
                            <span *ngIf="turnoSeleccionado?.paciente?.id && turnoSeleccionado?.paciente?.edad">{{ turno.paciente.fechaNacimiento | date: 'dd/MM/yyyy' }}</span>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col" *ngIf="pacientesSearch">
                        <div class="panel panel-default">
                            <div class="clear"></div>
                            <pacientesSearch [modoCompleto]="false" (selected)="onReturn($event)"></pacientesSearch>
                        </div>
                    </div>
                </div>
                <div class="row" *ngIf="!turnoSeleccionado.tipoPrestacion && bloqueSeleccionado && paciente?.id">
                    <div class="col-6">
                        <br>
                        <label>Prestación: </label>
                        <plex-select *ngIf="!turnoTipoPrestacion" [(ngModel)]="turnoTipoPrestacion" name="tipoPrestacionTurno" [data]="bloqueSeleccionado.tipoPrestaciones">
                        </plex-select>
                        <div *ngIf="turnoTipoPrestacion">{{turnoTipoPrestacion.nombre}}</div>
                    </div>
                </div>
                <div *ngIf="turnoSeleccionado && (turnoSeleccionado.paciente?.id || paciente?.id) && !pacientesSearch">
                    <div class="row">
                        <div class="col-4">
                            <!--ASISTENCIA-->
                            <div *ngIf="!existeCodificacionProfesional">
                                <plex-select label="Asistencia" [(ngModel)]="turnoSeleccionado.asistencia" name="localidad" [data]="estadosAsistencia" placeholder="Seleccione..."
                                    (change)="seleccionarAsistencia(turnoSeleccionado.asistencia)">
                                </plex-select>
                            </div>
                            <!--/ ASISTENCIA-->
                        </div>
                    </div>
                    <br>

                    <!--CODIFICACION-->
                    <div class="row">
                        <div class="col-12">
                            <div *ngIf="turnoSeleccionado?.asistencia == 'asistio'">
                                <div *ngIf="!showReparo">
                                    <h5>Codificación</h5>
                                    <hr>
                                    <!-- Buscador de prestaciones cie10 -->
                                    <div class="row">
                                        <div class="col-10">
                                            <Label>Agregar diagnóstico</Label>
                                            <buscador-cie10 (seleccionEmit)="agregarDiagnostico($event)"></buscador-cie10>
                                        </div>

                                    </div>
                                    <hr>
                                    <!-- Listado de codificaciones seleccionadas -->
                                    <div class="row">
                                        <div class="col">
                                            <table class="table table-striped">
                                                <thead>
                                                    <th></th>
                                                    <th class="text-left">Primera vez</th>
                                                    <th></th>
                                                    <th class="text-left">Diagnóstico Snomed</th>
                                                    <th class="text-left">Diagnóstico CIE10</th>
                                                </thead>
                                                <tbody>
                                                    <tr *ngFor="let diagnostico of diagnosticos; let i = index; " class="hover">
                                                        <td>
                                                            <!-- Boton aprobar diagnostico profesional -->
                                                            <plex-button *ngIf="diagnostico.codificacionProfesional?.snomed?.term && !diagnostico.codificacionAuditoria" class="btn btn-sm"
                                                                type="success" icon="mdi mdi-check" title="Aprobar" (click)="aprobar(i)"></plex-button>
                                                            <!-- Boton eliminar diagnostico (para diagnosticos de auditoría) -->
                                                            <plex-button *ngIf="!diagnostico.codificacionProfesional?.snomed?.term" icon="delete" title="Eliminar" class="btn btn-sm"
                                                                type="danger" (click)="borrarDiagnostico(i)"></plex-button>

                                                            <plex-button *ngIf="diagnostico.codificacionProfesional?.snomed?.term && !diagnostico.codificacionAuditoria?.codigo" class="btn btn-sm"
                                                                type="danger" icon="mdi mdi-pencil" title="Reparar" (click)="mostrarReparo(i)">
                                                            </plex-button>
                                                            <plex-button *ngIf="diagnostico.codificacionProfesional?.snomed?.term && diagnostico.codificacionAuditoria?.codigo" class="btn btn-sm"
                                                                type="info" icon="mdi mdi-refresh" title="Reestablecer" (click)="borrarReparo(i)">
                                                            </plex-button>
                                                        </td>
                                                        <td class="text-center">
                                                            <plex-bool *ngIf="!diagnostico.codificacionProfesional?.snomed?.term" (change)="onSave()" [(ngModel)]='diagnostico.primeraVez'></plex-bool>
                                                            <span class="badge-success" *ngIf="diagnostico.codificacionProfesional?.snomed?.term && diagnostico.primeraVez">Aprobado</span>
                                                        </td>
                                                        <td>
                                                            <span class="badge-success" *ngIf=" diagnostico.codificacionAuditoria && diagnostico.codificacionProfesional && diagnostico.codificacionAuditoria?.codigo === diagnostico.codificacionProfesional?.cie10?.codigo">Aprobado</span>

                                                            <span class="badge-warning" *ngIf="diagnostico.codificacionAuditoria?.codigo && diagnostico.codificacionProfesional?.snomed?.term && diagnostico.codificacionAuditoria?.codigo != diagnostico.codificacionProfesional?.cie10?.codigo">Reparado</span>

                                                            <span *ngIf="i==0" class="badge-info">Principal</span>
                                                        </td>
                                                        <td>
                                                            <!-- Mostramos la codificación snomed hecha por profesional -->
                                                            <div>
                                                                <span *ngIf="diagnostico.codificacionProfesional?.snomed?.term">{{diagnostico.codificacionProfesional.snomed.term}}
                                                                </span>
                                                                <span *ngIf="!diagnostico.codificacionProfesional?.snomed?.term"> -
                                                                </span>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            <div>
                                                                <!-- Si no mapea a cie10 -->
                                                                <span *ngIf="!diagnostico.codificacionProfesional?.snomed?.term &&!diagnostico.codificacionProfesional?.cie10?.codigo && !diagnostico.codificacionAuditoria">
                                                                    No encontrado
                                                                </span>
                                                                <!-- Mostramos el mapeo de la codificación snomed -->
                                                                <span *ngIf="diagnostico.codificacionProfesional?.cie10 && (!diagnostico.codificacionAuditoria || diagnostico.codificacionAuditoria?.codigo == diagnostico.codificacionProfesional?.cie10?.codigo )">
                                                                    ({{diagnostico.codificacionProfesional.cie10.codigo}}) {{diagnostico.codificacionProfesional.cie10.sinonimo}}
                                                                </span>
                                                                <!-- Mostramos la codificación reparada -->
                                                                <span *ngIf="diagnostico.codificacionAuditoria?.codigo && diagnostico.codificacionProfesional?.snomed?.term && diagnostico.codificacionAuditoria?.codigo != diagnostico.codificacionProfesional?.cie10?.codigo">
                                                                    ({{diagnostico.codificacionAuditoria.codigo}}) {{diagnostico.codificacionAuditoria.sinonimo}}
                                                                </span>
                                                                <!-- Mostramos la codificación cuando no hay diagnóstico del profesional -->
                                                                <span *ngIf="!diagnostico.codificacionProfesional?.snomed?.term && diagnostico.codificacionAuditoria?.sinonimo">({{diagnostico.codificacionAuditoria.codigo}}) {{diagnostico.codificacionAuditoria.sinonimo}}
                                                                </span>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                </div>

                                <!-- Reparo -->
                                <div *ngIf="turnoSeleccionado && diagnosticos[indiceReparo]?.codificacionProfesional && showReparo">
                                    <div class="row">
                                        <div class="col">
                                            <h3>Codificación del profesional</h3>
                                            <h5>
                                                <label> Codificación Snomed: </label> {{diagnosticos[indiceReparo].codificacionProfesional.snomed.term}}
                                            </h5>
                                            <h5>
                                                <label> Mapeo a Cie10: </label>
                                                <span *ngIf="diagnosticos[indiceReparo].codificacionProfesional.cie10?.sinonimo">
                                                    {{diagnosticos[indiceReparo].codificacionProfesional.cie10.sinonimo}}</span>

                                            </h5>
                                            <hr>
                                        </div>
                                    </div>
                                    <!-- Búsqueda de prestaciones cie10 -->
                                    <div class="row">
                                        <div class="col-10">
                                            <Label>Seleccionar código reparo Cie10</Label>
                                            <buscador-cie10 (seleccionEmit)="repararDiagnostico($event)"></buscador-cie10>
                                        </div>
                                    </div>
                                </div>
                                <!-- /Reparo -->
                            </div>
                        </div>
                    </div>
                    <!--/ CODIFICACION-->
                </div>
            </plex-box>
        </div>
    </div>
</section>
<footer *ngIf="modoCompleto">
    <div class="row">
        <div class="col text-right">
            <plex-button type="default" label="Volver" (click)="volver()">
            </plex-button>
        </div>
    </div>
</footer>
<sobreturno *ngIf="showAgregarSobreturno" [agenda]="agenda" [revision]="true" (volverRevision)="volverRevision($event)"></sobreturno>
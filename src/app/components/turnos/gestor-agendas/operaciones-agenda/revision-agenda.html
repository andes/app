<section *ngIf="showRevisionAgenda">
    <div class="row">
        <div class="col-4">
            <plex-box>
                <header class="header-fixed" [ngClass]="{'header-fixed-front': mostrarHeaderCompleto}">
                    <fieldset>
                        <legend>
                            <div class="clearfix">
                                <span class="float-left">Revisión de Agendas</span>
                            </div>
                        </legend>
                        <!--Header de la agenda-->
                        <div class="alert alert-default mb-0">
                            <div class="float-right">
                                <plex-button type="default" title="Mostrar detalle de la agenda" titlePosition="left" [icon]="mostrarHeaderCompleto ? 'chevron-up' : 'chevron-down'"
                                    (click)="mostrarHeaderCompleto = !mostrarHeaderCompleto"></plex-button>
                            </div>
                            <!--Header pequeño-->
                            <div *ngIf="!mostrarHeaderCompleto" class="row">
                                <div class="col-12">
                                    {{ agenda.horaInicio | date: 'EEE' | uppercase }} {{ agenda.horaInicio | date: 'dd/MM/yyyy'}}, {{ agenda.horaInicio | date:
                                    'HH:mm'}} a {{ agenda.horaFin | date: 'HH:mm'}} hs
                                    <div *ngFor="let tipoPrestacion of agenda.tipoPrestaciones">{{tipoPrestacion.nombre}}</div>
                                </div>
                            </div>
                            <!--Header completo-->
                            <div *ngIf="mostrarHeaderCompleto" class="row">
                                <div class="col-12">
                                    <label>Fecha</label> {{ agenda.horaInicio | date: 'EEE' | uppercase }} {{ agenda.horaInicio
                                    | date: 'dd/MM/yyyy'}}, {{ agenda.horaInicio | date: 'HH:mm'}} a {{ agenda.horaFin |
                                    date: 'HH:mm'}} hs
                                </div>
                            </div>
                            <div *ngIf="mostrarHeaderCompleto" class="row">
                                <div class="col-12">
                                    <label>Tipos de prestación</label>
                                    <div *ngFor="let tipoPrestacion of agenda.tipoPrestaciones">{{tipoPrestacion.nombre}}</div>
                                </div>
                            </div>
                            <div *ngIf="mostrarHeaderCompleto" class="row">
                                <div class="col-12">
                                    <label>Profesionales</label>
                                    <span *ngIf="agenda.profesionales?.length == 0" class="text-danger">Profesional no asignado</span>
                                    <ng-container *ngIf="agenda.profesionales">
                                        <div *ngFor="let profesional of agenda.profesionales">{{profesional | profesional}}</div>
                                    </ng-container>
                                </div>
                            </div>
                            <div *ngIf="mostrarHeaderCompleto" class="row">
                                <div class="col-12">
                                    <label>Espacio físico</label>
                                    <span *ngIf="agenda.espacioFisico?.nombre">{{agenda.espacioFisico.nombre}}</span>
                                    <span *ngIf="!agenda.espacioFisico?.nombre" class="text-danger">Espacio físico no asignado</span>
                                </div>
                            </div>
                        </div>
                        <!--Nota-->
                        <div *ngIf="agenda.nota" class="alert alert-default mb-0">
                            <i class="mdi mdi-comment mr-3"></i>{{ agenda.nota }}
                        </div>
                    </fieldset>
                </header>

                <table *ngFor="let bloque of agenda.bloques" class="table table-striped">
                    <thead *ngIf="bloque.descripcion">
                        <tr>
                            <th colspan="4">{{bloque.descripcion}}
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let turno of bloque.turnos; let i=index" class="hover" [ngClass]="{'bg-inverse text-white': estaSeleccionado(bloque.turnos[i])}">
                            <td (click)="seleccionarTurno(turno, bloque)">
                                <i *ngIf="estaSeleccionado(bloque.turnos[i])" class="mdi mdi-checkbox-marked"></i>
                                <i *ngIf="!estaSeleccionado(bloque.turnos[i])" class="mdi mdi-checkbox-blank-outline"></i>
                            </td>
                            <td (click)="seleccionarTurno(bloque.turnos[i], bloque)">
                                <strong *ngIf="turno">{{ turno.horaInicio | date: 'HH:mm' }}</strong>
                            </td>
                            <td (click)="seleccionarTurno(bloque.turnos[i], bloque)">
                                <span *ngIf="turno.paciente && turno.paciente.id">{{ turno.paciente | paciente }} </span>
                                <small *ngIf="turno.paciente && turno.paciente.id && turno.paciente.documento !== ''">
                                    <span *ngIf="turno.paciente.documento !== ''">| DNI: {{ turno.paciente.documento | number }}</span>
                                </small>
                                <small *ngIf="turno.paciente && turno.paciente.id && turno.paciente.documento === ''">
                                    <span>| Sin documento (temporal)</span>
                                </small>
                                <small>
                                    <span *ngIf="turno.paciente && turno.paciente.id && turno.paciente.carpetaEfectores && turno.paciente.carpetaEfectores.length > 0 && turno.paciente.carpetaEfectores[0].nroCarpeta!=''">
                                        | Nro Carpeta
                                        <span *ngFor="let carpeta of turno.paciente.carpetaEfectores | slice:0:1;">
                                            {{ carpeta.nroCarpeta }}
                                            <!-- <plex-text [(ngModel)]="carpeta.nroCarpeta"></plex-text> -->
                                        </span>
                                    </span>
                                </small>
                                <span *ngIf="turno && turno.estado === 'disponible'">Disponible</span>
                                <span [ngClass]="{'text-danger': turno.estado === 'turnoDoble'}" *ngIf="turno && turno.estado === 'turnoDoble'">Turno Doble</span>
                                <span [ngClass]="{'text-danger': turno.estado === 'suspendido'}" *ngIf="turno && turno.estado === 'suspendido'">Suspendido</span>
                                <span *ngIf="turno && turno.nota">
                                    <i title="{{turno.nota}}" class="text-warning warning mdi mdi-message"></i>
                                </span>
                                <span [ngClass]="{'text-warning': true}" *ngIf="turno?.asistencia && turno?.diagnostico?.codificaciones[0]?.codificacionAuditoria == null && turno?.diagnostico?.codificaciones[0]?.codificacionProfesional == null">| Asistencia Verificada</span>
                                <span [ngClass]="{'text-success': true}" *ngIf="turno?.paciente?.id && turno?.diagnostico?.codificaciones[0]?.codificacionAuditoria == null && turno?.diagnostico?.codificaciones[0]?.codificacionProfesional != null">| Registrado por Profesional</span>
                                <span [ngClass]="{'text-success': true}" *ngIf="turno?.paciente?.id && turno?.diagnostico?.codificaciones[0]?.codificacionAuditoria != null ">| Auditado</span>

                            </td>
                        </tr>

                    </tbody>
                </table>
                <table class="table table-striped">
                    <thead *ngIf="agenda.sobreturnos.length > 0">
                        <tr>
                            <th colspan="4">Sobreturnos
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- SOBRETURNOS -->
                        <tr *ngFor="let sobreturno of agenda.sobreturnos; let i=index" class="hover" [ngClass]="{'bg-inverse text-white': estaSeleccionado(agenda.sobreturnos[i])}">
                            <td (click)="seleccionarTurno(sobreturno, -1)">
                                <i *ngIf="estaSeleccionado(agenda.sobreturnos[i])" class="mdi mdi-checkbox-marked"></i>
                                <i *ngIf="!estaSeleccionado(agenda.sobreturnos[i])" class="mdi mdi-checkbox-blank-outline"></i>
                            </td>
                            <td (click)="seleccionarTurno(agenda.sobreturnos[i], bloque)">
                                <strong *ngIf="sobreturno">{{ sobreturno.horaInicio | date: 'HH:mm' }}</strong>
                            </td>
                            <td (click)="seleccionarTurno(agenda.sobreturnos[i], -1)">
                                <span *ngIf="sobreturno.paciente && sobreturno.paciente.id">{{ sobreturno.paciente | paciente }} </span>
                                <small>
                                    <span *ngIf="sobreturno.paciente && sobreturno.paciente.id && sobreturno.paciente.documento !== ''">| DNI: {{ sobreturno.paciente.documento | number }}</span>
                                    <span *ngIf="sobreturno.paciente && sobreturno.paciente.id && sobreturno.paciente.documento === ''" class="text-danger">| DNI: Sin documento (temporal)</span>
                                </small>
                                <small>
                                    <span *ngIf="sobreturno.paciente && sobreturno.paciente.id && sobreturno.paciente.carpetaEfectores && sobreturno.paciente.carpetaEfectores.length > 0 && sobreturno.paciente.carpetaEfectores[0].nroCarpeta!=''">
                                        | Nro Carpeta
                                        <span *ngFor="let carpeta of sobreturno.paciente.carpetaEfectores | slice:0:1;">
                                            {{carpeta.nroCarpeta}}
                                            <!-- <plex-text [(ngModel)]="carpeta.nroCarpeta"></plex-text> -->
                                        </span>
                                    </span>
                                </small>
                                <span [ngClass]="{'text-danger': sobreturno.estado === 'suspendido'}" *ngIf="sobreturno && sobreturno.estado === 'suspendido'">Suspendido</span>
                                <span *ngIf="sobreturno && sobreturno.nota">
                                    <i title="{{sobreturno.nota}}" class="text-warning warning mdi mdi-message"></i>
                                </span>
                                <span [ngClass]="{'text-warning': true}" *ngIf="sobreturno?.asistencia === 'asistio' && sobreturno?.diagnostico?.codificaciones[0]?.codificacionAuditoria == null">| Asistencia Verificada</span>
                                <span [ngClass]="{'text-success': true}" *ngIf="sobreturno?.paciente?.id && (sobreturno?.diagnostico?.codificaciones[0]?.codificacionAuditoria != null || (sobreturno?.asistencia && sobreturno?.asistencia !== 'asistio'))">| Auditado</span>

                            </td>
                        </tr>
                    </tbody>
                    <!-- /SOBRETURNOS -->
                </table>
                <div class="row">
                    <div class="col-6">
                        <plex-button type="primary" label="Agregar Sobreturno" (click)="agregarSobreturno()"></plex-button>
                    </div>
                </div>
            </plex-box>
        </div>
        <div class="col-8" *ngIf="turnoSeleccionado && turnoSeleccionado.estado !== 'suspendido' && turnoSeleccionado.estado !== 'turnoDoble'">
            <plex-box>
                <!--REGISTRO DE ASISTENCIA-->
                <header>
                    <div class="clearfix">
                        <div class="page-title">REGISTROS DEL TURNO</div>
                    </div>
                </header>
                <div class="row" *ngIf="turnoSeleccionado && turnoSeleccionado.estado == 'disponible'">
                    <div class="col" *ngIf="paciente?.id">
                        <small>
                            <span *ngIf="paciente.documento !== ''"> DNI {{ paciente.documento | number }}</span>
                            <span *ngIf="paciente.documento === ''" class="text-danger"> Sin documento (temporal)</span>
                        </small>
                        <div *ngIf="paciente?.id"> {{paciente | paciente}}</div>
                    </div>
                    <div class="col" *ngIf="!paciente?.id && !turnoSeleccionado.paciente">
                        <small>
                            <span> No existe un paciente asociado</span>
                        </small>
                    </div>
                    <div class="col" *ngIf="!pacientesSearch">
                        <plex-button type="primary" icon="mdi mdi-calendar-multiple" label="Buscar Paciente" (click)="buscarPaciente()"></plex-button>
                    </div>
                </div>
                <div class="row">
                    <div class="col-6" *ngIf="turnoSeleccionado.paciente?.id">
                        <div *ngIf="turnoSeleccionado.paciente?.id"> {{ turnoSeleccionado.paciente | paciente }}</div>
                        <small>
                            <span *ngIf="turnoSeleccionado.paciente.documento !== ''"> DNI {{ turnoSeleccionado.paciente.documento | number}}</span>
                            <span *ngIf="turnoSeleccionado.paciente.documento === ''"> Sin documento (temporal)</span>
                            <span *ngIf="turnoSeleccionado.paciente.fechaNacimiento !== null">| Edad: {{ turnoSeleccionado.paciente | edad }}</span>
                            <span *ngIf="turnoSeleccionado?.paciente?.id && turnoSeleccionado?.paciente?.sexo">| Sexo: {{ turnoSeleccionado.paciente | sexo }}</span>
                            <span *ngIf="turnoSeleccionado?.paciente?.id && turnoSeleccionado?.paciente?.edad">{{ turno.paciente.fechaNacimiento | date: 'dd/MM/yyyy' }}</span>
                        </small>
                    </div>
                </div>
                <div class="row">
                    <div class="col" *ngIf="pacientesSearch">
                        <div class="panel panel-default">
                            <div class="clear"></div>
                            <pacientesSearch [modoCompleto]="false" (selected)="onReturn($event)"></pacientesSearch>
                        </div>
                    </div>
                </div>
                <div class="row" *ngIf="!turnoSeleccionado.tipoPrestacion && bloqueSeleccionado && paciente?.id">
                    <div class="col-6">
                        <br>
                        <label>Prestación: </label>
                        <plex-select *ngIf="!turnoTipoPrestacion" [(ngModel)]="turnoTipoPrestacion" name="tipoPrestacionTurno" [data]="bloqueSeleccionado.tipoPrestaciones">
                        </plex-select>
                        <div *ngIf="turnoTipoPrestacion">{{turnoTipoPrestacion.nombre}}</div>
                    </div>
                </div>
                <div *ngIf="turnoSeleccionado && (turnoSeleccionado.paciente?.id || paciente?.id) && !pacientesSearch">
                    <div class="row">
                        <div class="col">
                            <!--ASISTENCIA-->
                            <div *ngIf="!existeCodificacionProfesional">
                                <br>
                                <h5>Asistencia</h5>
                                <hr>
                                <div *ngFor="let estado of estadosAsistencia; let i=index">
                                    <td (click)="seleccionarAsistencia(estado)">
                                        <i *ngIf="asistenciaSeleccionada(estado)" class="mdi mdi-checkbox-marked"></i>
                                        <i *ngIf="!asistenciaSeleccionada(estado)" class="mdi mdi-checkbox-blank-outline"></i>
                                    </td>
                                    <td (click)="asistenciaSeleccionada(estado)">
                                        <strong>{{ estado.nombre }}</strong>
                                    </td>
                                </div>
                            </div>
                            <!--/ ASISTENCIA-->
                        </div>
                    </div>
                    <br>

                    <!--CODIFICACION-->

                    <div *ngIf="turnoSeleccionado && turnoSeleccionado.asistencia == 'asistio'">
                        <h5>Codificación</h5>
                        <hr>
                        <div>
                            <div class="row" *ngIf="!existeCodificacionProfesional">
                                <div class="col-4">
                                    <br>
                                    <plex-bool [(ngModel)]='turnoSeleccionado.diagnostico.ilegible' name="ilegible" label="Diagnóstico ilegible" (click)="marcarIlegible()"></plex-bool>
                                </div>

                                <div class="col-8" *ngIf="!turnoSeleccionado.diagnostico.ilegible">
                                    <plex-select [(ngModel)]="nuevoCodigo" label="Nuevo diagnóstico" name="searchCodigo" labelField="codigo+' '+sinonimo" (getData)="buscarCodificacion($event)"
                                        placeholder="Seleccione un ćodigo CIE10" (change)="agregarDiagnostico()"></plex-select>
                                </div>
                                <hr>
                            </div>
                            <div *ngIf="diagnosticos.length>0 && !turnoSeleccionado.diagnostico.ilegible && !showReparo ">

                                <table class="table table-striped">
                                    <tbody>
                                        <tr *ngFor="let diagnostico of diagnosticos; let i = index; " class="hover">
                                            <td *ngIf="existeCodificacionProfesional && diagnostico.codificacionAuditoria == null">
                                                <plex-button icon="mdi mdi-check" title="Aprobar" (click)="aprobar(i)"></plex-button>
                                            </td>
                                            <td *ngIf="existeCodificacionProfesional && diagnostico.codificacionAuditoria && diagnostico.codificacionAuditoria.codigo === diagnostico.codificacionProfesional.codigo">
                                                <span class="badge-success">Aprobado</span>
                                            </td>
                                            <td *ngIf="existeCodificacionProfesional && diagnostico.codificacionAuditoria && diagnostico.codificacionAuditoria != null && diagnostico.codificacionAuditoria.codigo !== diagnostico.codificacionProfesional.codigo">
                                                <span class="badge-success">Reparado</span>
                                            </td>
                                            <td *ngIf="existeCodificacionProfesional">
                                                <plex-button icon="mdi mdi-pencil" title="Reparar" (click)="mostrarReparo(i)"> </plex-button>
                                            </td>
                                            <td *ngIf="diagnostico.codificacionAuditoria == null && diagnostico.codificacionProfesional != null">
                                                {{diagnostico.codificacionProfesional.sinonimo}}
                                            </td>
                                            <td *ngIf="diagnostico.codificacionAuditoria != null">
                                                {{diagnostico.codificacionAuditoria.sinonimo}}
                                            </td>
                                            <td *ngIf="i==0">
                                                <span class="badge-success">Principal</span>
                                            </td>
                                            <td *ngIf="!existeCodificacionProfesional">
                                                <plex-button icon="delete" title="Eliminar" type="danger" (click)="borrarDiagnostico(i)"></plex-button>
                                            </td>
                                            <td *ngIf="i==0 && !existeCodificacionProfesional">
                                                <plex-bool [(ngModel)]='diagnostico.primeraVez' name="primeraVez" label="Primera Vez"></plex-bool>
                                            </td>
                                            <td *ngIf="i==0 && existeCodificacionProfesional">
                                                <span *ngIf="i==0 && diagnostico.primeraVez" class="badge-success">Primera vez</span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Reparo -->
                        <div *ngIf="turnoSeleccionado && existeCodificacionProfesional && showReparo">
                            <div class="row">
                                <div class="col">
                                    <h5>codificación del profesional:</h5> {{diagnosticos[indiceReparo].codificacionProfesional.sinonimo}}
                                    <hr>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-8">
                                    Seleccionar código reparo:
                                    <plex-select [(ngModel)]="reparo" name="searchReparo" labelField="codigo+' '+sinonimo" (getData)="buscarCodificacion($event)"
                                        placeholder="Seleccione un ćodigo CIE10" (change)="repararDiagnostico()"></plex-select>
                                </div>
                                <div class="col">
                                    <br>
                                    <plex-button icon="delete" label="Eliminar Reparo" type="danger" (click)="borrarReparo()"></plex-button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- /Reparo -->

                    <!--/ CODIFICACION-->
                    <br>

                    <div class="row" *ngIf="!showReparo">
                        <div class="col text-right">
                            <plex-button label="Cancelar" type="danger" (click)="cancelar()"></plex-button>
                            <plex-button label="Guardar" type="success" (click)="onSave()"></plex-button>
                        </div>
                    </div>
                </div>

            </plex-box>
        </div>
    </div>
</section>
<footer *ngIf="modoCompleto">
    <div class="row">
        <div class="col text-right">
            <plex-button type="default" label="Volver" (click)="volver()">
            </plex-button>
        </div>
    </div>
</footer>
<sobreturno *ngIf="showAgregarSobreturno" [agenda]="agenda" [revision]="true" (volverRevision)="volverRevision($event)"></sobreturno>
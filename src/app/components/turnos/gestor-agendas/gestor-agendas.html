<plex-layout [main]="main"
             *ngIf="showGestorAgendas && (!showRevisionFueraAgenda && !showCarpetas && !showInsertarAgenda && !showClonar)">
    <plex-layout-main>
        <plex-title titulo="Gestor de Agendas">
            <!--Botones / Acciones-->
            <botones-agenda *ngIf="agendasSeleccionadas?.length > 0 && agendas?.length" class="float-right"
                            [agendasSeleccionadas]="agendasSeleccionadas" (clonarEmit)="clonar()"
                            (agregarNotaAgendaEmit)="agregarNotaAgenda()"
                            (agregarSobreturnoEmit)="agregarSobreturno($event)"
                            (editarAgendaEmit)="editarAgenda($event)"
                            (actualizarEstadoEmit)="actualizarEstadoEmit($event)"
                            (listarTurnosEmit)="listarTurnos($event)" (listarCarpetasEmit)="listarCarpetas($event)"
                            (revisionAgendaEmit)="revisionAgenda($event)"
                            (reasignarTurnosEmit)="reasignarTurnos($event)" [turnosSuspendidos]="turnosSuspendidos">
            </botones-agenda>
        </plex-title>
        <!--Panel de Agendas-->


        <!--Filtros-->
        <div class="row">
            <div class="col-3">
                <plex-datetime type="date" [(ngModel)]="fechaDesde" (change)="refreshSelection($event,'fechaDesde')"
                               name="fechaDesde" label="Desde" class="fechas" [max]="fechaHasta">
                </plex-datetime>
                <!-- <plex-button type="info" icon="chevron-right"></plex-button> -->
            </div>
            <div class="col-3">
                <plex-datetime type="date" [(ngModel)]="fechaHasta" (change)="refreshSelection($event,'fechaHasta')"
                               name="fechaHasta" label="Hasta" class="fechas" [min]="fechaDesde">
                </plex-datetime>
            </div>
            <div class="col-4">
                <plex-select [(ngModel)]="prestaciones" (change)="refreshSelection($event,'prestaciones')"
                             (getData)="loadPrestaciones($event)" name="prestaciones" label="Prestación"
                             ngModelOptions="{standalone: true}">
                </plex-select>
            </div>
            <div class="col-2 d-flex align-items-end justify-content-end">
                <br>
                <plex-button type="info" [icon]="mostrarMasOpciones ? 'chevron-up' : 'chevron-down'"
                             (click)="mostrarMasOpciones = !mostrarMasOpciones"></plex-button>
            </div>
        </div>
        <div class="row" *ngIf="mostrarMasOpciones">
            <div class="col-4">
                <plex-select [(ngModel)]="profesionales" (change)="refreshSelection($event, 'profesionales')"
                             (getData)="loadProfesionales($event)" name="profesionales" label="Equipo de Salud"
                             placeholder="Buscar un equipo de salud" labelField="apellido+' '+nombre"
                             ngModelOptions="{standalone: true}">
                </plex-select>
            </div>
            <div class="col-4">
                <plex-select [(ngModel)]="modelo.espacioFisico" (change)="refreshSelection($event,'espacioFisico')"
                             name="espacioFisico" (getData)="loadEspacios($event)" label="Espacio Físico"
                             placeholder="Buscar un espacio físico"
                             labelField="nombre + ' - ' + (servicio ? servicio.nombre : '' ) + ' (' + edificio ? edificio.descripcion : '' + ')'"
                             ngModelOptions="{standalone: true}">
                </plex-select>
            </div>
            <div class="col-4">
                <plex-select [(ngModel)]="estado" (change)="refreshSelection($event,'estado')"
                             [data]="estadosAgendaArray" name="estado" label="Estado"
                             ngModelOptions="{standalone: true}">
                </plex-select>
            </div>
        </div>
        <!--Resultados-->
        <div *ngIf="!agendas?.length" class="alert alert-default">
            <i class="mdi mdi-emoticon-sad"></i> No hay agendas que coincidan con los filtros de búsqueda
        </div>

        <div class="list-container">
            <table *ngIf="agendas?.length" class="table table-striped table-sm table-lista-agendas h-100">
                <thead>
                    <th class="small"></th>
                    <th>Fecha y Hora</th>
                    <th>Tipos de prestación</th>
                    <th class="text-right estado medium">Estado</th>
                </thead>
                <tbody infiniteScroll [infiniteScrollDistance]="2" [infiniteScrollThrottle]="50" (scrolled)="onScroll()"
                       [scrollWindow]="false">
                    <tr *ngFor="let agenda of agendas; let i=index" class="hover"
                        [ngClass]="{'bg-inverse text-white': estaSeleccionada(this.agenda) >= 0}">
                        <td class="small" (click)="verAgenda(agenda, true, $event)">
                            <i *ngIf="estaSeleccionada(agenda) >= 0" class="mdi mdi-checkbox-marked"></i>
                            <i *ngIf="!(estaSeleccionada(agenda) >= 0)" class="mdi mdi-checkbox-blank-outline"></i>
                        </td>
                        <td (click)="verAgenda(agenda, false, $event)">
                            <div class="datos-agenda">{{agenda.horaInicio | date: 'EEE' | uppercase }}
                                {{agenda.horaInicio | fecha}}
                                <i class="mdi mdi-clock" title="Horario inicio/fin"></i> {{agenda.horaInicio |
                                                date: 'HH:mm'}} a {{agenda.horaFin | date: 'HH:mm'}} hs
                                -
                                <i class="mdi mdi-timelapse" title="Duración"></i> {{
                                                duracionAgenda(agenda.horaInicio, agenda.horaFin) }}
                                <span *ngIf="agenda.nota">
                                    <i title="{{agenda.nota}}" class="mdi mdi-comment"></i>
                                </span>
                            </div>
                            <div>
                                <small *ngIf="agenda.espacioFisico?.nombre">
                                    {{ agenda.espacioFisico.nombre + (agenda.espacioFisico.servicio && agenda.espacioFisico.servicio.nombre
                                                    ?' - ' + agenda.espacioFisico.servicio.nombre : '') +
                                                    (agenda.espacioFisico.edificio?.descripcion
                                                    ? ' (' + agenda.espacioFisico.edificio.descripcion + ')' : '') }}
                                </small>
                                <span *ngIf="!agenda.espacioFisico?.nombre" class="text-danger">
                                    Espacio físico no asignado
                                </span>
                            </div>
                        </td>
                        <td (click)="verAgenda(agenda, false, $event)">
                            <div class="tipo-prestacion" *ngIf="agenda.tipoPrestaciones.length > 0">{{
                                                agenda.tipoPrestaciones | enumerar:['term']:'/' }}</div>
                            <div class="nombres-profesionales">
                                <span *ngIf="!agenda.profesionales?.length" class="text-danger">Equipo de
                                    Salud
                                    no asignado</span>
                                <ng-container *ngIf="agenda.profesionales">
                                    <div *ngIf="agenda.profesionales.length > 0">{{ agenda.profesionales |
                                                        enumerar:['apellido','nombre'] }}</div>
                                </ng-container>
                            </div>
                        </td>
                        <td (click)="verAgenda(agenda, false, $event)" class="text-right align-middle estado medium">
                            <span class="badge badge-info float-right" *ngIf="agenda.dinamica">Dinámica</span>
                            <span class="badge badge-danger float-right" *ngIf="!agenda.nominalizada">No
                                Nominalizada</span>
                            <span
                                  class="badge badge-{{estadosAgenda[agenda.estado]?.class}} float-right">{{estadosAgenda[agenda.estado]?.nombre}}</span>
                            <span class="badge badge-danger bg-danger float-right"
                                  *ngIf=" turnosSuspendidos && turnosSuspendidos[i].count > 0"
                                  title="Hay {{ turnosSuspendidos[i].count | pluralizar:['turno','turnos'] }} a reasignar">
                                <span class="text-white">
                                    <strong>{{ turnosSuspendidos[i].count }}</strong>
                                </span>
                            </span>
                            <span class="badge badge-warning float-right" *ngIf="suspensionAvisada(agenda)">
                                Solicitud de suspensión
                            </span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

    </plex-layout-main>

    <!-- Panel derecho -->
    <plex-layout-sidebar>
        <div class="h-100" *ngIf="agendasSeleccionadas?.length > 0 && !showRevisionFueraAgenda">
            <ng-container *ngIf="showTurnos && agendasSeleccionadas?.length == 1" type="info">
                <turnos [agenda]="agendasSeleccionadas[0]" (reasignaTurno)="reasignaTurno($event)"
                        (recargarAgendas)="loadAgendas($event)"></turnos>
            </ng-container>
            <div *ngIf="showEditarAgendaPanel && agendasSeleccionadas?.length === 1" type="info">
                <panel-agenda [editaAgendaPanel]="agendasSeleccionadas[0]"
                              (showVistaTurnosEmit)="showVistaTurnos($event)"
                              (actualizarEstadoEmit)="actualizarEstadoEmit($event)" (editarEsapcioFisicoEmit)="true"
                              #guardarAgendaPanel></panel-agenda>
            </div>
            <!-- Muestra el panel de Notas de Agendas -->
            <div *ngIf="showAgregarNotaAgenda">
                <nota-agenda (saveAgregarNotaAgenda)="saveAgregarNotaAgenda($event)"
                             (cancelaAgregarNotaAgenda)="cancelaAgregarNotaAgenda($event)"
                             (showVistaTurnos)="showVistaTurnos($event)" [agendasSeleccionadas]="agendasSeleccionadas">
                </nota-agenda>
            </div>
            <!-- Panel Suspender Turno -->
            <div *ngIf="showSuspenderAgenda || showSuspendida">
                <suspender-agenda [agenda]="agenda" (returnSuspenderAgenda)="cerrarSuspenderTurno(agenda)">
                </suspender-agenda>
            </div>
        </div>
    </plex-layout-sidebar>

    <!--Footer-->
    <plex-layout-footer
                        *ngIf="(puedeCrearAgenda || (showEditarAgendaPanel && agendasSeleccionadas?.length === 1)) && !showRevisionFueraAgenda">
        <plex-button position="left" *ngIf="puedeCrearAgenda" class="pr-1" type="primary" label="Crear una nueva agenda"
                     (click)="insertarAgenda()"></plex-button>
        <plex-button position="left" type="primary" label="Auditar fuera de agenda" (click)="auditarFueraAgenda()">
        </plex-button>

    </plex-layout-footer>

    <!-- Operaciones de Turnos -->
    <dar-turnos *ngIf="showDarTurnos" (volverAlGestor)="volverAlGestor($event)"></dar-turnos>

</plex-layout>

<reasignar-turno *ngIf="showReasignarTurno" [agendaAReasignar]="agendasSeleccionadas[0]"
                 (volverAlGestor)="volverAlGestor($event)" class="plex-layout"></reasignar-turno>
<reasignar-turno-agendas *ngIf="showReasignarTurnoAgendas" [agendasSimilares]="agendasSeleccionadas[0]">
</reasignar-turno-agendas>
<!-- Operaciones de Agenda -->
<clonar-agenda *ngIf="showClonar" [agenda]="agendasSeleccionadas[0]" (volverAlGestor)="volverAlGestor($event)">
</clonar-agenda>

<planificar-agenda *ngIf="showInsertarAgenda" (volverAlGestor)="volverAlGestor($event)"></planificar-agenda>
<planificar-agenda *ngIf="showEditarAgenda" [editaAgenda]="agendasSeleccionadas[0]"
                   (volverAlGestor)="volverAlGestor($event)"></planificar-agenda>

<listar-carpetas *ngIf="showCarpetas" [agendasSeleccionadas]="agendasSeleccionadas"
                 (volverAlGestor)="volverAlGestor($event)"></listar-carpetas>
<fuera-agenda *ngIf="showRevisionFueraAgenda" (volverAlGestor)="volverAlGestor($event)"></fuera-agenda>

<listar-turnos *ngIf="showListadoTurnos" [agendas]="agendasSeleccionadas" (volverAlGestor)="volverAlGestor($event)">
</listar-turnos>
<plex-layout>
    <plex-layout-main>
        <plex-title titulo="Ficha COVID 19">
            <plex-button type="danger" (click)="toBack()">Volver
            </plex-button>
        </plex-title>
        <section class="my-3">
            <form #form="ngForm">
                <ng-container *ngFor="let seccion of secciones">
                    <plex-title titulo="{{seccion.name}}" size="sm">
                    </plex-title>
                    <ng-container *ngFor="let field of seccion.fields" [ngSwitch]="field.type">

                        <plex-select *ngIf="field.key==='organizacion';else notOrganizacion "
                                     [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                     [(ngModel)]="seccion.fields[field.key]" [required]="field.required"
                                     [data]="organizaciones$ |async" (change)="setOrganizacion(seccion,$event)">
                        </plex-select>
                        <ng-template #notOrganizacion>
                            <plex-select *ngSwitchCase="'select'" [label]="field.label?field.label:field.key"
                                         grow="auto" name="{{ field.key }}" [(ngModel)]="seccion.fields[field.key]"
                                         [required]="field.required" [ssSearch]="field.resources">
                            </plex-select>
                        </ng-template>
                        <plex-text *ngSwitchCase="'string'" [label]="field.label?field.label:field.key" grow="auto"
                                   name="{{ field.key }}" [(ngModel)]="seccion.fields[field.key]"
                                   [required]="field.required">
                        </plex-text>
                        <plex-datetime *ngSwitchCase="'date'" [label]="field.label?field.label:field.key" grow="auto"
                                       name="{{ field.key }}" [(ngModel)]="seccion.fields[field.key]"
                                       [required]="field.required">
                        </plex-datetime>
                        <plex-phone *ngSwitchCase="'phone'" [label]="field.label?field.label:field.key"
                                    [(ngModel)]="seccion.fields[field.key]" [required]="field.required"
                                    placeholder="Ej: 2990000000" name="{{ field.key }}">
                        </plex-phone>
                        <plex-bool *ngSwitchCase="'boolean'" [label]="field.label?field.label:field.key" grow="auto"
                                   name="{{ field.key }}" [(ngModel)]="seccion.fields[field.key]"
                                   [required]="field.required"></plex-bool>

                        <!--Campos opcionales exclusivos de la ficha covid-->

                        <!--MPI-->

                        <plex-select *ngIf="field.key==='tipoinstitucion' && seccion.fields['resideinstitucion']"
                                     [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                     [(ngModel)]="seccion.fields[field.key]" [data]="tipoInstitucion">
                        </plex-select>
                        <plex-text *ngIf="field.key==='lugarinstitucion' && seccion.fields['resideinstitucion']"
                                   [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                   [(ngModel)]="seccion.fields[field.key]">
                        </plex-text>

                        <!--Clasificación-->

                        <plex-select *ngIf="field.key==='clasificacion' " [label]="field.label?field.label:field.key"
                                     grow="auto" name="{{ field.key }}" [(ngModel)]="seccion.fields[field.key]"
                                     [data]="clasificacion" [required]="field.required">
                        </plex-select>
                        <plex-select *ngIf="field.key==='tipobusqueda' " [label]="field.label?field.label:field.key"
                                     grow="auto" name="{{ field.key }}" [(ngModel)]="seccion.fields[field.key]"
                                     [data]="tipoBusqueda" [required]="field.required">
                        </plex-select>

                        <!--Enfermedades previas-->

                        <plex-grid>
                            <plex-bool *ngIf="field.key==='asma' && seccion.fields['presenta']"
                                       [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                       [(ngModel)]="seccion.fields[field.key]" [required]="field.required">
                            </plex-bool>
                            <plex-bool *ngIf="field.key==='diabetes' && seccion.fields['presenta']"
                                       [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                       [(ngModel)]="seccion.fields[field.key]" [required]="field.required">
                            </plex-bool>
                            <plex-bool *ngIf="field.key==='oncologica' && seccion.fields['presenta']"
                                       [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                       [(ngModel)]="seccion.fields[field.key]" [required]="field.required">
                            </plex-bool>
                            <plex-bool *ngIf="field.key==='renalcondialisis' && seccion.fields['presenta']"
                                       [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                       [(ngModel)]="seccion.fields[field.key]" [required]="field.required">
                            </plex-bool>
                            <plex-bool *ngIf="field.key==='renalsindialisis' && seccion.fields['presenta']"
                                       [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                       [(ngModel)]="seccion.fields[field.key]" [required]="field.required">
                            </plex-bool>
                            <plex-bool *ngIf="field.key==='epoc' && seccion.fields['presenta']"
                                       [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                       [(ngModel)]="seccion.fields[field.key]" [required]="field.required">
                            </plex-bool>
                            <plex-bool *ngIf="field.key==='exfumador' && seccion.fields['presenta']"
                                       [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                       [(ngModel)]="seccion.fields[field.key]" [required]="field.required">
                            </plex-bool>
                            <plex-bool *ngIf="field.key==='fumador' && seccion.fields['presenta']"
                                       [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                       [(ngModel)]="seccion.fields[field.key]" [required]="field.required">
                            </plex-bool>
                            <plex-bool *ngIf="field.key==='hipertension' && seccion.fields['presenta']"
                                       [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                       [(ngModel)]="seccion.fields[field.key]" [required]="field.required">
                            </plex-bool>
                            <plex-bool *ngIf="field.key==='inmunosupresion' && seccion.fields['presenta']"
                                       [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                       [(ngModel)]="seccion.fields[field.key]" [required]="field.required">
                            </plex-bool>
                            <plex-bool *ngIf="field.key==='obesidad' && seccion.fields['presenta']"
                                       [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                       [(ngModel)]="seccion.fields[field.key]" [required]="field.required">
                            </plex-bool>
                        </plex-grid>

                        <!--Información clínica-->

                        <plex-datetime *ngIf="field.key==='fechasintomas'" [label]="field.label?field.label:field.key"
                                       grow="auto" name="{{ field.key }}" [(ngModel)]="seccion.fields[field.key]"
                                       [required]="field.required" (change)="setSemanaEpidemiologica()">
                        </plex-datetime>

                        <plex-text *ngIf="field.key==='semanaepidemiologica'"
                                   [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                   [(ngModel)]="seccion.fields[field.key]" [required]="field.required">
                        </plex-text>

                        <plex-select *ngIf="field.key==='lugarinternado' && seccion.fields['internado']"
                                     [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                     [(ngModel)]="seccion.fields[field.key]" [required]="field.required"
                                     [ssSearch]="field.resources">
                        </plex-select>

                        <plex-datetime *ngIf="field.key==='fechainternacion' && seccion.fields['internado']"
                                       [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                       [(ngModel)]="seccion.fields[field.key]" [required]="field.required">
                        </plex-datetime>
                        <plex-bool *ngIf="field.key==='fallecimientohospital' && seccion.fields['casofallecido']"
                                   [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                   [(ngModel)]="seccion.fields[field.key]" [required]="field.required">
                        </plex-bool>
                        <plex-bool *ngIf="field.key==='fallecimientodomicilio' && seccion.fields['casofallecido']"
                                   [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                   [(ngModel)]="seccion.fields[field.key]" [required]="field.required">
                        </plex-bool>

                        <!--Clasificación y final-->

                        <plex-select *ngIf="field.key==='segundaclasificacion'"
                                     [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                     [(ngModel)]="seccion.fields[field.key]" [required]="field.required"
                                     [data]="segundaClasificacion">
                        </plex-select>
                        <plex-select *ngIf="field.key==='tipomuestra'" [label]="field.label?field.label:field.key"
                                     grow="auto" name="{{ field.key }}" [(ngModel)]="seccion.fields[field.key]"
                                     [required]="field.required" [data]="tipoMuestra">
                        </plex-select>
                        <plex-datetime *ngIf="field.key==='fechamuestra'" [label]="field.label?field.label:field.key"
                                       grow="auto" name="{{ field.key }}" [(ngModel)]="seccion.fields[field.key]"
                                       [required]="field.required">
                        </plex-datetime>
                        <plex-select *ngIf="field.key==='antigeno'" [label]="field.label?field.label:field.key"
                                     grow="auto" name="{{ field.key }}" [(ngModel)]="seccion.fields[field.key]"
                                     [required]="field.required" [data]="resultadoTest" (change)="resultadoFinal()">
                        </plex-select>
                        <plex-select *ngIf="field.key==='pcr'" [label]="field.label?field.label:field.key" grow="auto"
                                     name="{{ field.key }}" [(ngModel)]="seccion.fields[field.key]"
                                     [required]="field.required" [data]="resultadoTest" (change)="resultadoFinal()">
                        </plex-select>
                        <plex-text *ngIf="field.key==='clasificacionfinal'" [label]="field.label?field.label:field.key"
                                   grow="auto" name="{{ field.key }}" [(ngModel)]="seccion.fields[field.key]"
                                   [required]="field.required">
                        </plex-text>

                        <!--Antecedentes epidemiológicos-->

                        <plex-select *ngIf="field.key==='labor' && seccion.fields['personalsalud']"
                                     [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                     [(ngModel)]="seccion.fields[field.key]" [required]="field.required"
                                     [data]="laborPersonalSalud">
                        </plex-select>
                        <plex-select *ngIf="field.key==='funcion' && seccion.fields['personalsalud']"
                                     [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                     [(ngModel)]="seccion.fields[field.key]" [required]="field.required"
                                     [data]="funcionPersonalSalud">
                        </plex-select>
                        <plex-bool *ngIf="field.key==='asistiocasos' && seccion.fields['personalsalud']"
                                   [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                   [(ngModel)]="seccion.fields[field.key]" [required]="field.required">
                        </plex-bool>
                        <plex-select *ngIf="field.key==='lugarasistencia' && seccion.fields['asistiocasos']"
                                     [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                     [(ngModel)]="seccion.fields[field.key]" [required]="field.required"
                                     [data]="organizaciones$ | async">
                        </plex-select>
                        <plex-datetime *ngIf="field.key==='fechaasistencia' && seccion.fields['asistiocasos']"
                                       [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                       [(ngModel)]="seccion.fields[field.key]" [required]="field.required">
                        </plex-datetime>
                        <plex-select *ngIf="field.key==='funcionseguridad' && seccion.fields['personalseguridad']"
                                     [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                     [(ngModel)]="seccion.fields[field.key]" [required]="field.required"
                                     [data]="funcionSeguridad">
                        </plex-select>
                        <plex-text *ngIf="field.key==='comisaria' && seccion.fields['personalseguridad']"
                                   [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                   [(ngModel)]="seccion.fields[field.key]" [required]="field.required">
                        </plex-text>
                        <plex-text *ngIf="field.key==='lugarviaje' && seccion.fields['realizoviajes']"
                                   [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                   [(ngModel)]="seccion.fields[field.key]" [required]="field.required">
                        </plex-text>
                        <plex-datetime *ngIf="field.key==='fechaviaje' && seccion.fields['realizoviajes']"
                                       [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                       [(ngModel)]="seccion.fields[field.key]" [required]="field.required">
                        </plex-datetime>
                        <plex-text *ngIf="field.key==='nombrecompletoconfirmado' && seccion.fields['contactoconconfirmado']"
                                   [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                   [(ngModel)]="seccion.fields[field.key]" [required]="field.required">
                        </plex-text>
                        <plex-text *ngIf="field.key==='dniconfirmado' && seccion.fields['contactoconconfirmado']"
                                   [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                   [(ngModel)]="seccion.fields[field.key]" [required]="field.required">
                        </plex-text>
                        <plex-select *ngIf="field.key==='tipocontactoconfirmado' && seccion.fields['contactoconconfirmado']"
                                     [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                     [(ngModel)]="seccion.fields[field.key]" [required]="field.required"
                                     [data]="tipoContacto">
                        </plex-select>
                        <plex-datetime *ngIf="field.key==='fechacontactoconfirmado' && seccion.fields['contactoconconfirmado']"
                                       [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                       [(ngModel)]="seccion.fields[field.key]" [required]="field.required">
                        </plex-datetime>
                        <plex-select *ngIf="field.key==='lugaratencion' && seccion.fields['recibioatencion']"
                                     [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                     [(ngModel)]="seccion.fields[field.key]" [required]="field.required"
                                     [ssSearch]="'organizaciones'">
                        </plex-select>

                        <plex-datetime *ngIf="field.key==='fechaatencion' && seccion.fields['recibioatencion']"
                                       [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                       [(ngModel)]="seccion.fields[field.key]" [required]="field.required">
                        </plex-datetime>
                    </ng-container>
                    <hr>
                </ng-container>
            </form>
        </section>
    </plex-layout-main>
    <plex-layout-footer>
        <plex-button position="right" type="success" (click)="registrarFicha()" [disabled]="form.invalid">Registrar
            ficha
        </plex-button>
    </plex-layout-footer>
</plex-layout>
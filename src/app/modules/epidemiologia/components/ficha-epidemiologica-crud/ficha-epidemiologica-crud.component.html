<plex-layout>
    <plex-layout-main>
        <plex-title titulo="Ficha {{fichaName}}" main>
            <plex-button type="danger" (click)="toBack()">Volver
            </plex-button>
            <plex-button *ngIf="editFicha" position="right" type="success" (click)="registrarFicha()"
                         [disabled]="form.invalid">
                Registrar
                ficha
            </plex-button>
        </plex-title>
        <section class="my-3">
            <form #form="ngForm">
                <ng-container *ngFor="let seccion of secciones">
                    <plex-title *ngIf="seccion.name==='Contactos Estrechos';else notContactos" size="sm"
                                titulo="{{seccion.name}}">
                        <plex-button *ngIf="editFicha" type="info" size="sm" (click)="showNuevoContacto()">
                            Agregar contacto</plex-button>
                    </plex-title>
                    <ng-template #notContactos>
                        <plex-title titulo="{{seccion.name}}" size="sm">
                        </plex-title>
                    </ng-template>
                    <ng-container *ngFor="let field of seccion.fields" [ngSwitch]="field.type">

                        <plex-select *ngIf="field.key==='organizacion';else notOrganizacion "
                                     [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                     [(ngModel)]="seccion.fields[field.key]" [required]="field.required"
                                     [data]="organizaciones$ |async" (change)="setOrganizacion(seccion,$event)"
                                     [readonly]="!editFicha">
                        </plex-select>
                        <ng-template #notOrganizacion>
                            <plex-select *ngSwitchCase="'select'" [label]="field.label?field.label:field.key"
                                         grow="auto" name="{{ field.key }}" [(ngModel)]="seccion.fields[field.key]"
                                         [required]="field.required" [ssSearch]="field.resources"
                                         [readonly]="!editFicha">
                            </plex-select>
                        </ng-template>
                        <plex-text *ngSwitchCase="'string'" [label]="field.label?field.label:field.key" grow="auto"
                                   name="{{ field.key }}" [(ngModel)]="seccion.fields[field.key]"
                                   [required]="field.required" [readonly]="!editFicha">
                        </plex-text>
                        <plex-datetime *ngSwitchCase="'date'" [label]="field.label?field.label:field.key" grow="auto"
                                       name="{{ field.key }}" [(ngModel)]="seccion.fields[field.key]"
                                       [required]="field.required" [readonly]="!editFicha">
                        </plex-datetime>
                        <plex-phone *ngSwitchCase="'phone'" [label]="field.label?field.label:field.key"
                                    [(ngModel)]="seccion.fields[field.key]" [required]="field.required"
                                    placeholder="Ej: 2990000000" name="{{ field.key }}" [readonly]="!editFicha">
                        </plex-phone>
                        <plex-bool *ngSwitchCase="'boolean'" [label]="field.label?field.label:field.key" grow="auto"
                                   name="{{ field.key }}" [(ngModel)]="seccion.fields[field.key]"
                                   [required]="field.required" [readonly]="!editFicha"></plex-bool>

                        <!--Campos opcionales exclusivos de la ficha covid-->

                        <!--MPI-->

                        <plex-select *ngIf="field.key==='tipoinstitucion' && seccion.fields['resideinstitucion']"
                                     [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                     [(ngModel)]="seccion.fields[field.key]" [data]="tipoInstitucion"
                                     [readonly]="!editFicha">
                        </plex-select>
                        <plex-text *ngIf="field.key==='lugarinstitucion' && seccion.fields['resideinstitucion']"
                                   [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                   [(ngModel)]="seccion.fields[field.key]" [readonly]="!editFicha">
                        </plex-text>

                        <!--Clasificación-->

                        <plex-select *ngIf="field.key==='clasificacion' " [label]="field.label?field.label:field.key"
                                     grow="auto" name="{{ field.key }}" [(ngModel)]="seccion.fields[field.key]"
                                     [data]="clasificacion" [required]="field.required" [readonly]="!editFicha">
                        </plex-select>
                        <plex-select *ngIf="field.key==='tipobusqueda' " [label]="field.label?field.label:field.key"
                                     grow="auto" name="{{ field.key }}" [(ngModel)]="seccion.fields[field.key]"
                                     [data]="tipoBusqueda" [required]="field.required" [readonly]="!editFicha">
                        </plex-select>

                        <!--Enfermedades previas-->

                        <plex-grid>
                            <plex-bool *ngIf="field.key==='asma' && seccion.fields['presenta']"
                                       [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                       [(ngModel)]="seccion.fields[field.key]" [required]="field.required"
                                       [readonly]="!editFicha">
                            </plex-bool>
                            <plex-bool *ngIf="field.key==='diabetes' && seccion.fields['presenta']"
                                       [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                       [(ngModel)]="seccion.fields[field.key]" [required]="field.required"
                                       [readonly]="!editFicha">
                            </plex-bool>
                            <plex-bool *ngIf="field.key==='oncologica' && seccion.fields['presenta']"
                                       [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                       [(ngModel)]="seccion.fields[field.key]" [required]="field.required"
                                       [readonly]="!editFicha">
                            </plex-bool>
                            <plex-bool *ngIf="field.key==='renalcondialisis' && seccion.fields['presenta']"
                                       [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                       [(ngModel)]="seccion.fields[field.key]" [required]="field.required"
                                       [readonly]="!editFicha">
                            </plex-bool>
                            <plex-bool *ngIf="field.key==='renalsindialisis' && seccion.fields['presenta']"
                                       [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                       [(ngModel)]="seccion.fields[field.key]" [required]="field.required"
                                       [readonly]="!editFicha">
                            </plex-bool>
                            <plex-bool *ngIf="field.key==='epoc' && seccion.fields['presenta']"
                                       [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                       [(ngModel)]="seccion.fields[field.key]" [required]="field.required"
                                       [readonly]="!editFicha">
                            </plex-bool>
                            <plex-bool *ngIf="field.key==='exfumador' && seccion.fields['presenta']"
                                       [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                       [(ngModel)]="seccion.fields[field.key]" [required]="field.required"
                                       [readonly]="!editFicha">
                            </plex-bool>
                            <plex-bool *ngIf="field.key==='fumador' && seccion.fields['presenta']"
                                       [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                       [(ngModel)]="seccion.fields[field.key]" [required]="field.required"
                                       [readonly]="!editFicha">
                            </plex-bool>
                            <plex-bool *ngIf="field.key==='hipertension' && seccion.fields['presenta']"
                                       [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                       [(ngModel)]="seccion.fields[field.key]" [required]="field.required"
                                       [readonly]="!editFicha">
                            </plex-bool>
                            <plex-bool *ngIf="field.key==='inmunosupresion' && seccion.fields['presenta']"
                                       [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                       [(ngModel)]="seccion.fields[field.key]" [required]="field.required"
                                       [readonly]="!editFicha">
                            </plex-bool>
                            <plex-bool *ngIf="field.key==='obesidad' && seccion.fields['presenta']"
                                       [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                       [(ngModel)]="seccion.fields[field.key]" [required]="field.required"
                                       [readonly]="!editFicha">
                            </plex-bool>
                        </plex-grid>

                        <!--Información clínica-->

                        <plex-datetime *ngIf="field.key==='fechasintomas'" [label]="field.label?field.label:field.key"
                                       grow="auto" name="{{ field.key }}" [(ngModel)]="seccion.fields[field.key]"
                                       [required]="field.required" (change)="setSemanaEpidemiologica()"
                                       [readonly]="!editFicha">
                        </plex-datetime>

                        <plex-text *ngIf="field.key==='semanaepidemiologica'"
                                   [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                   [(ngModel)]="seccion.fields[field.key]" [required]="field.required"
                                   [readonly]="!editFicha">
                        </plex-text>

                        <plex-select *ngIf="field.key==='lugarinternado' && seccion.fields['internado']"
                                     [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                     [(ngModel)]="seccion.fields[field.key]" [required]="field.required"
                                     [ssSearch]="field.resources" [readonly]="!editFicha">
                        </plex-select>

                        <plex-datetime *ngIf="field.key==='fechainternacion' && seccion.fields['internado']"
                                       [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                       [(ngModel)]="seccion.fields[field.key]" [required]="field.required"
                                       [readonly]="!editFicha">
                        </plex-datetime>
                        <plex-bool *ngIf="field.key==='fallecimientohospital' && seccion.fields['casofallecido']"
                                   [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                   [(ngModel)]="seccion.fields[field.key]" [required]="field.required"
                                   [readonly]="!editFicha">
                        </plex-bool>
                        <plex-bool *ngIf="field.key==='fallecimientodomicilio' && seccion.fields['casofallecido']"
                                   [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                   [(ngModel)]="seccion.fields[field.key]" [required]="field.required"
                                   [readonly]="!editFicha">
                        </plex-bool>

                        <!--Clasificación y final-->

                        <plex-select *ngIf="field.key==='segundaclasificacion'"
                                     [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                     [(ngModel)]="seccion.fields[field.key]" [required]="field.required"
                                     [data]="segundaClasificacion" (change)="resultadoFinal()" [readonly]="!editFicha">
                        </plex-select>
                        <plex-select *ngIf="field.key==='tipomuestra'" [label]="field.label?field.label:field.key"
                                     grow="auto" name="{{ field.key }}" [(ngModel)]="seccion.fields[field.key]"
                                     [required]="field.required" [data]="tipoMuestra" [readonly]="!editFicha">
                        </plex-select>
                        <plex-datetime *ngIf="field.key==='fechamuestra'" [label]="field.label?field.label:field.key"
                                       grow="auto" name="{{ field.key }}" [(ngModel)]="seccion.fields[field.key]"
                                       [required]="field.required" [readonly]="!editFicha">
                        </plex-datetime>
                        <plex-select *ngIf="field.key==='antigeno'" [label]="field.label?field.label:field.key"
                                     grow="auto" name="{{ field.key }}" [(ngModel)]="seccion.fields[field.key]"
                                     [required]="field.required" [data]="resultadoTest" (change)="resultadoFinal()"
                                     [readonly]="!editFicha">
                        </plex-select>
                        <plex-select *ngIf="field.key==='pcr'" [label]="field.label?field.label:field.key" grow="auto"
                                     name="{{ field.key }}" [(ngModel)]="seccion.fields[field.key]"
                                     [required]="field.required" [data]="resultadoTest" (change)="resultadoFinal()"
                                     [readonly]="!editFicha">
                        </plex-select>
                        <plex-text *ngIf="field.key==='clasificacionfinal'" [label]="field.label?field.label:field.key"
                                   grow="auto" name="{{ field.key }}" [(ngModel)]="seccion.fields[field.key]"
                                   [required]="field.required" [readonly]="!editFicha">
                        </plex-text>

                        <!--Antecedentes epidemiológicos-->

                        <plex-select *ngIf="field.key==='labor' && seccion.fields['personalsalud']"
                                     [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                     [(ngModel)]="seccion.fields[field.key]" [required]="field.required"
                                     [data]="laborPersonalSalud" [readonly]="!editFicha">
                        </plex-select>
                        <plex-select *ngIf="field.key==='funcion' && seccion.fields['personalsalud']"
                                     [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                     [(ngModel)]="seccion.fields[field.key]" [required]="field.required"
                                     [data]="funcionPersonalSalud" [readonly]="!editFicha">
                        </plex-select>
                        <plex-bool *ngIf="field.key==='asistiocasos' && seccion.fields['personalsalud']"
                                   [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                   [(ngModel)]="seccion.fields[field.key]" [required]="field.required"
                                   [readonly]="!editFicha">
                        </plex-bool>
                        <plex-select *ngIf="field.key==='lugarasistencia' && seccion.fields['asistiocasos']"
                                     [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                     [(ngModel)]="seccion.fields[field.key]" [required]="field.required"
                                     [data]="organizaciones$ | async" [readonly]="!editFicha">
                        </plex-select>
                        <plex-datetime *ngIf="field.key==='fechaasistencia' && seccion.fields['asistiocasos']"
                                       [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                       [(ngModel)]="seccion.fields[field.key]" [required]="field.required"
                                       [readonly]="!editFicha">
                        </plex-datetime>
                        <plex-select *ngIf="field.key==='funcionseguridad' && seccion.fields['personalseguridad']"
                                     [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                     [(ngModel)]="seccion.fields[field.key]" [required]="field.required"
                                     [data]="funcionSeguridad" [readonly]="!editFicha">
                        </plex-select>
                        <plex-text *ngIf="field.key==='comisaria' && seccion.fields['personalseguridad']"
                                   [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                   [(ngModel)]="seccion.fields[field.key]" [required]="field.required"
                                   [readonly]="!editFicha">
                        </plex-text>
                        <plex-text *ngIf="field.key==='lugarviaje' && seccion.fields['realizoviajes']"
                                   [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                   [(ngModel)]="seccion.fields[field.key]" [required]="field.required"
                                   [readonly]="!editFicha">
                        </plex-text>
                        <plex-datetime *ngIf="field.key==='fechaviaje' && seccion.fields['realizoviajes']"
                                       [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                       [(ngModel)]="seccion.fields[field.key]" [required]="field.required"
                                       [readonly]="!editFicha">
                        </plex-datetime>
                        <plex-text *ngIf="field.key==='nombrecompletoconfirmado' && seccion.fields['contactoconconfirmado']"
                                   [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                   [(ngModel)]="seccion.fields[field.key]" [required]="field.required"
                                   [readonly]="!editFicha">
                        </plex-text>
                        <plex-text *ngIf="field.key==='dniconfirmado' && seccion.fields['contactoconconfirmado']"
                                   [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                   [(ngModel)]="seccion.fields[field.key]" [required]="field.required"
                                   [readonly]="!editFicha">
                        </plex-text>
                        <plex-select *ngIf="field.key==='tipocontactoconfirmado' && seccion.fields['contactoconconfirmado']"
                                     [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                     [(ngModel)]="seccion.fields[field.key]" [required]="field.required"
                                     [data]="tipoContacto" [readonly]="!editFicha">
                        </plex-select>
                        <plex-datetime *ngIf="field.key==='fechacontactoconfirmado' && seccion.fields['contactoconconfirmado']"
                                       [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                       [(ngModel)]="seccion.fields[field.key]" [required]="field.required"
                                       [readonly]="!editFicha">
                        </plex-datetime>
                        <plex-select *ngIf="field.key==='lugaratencion' && seccion.fields['recibioatencion']"
                                     [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                     [(ngModel)]="seccion.fields[field.key]" [required]="field.required"
                                     [ssSearch]="'organizaciones'" [readonly]="!editFicha">
                        </plex-select>

                        <plex-datetime *ngIf="field.key==='fechaatencion' && seccion.fields['recibioatencion']"
                                       [label]="field.label?field.label:field.key" grow="auto" name="{{ field.key }}"
                                       [(ngModel)]="seccion.fields[field.key]" [required]="field.required"
                                       [readonly]="!editFicha">
                        </plex-datetime>

                        <!--Datos de contactos estrechos-->
                        <div *ngIf="field.key==='tablacontactos'">
                            <plex-table [columns]="columns" #table="plTable">
                                <plex-table-columns>
                                </plex-table-columns>
                                <tr *ngFor="let contacto of contactosEstrechos">
                                    <td *plTableCol="'apellidoNombre'">{{contacto.apellidoNombre}}</td>
                                    <td *plTableCol="'dni'">{{contacto.dni}}</td>
                                    <td *plTableCol="'telefono'">{{contacto.telefono}}</td>
                                    <td *plTableCol="'domicilio'">{{contacto.domicilio}}</td>
                                    <td *plTableCol="'fechaContacto'">{{contacto.fechaUltimoContacto | fecha}}</td>
                                    <td *plTableCol="'tipoContacto'">{{contacto.tipoContacto.nombre}}</td>
                                    <td *plTableCol="'acciones'">
                                        <plex-icon *ngIf="editFicha" size="xl" type="danger" name="delete"
                                                   (click)="deleteContacto(contacto)" class="hover"></plex-icon>
                                    </td>
                                </tr>
                                <tr *ngIf="nuevoContacto">
                                    <td *plTableCol="'apellidoNombre'">
                                        <plex-text name="apellidoNombre" [(ngModel)]="contacto.apellidoNombre"
                                                   [readonly]="!editFicha">
                                        </plex-text>
                                    </td>
                                    <td *plTableCol="'dni'">
                                        <plex-text name="dni" [(ngModel)]="contacto.dni" [readonly]="!editFicha">
                                        </plex-text>
                                    </td>
                                    <td *plTableCol="'telefono'">
                                        <plex-phone name="telefono" [(ngModel)]="contacto.telefono"
                                                    [readonly]="!editFicha">
                                        </plex-phone>
                                    </td>
                                    <td *plTableCol="'domicilio'">
                                        <plex-text name="domicilio" [(ngModel)]="contacto.domicilio"
                                                   [readonly]="!editFicha">
                                        </plex-text>
                                    </td>
                                    <td *plTableCol="'fechaContacto'">
                                        <plex-datetime name="fechaContacto" [(ngModel)]="contacto.fechaUltimoContacto"
                                                       [readonly]="!editFicha">
                                        </plex-datetime>
                                    </td>
                                    <td *plTableCol="'tipoContacto'">
                                        <plex-select name="tipoContacto" [(ngModel)]="contacto.tipoContacto"
                                                     [data]="tipoContacto" [readonly]="!editFicha">
                                        </plex-select>
                                    </td>
                                    <td *plTableCol="'acciones'">
                                        <plex-icon size=" xl" type="success" name="mas" class="hover"
                                                   (click)="addContacto()">
                                        </plex-icon>
                                    </td>
                                </tr>
                            </plex-table>
                        </div>
                    </ng-container>
                    <hr>
                </ng-container>
            </form>
        </section>
    </plex-layout-main>
</plex-layout>
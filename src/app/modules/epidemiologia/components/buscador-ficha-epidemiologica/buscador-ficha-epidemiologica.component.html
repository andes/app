<plex-layout [main]="showFicha || pacienteSelected ? 12 : 8">
    <plex-layout-main *ngIf="!showFicha; else elseFicha">
        <plex-title titulo="Fichas epidemiologicas">
        </plex-title>
        <plex-grid type="full" size="lg">
            <plex-detail justify="center" *ngIf="pacienteSelected">
                <img [mpiFotoPaciente]="pacienteSelected" />
                <div title>{{ pacienteSelected | nombre }}</div>
                <div subtitle>{{ (pacienteSelected.documento | number) || 'Sin DNI'}}
                    <plex-button class="d-block" label="buscar otro paciente" size="sm" type="info"
                                 (click)="resetPacienteSelected()">
                    </plex-button>
                </div>
            </plex-detail>
            <plex-wrapper>
                <plex-datetime grow="1" [(ngModel)]="fechaDesde" name="fechaDesde" label="Desde" [max]="fechaHasta">
                </plex-datetime>
                <plex-datetime grow="1" [(ngModel)]="fechaHasta" name="fechaHasta" label="Hasta" [min]="fechaDesde">
                </plex-datetime>
                <plex-select grow="1" [(ngModel)]="typeFicha" label="Tipo de ficha" [data]="dataType$ | async"
                             labelField="name" name="selectType">
                </plex-select>
                <plex-select grow="1" name="localidades" [data]="localidades$ | async" label="Localidad de Residencia"
                             [(ngModel)]="localidad">
                </plex-select>
                <plex-select grow="1" name="organizacion" tmOrganizaciones label="Efectores" [(ngModel)]="organizacion">
                </plex-select>
                <plex-select grow="1" name="zonaSanitaria" [data]="zonaSanitaria$ | async"
                             label="Zona Sanitaria Efector" [(ngModel)]="zonaSanitaria" labelField="nombre">
                </plex-select>
                <plex-text grow="1" label="Identificador PCR" name="idPcr" [(ngModel)]="idPcr">
                </plex-text>
                <plex-button type="success" size="md" label="Buscar Fichas" (click)="searchFichas()">
                </plex-button>
            </plex-wrapper>
        </plex-grid>
        <plex-table *ngIf="listado?.length && !inProgress" [columns]="columns" #table="plTable" (scroll)="onScroll()"
                    [offset]="221">
            <plex-table-columns>
            </plex-table-columns>
            <tr *ngFor="let ficha of (fichas$| plSort:table| async )">
                <td *plTableCol="'fecha'">{{ficha.createdAt | fecha}}</td>
                <td *plTableCol="'documento'">{{ficha.paciente.documento}}</td>
                <td *plTableCol="'paciente'">{{ficha.paciente.apellido}} {{ficha.paciente.nombre}}</td>
                <td *plTableCol="'tipo'">{{ficha.type.name}}</td>
                <td *plTableCol="'acciones'">
                    <plex-button *ngIf="puedeEditar" type="warning" icon="pencil" size="sm"
                                 (click)="editarFicha(ficha)">
                    </plex-button>
                    <plex-button *ngIf="puedeVer" type="success" icon="eye" size="sm" (click)="verFicha(ficha)">
                    </plex-button>
                </td>
            </tr>
        </plex-table>
        <div *ngIf="!(fichas$ | async)?.length && !inProgress" class="h-50" justify="center">
            <plex-label class="flex-column" icon="magnify" type="info" size="xl" direction="column"
                        [titulo]="query?'No hay resultados': 'Realice una búsqueda'"
                        subtitulo="Complete los filtros deseados y/o busque por paciente en el panel lateral y presione Buscar Fichas">
            </plex-label>
        </div>
    </plex-layout-main>
    <plex-layout-sidebar type="invert">
        <plex-title titulo="Búsqueda de fichas por paciente">
        </plex-title>
        <plex-label titulo="Buscar Paciente"></plex-label>
        <paciente-buscar (searchEnd)="searchEnd($event)" (searchClear)="onSearchClear()">
        </paciente-buscar>
        <paciente-listado *ngIf="resultadoBusqueda?.length && !pacienteSelected" [pacientes]="resultadoBusqueda"
                          (selected)="onSelect($event)">
        </paciente-listado>
        <div *ngIf="!pacienteSelected" class="h-75" justify="center">
            <plex-label class="flex-column" icon="magnify" type="info" size="xl" direction="column"
                        titulo="Buscar por DNI, Nombre o Apellido"
                        subtitulo="Seleccione un paciente y presione en Buscar Fichas">
            </plex-label>
        </div>
    </plex-layout-sidebar>
    <ng-template #elseFicha>
        <plex-layout-main>
            <app-ficha-epidemiologica-crud [paciente]="paciente" [fichaPaciente]="fichaPaciente" [editFicha]="editFicha"
                                           (volver)="volver()" [fichaName]="showFicha">
            </app-ficha-epidemiologica-crud>
        </plex-layout-main>
    </ng-template>
</plex-layout>
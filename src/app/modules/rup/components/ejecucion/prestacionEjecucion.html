<!-- Header de paciente -->
<header *ngIf="prestacion && prestacion?.id">
    <header-paciente *ngIf="paciente" (evtData)="cambioDePaciente($event)" [cambiarPaciente]="false" [paciente]="paciente"></header-paciente>
</header>
<form class="plex-layout" #form="ngForm" *ngIf="!showCambioPaciente">
    <!-- Sección principal -->
    <section class="plex-layout prestacionEjecucion" *ngIf="!showCambioPaciente && prestacion && showPrestacion">
        <div class="row">

            <!-- Panel Principal -->
            <div class="col-8">
                <plex-box>
                    <header>
                        <div class="row">
                            <div class="col-9 page-title titulo-consulta">
                                {{prestacion.solicitud.tipoPrestacion.term}} -
                                <span>{{prestacion.solicitud.fecha | date: 'EEE dd/M/yyyy'}}</span>
                            </div>
                            <div class="col-3 float-right text-right">
                                <plex-button icon="information-outline" type="info" class="" title="Ver Información de la Solicitud" *ngIf="!showDatosSolicitud" (click)="mostrarDatosSolicitud(true)"></plex-button>
                                <plex-button icon="information" type="info" class="" title="Ver Registros de la Solicitud" *ngIf="showDatosSolicitud" (click)="mostrarDatosSolicitud(false)"></plex-button>
                            </div>
                        </div>
                    </header>

                    <!-- div de la info de la solicitud -->
                    <div [hidden]="!showDatosSolicitud">
                        <!-- <h3> {{prestacion.solicitud.tipoPrestacion.term}} </h3> -->
                        <p>
                            <b>Solicitada por el profesional:</b> {{prestacion.solicitud.profesional | profesional }}
                            <br>
                            <b>Desde la Organización:</b> {{prestacion.solicitud.organizacion.nombre}}
                            <br>
                            <b>Fecha:</b> {{prestacion.solicitud.fecha | date}}
                        </p>
                        <p *ngIf="prestacion.solicitud.prestacionOrigen">
                            Prestación de origen: {{prestacion.solicitud.prestacionOrigen}}
                        </p>
                    </div>


                    <tabs [options]="{dragScroll: false, trim: 30, fixFirstOnScroll: true , canClose: true , tabFixed: true}" [hidden]="showDatosSolicitud" (_tab)="cerrartab($event)">
                        <!-- <div class="float-right">
                            <a href="javascript:void(0);" (click)="colapsarTodos()" class="btn btn-sm btn-primary">
                                <i class="mdi mdi-chevron-down"></i>
                            </a>
                        </div> -->
                        <tab [tabTitle]="(prestacion.ejecucion.registros && prestacion.ejecucion.registros.length) ? 'Registros de esta consulta (' + prestacion.ejecucion.registros.length + ')' : 'Registros de esta consulta '">
                            <!-- Area droppable de la consulta -->
                            <div *ngIf="!transformarProblema" droppable [dropScope]="'registros-rup'" [dragOverClass]="'drag-target-border'" (onDrop)="onConceptoDrop($event)" class="droppable drop-area" [hidden]="!isDraggingConcepto">
                                <p>
                                    Arrastre aquí para vincularlos a esta consulta
                                </p>
                            </div>
                            <!-- Registros de la prestación -->
                            <div *ngIf="prestacion.ejecucion && prestacion.ejecucion.registros && prestacion.ejecucion.registros.length && !showDatosSolicitud && itemsRegistros && !transformarProblema">
                                <ng-container *ngFor="let registro of prestacion.ejecucion.registros; let i = index">
                                    <!-- Drop area -->
                                    <div droppable [dropScope]="'orden-registros-rup'" (onDrop)="moverRegistro(i, $event)" [dragOverClass]="'drop-posicion-hover'" [hidden]="!isDraggingRegistro" class="drop-posicion" *ngIf="posicionOnDrag !== i && registroOnDrag !== registro?.concepto.conceptId">
                                        Mover a esta posición
                                    </div>

                                    <!-- Contenedor del registro RUP -->
                                    <div droppable [dropScope]="'vincular-registros-rup'" (onDrop)="vincularRegistros($event, registro)" [dragOverClass]="'drag-target-border'" [ngClass]="{'relacionado': registro?.relacionadoCon}">
                                        <div class="rup-card {{registro.concepto.semanticTag}}" [ngClass]="{ 'planes': registro.esSolicitud === true }">

                                            <div class="type drag-handle " draggable [dragScope]="['orden-registros-rup', 'vincular-registros-rup', 'borrar-registros-rup']" [dragOverClass]="'drag-target-border'" [dragData]="registro" (onDragStart)="draggingRegistro(i ,registro, true)" (onDragEnd)="draggingRegistro(i, registro, false)">
                                                <i class="drag-orden mdi mdi-drag-vertical" aria-hidden="true"></i>
                                            </div>

                                            <div class="rup-content" (click)="recuperaLosMasFrecuentes(registro.concepto)">
                                                <!-- ... Header -->
                                                <div class="header">
                                                    <div class="title">
                                                        {{registro.nombre}}

                                                        <!-- vinculacion / desvinculacion -->
                                                        <div class="vinculadoCon" *ngIf="registro.relacionadoCon && registro.relacionadoCon.length > 0 && !confirmarDesvincular[registro.id] && (!confirmarEliminar || (confirmarEliminar && indexEliminar != i))">

                                                            <span class="badge badge-info">
                                                                {{registro.relacionadoCon[0].concepto.term}}
                                                            </span>

                                                            <a href="javascript:void(0);" (click)="desvincular(registro, registro.relacionadoCon[0])" class="desvincular" *ngIf="registro.relacionadoCon && registro.relacionadoCon.length > 0 && !confirmarDesvincular[i] && !confirmarEliminar && !registro.valor.origen"
                                                                title="Desvincular" class="btn btn-sm btn-primary">
                                                                <i class="mdi mdi-link-variant-off"></i>
                                                            </a>
                                                        </div>
                                                    </div>

                                                    <div class="actions" *ngIf="!confirmarDesvincular[registro.id] && (!confirmarEliminar || (confirmarEliminar && indexEliminar != i) )">


                                                        <a href="javascript:void(0);" title="Quitar de la consulta" (click)="confirmarEliminarRegistro(registro, 'card')" class="btn btn-sm btn-danger desvincular float-right">
                                                            <i class="mdi mdi-delete"></i>
                                                        </a>
                                                        <a href="javascript:void(0);" title="Transformar Hallazgo" (click)="iniciaTransformarProblema(registro)" class="btn btn-sm btn-primary desvincular float-right" *ngIf="registro.concepto.semanticTag == 'hallazgo' || registro.concepto.semanticTag == 'trastorno'">
                                                            <i class="mdi mdi-vector-difference-ba"></i>
                                                        </a>
                                                        <ng-container *ngIf="prestacion?.ejecucion?.registros !== null && prestacion?.ejecucion?.registros?.length > 1">
                                                            <plex-dropdown type="primary" class="dropdown-inline" [right]="true" icon="link-variant" (click)="cargaItems(registro, i)" [items]="itemsRegistros[registro.id]?.items" title="Vincular registro"></plex-dropdown>

                                                            <span *ngIf="registro?.valor?.estado && registro.valor?.estado !== 'transformado'">
                                                            </span>
                                                        </ng-container>
                                                        <a href="javascript:void(0);" (click)="cambiaValorCollapse(registro.id)" class="btn btn-sm btn-primary">
                                                            <i class="mdi mdi-chevron-down"></i>
                                                        </a>

                                                    </div>
                                                </div>

                                                <!-- ... Body -->
                                                <div class="rup-body " [hidden]="itemsRegistros[registro.id]?.collapse || confirmarEliminar || confirmarDesvincular[registro.id]" *ngIf="paciente">
                                                    <div *ngIf="mostrarMensajes && !registro.valido">
                                                        <span class="badge badge-danger">
                                                            Debe completar los datos
                                                        </span>
                                                    </div>

                                                    <!-- RUP Loader  (change)="prestacionChanged()"-->
                                                    <rup [elementoRUP]="elementosRUPService.buscarElemento(registro.concepto, registro.esSolicitud)" [prestacion]="prestacion" [paciente]="paciente" [registro]="registro" [soloValores]="false">
                                                    </rup>
                                                </div>

                                                <!-- ... Footer -->
                                                <div class="rup-footer" *ngIf="registro.relacionadoCon || confirmarEliminar">
                                                    <div class="text-center">
                                                        <div class="relacionadoCon">

                                                            <div *ngIf="registro.relacionadoCon && registro.relacionadoCon.length > 0 && confirmarDesvincular[registro.id]" class="confirmarDesvincular">
                                                                ¿Confirmar desvinculación con
                                                                <b>{{registro.relacionadoCon[0].concepto.term}}</b>?

                                                                <div class="buttons">
                                                                    <a href="javascript:void(0);" (click)="cancelarDesvincular(registro.id)" class="btn btn-default">
                                                                        Cancelar
                                                                    </a>

                                                                    <a href="javascript:void(0);" (click)="confirmarDesvinculacion(registro.id, i)" class="btn btn-success">
                                                                        Desvincular
                                                                    </a>
                                                                </div>
                                                            </div>

                                                            <div *ngIf="confirmarEliminar && scopeEliminar === 'card' && indexEliminar == i" class="confirmarDesvincular">
                                                                <div>¿Quitar de esta consulta?</div>
                                                                <div class="buttons">
                                                                    <plex-button type=" btn-danger btn-sm" label="Cancelar" (click)="confirmarEliminar = false;" class="hover">
                                                                    </plex-button>
                                                                    <plex-button type=" btn-success btn-sm" label="Confirmar" (click)="eliminarRegistro()" class="confirm hover">
                                                                    </plex-button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                            </div>
                                        </div>
                                    </div>
                                </ng-container>

                                <!-- Drop area -->
                                <div droppable [dropScope]="'orden-registros-rup'" (onDrop)="moverRegistro(registros.length, $event)" [dragOverClass]="'drop-posicion-hover'" [hidden]="!isDraggingRegistro" class="drop-posicion" *ngIf="registros && registros.length && registros.length !== posicionOnDrag">
                                    Mover a esta posición
                                </div>
                            </div>

                            <div *ngIf="transformarProblema">
                                <div class="rup-card">
                                    <div class="rup-content">
                                        <!-- ... Header -->
                                        <div class="header">
                                            <div class="title">
                                                Transformar problema: {{registroATransformar.nombre}}
                                            </div>
                                        </div>
                                        <div class="rup-body">
                                            <div droppable [dropScope]="'registros-rup'" [dragOverClass]="'drag-target-border'" (onDrop)="ConfirmaTransformar($event)" class="droppable drop-area">
                                                <p>
                                                    Arrastre aquí el nuevo Hallazgo
                                                </p>
                                            </div>
                                        </div>
                                        <div class="rup-footer">
                                            <a href="javascript:void(0);" (click)="cancelarTransformacion()" class="confirm btn btn-danger">
                                                Cancelar
                                            </a>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </tab>
                        <ng-container *ngIf="registrosHuds">
                            <ng-container *ngFor="let registro of registrosHuds; let i = index">
                                <tab [tabTitle]="registro.data.concepto.term" [class]="registro.data.class" *ngIf="registro.tipo === 'hallazgo'">
                                    <rup [paciente]="prestacion.paciente" [elementoRUP]="elementosRUPService.buscarElemento(registro.data.concepto, registro.data.esSolicitud)" [prestacion]="prestacion" [registro]="registro.data" [soloValores]="true">
                                    </rup>
                                </tab>

                                <tab [tabTitle]="registro.data.solicitud.tipoPrestacion.term" [class]="registro.data.class" *ngIf="registro.tipo === 'prestacion'">
                                    <h4>{{ registro.data.solicitud.tipoPrestacion.term }}</h4>
                                    <div class="row">
                                        <div class="col-12">
                                            <b>Fecha: </b>
                                            <br> {{registro.data.solicitud.fecha | date: 'EEE dd/MM/yyyy'}}
                                        </div>
                                        <div class="col-12">
                                            <b>Solicitada por el profesional: </b>
                                            <br> {{ registro.data.solicitud.profesional | profesional }}
                                        </div>
                                        <div class="col-12">
                                            <b>Desde la Organización: </b>
                                            <br> {{ registro.data.solicitud.organizacion.nombre }}
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-12">
                                            <hr>
                                            <h4>Registros de la consulta:</h4>
                                            <ng-container *ngFor="let elemento of registro.data.ejecucion.registros; let i = index">

                                                <div class="rup-card {{elemento.concepto.semanticTag}} {{ elemento.esSolicitud ? 'plan' : elemento.concepto.semanticTag }}">
                                                    <div class="type">
                                                    </div>
                                                    <div class="rup-content">
                                                        <div class="rup-body">
                                                            <div class="row">
                                                                <div class="col-3">
                                                                    <b *ngIf="elemento?.nombre">
                                                                        {{elemento.nombre[0].toUpperCase() + elemento.nombre.slice(1)}}
                                                                    </b>
                                                                    <br>
                                                                    <div class="small text-secondary text-truncate" *ngIf="elemento?.valor?.evolucion">{{ elemento?.valor?.evolucion }}</div>
                                                                </div>
                                                                <div class="col-8">
                                                                    <rup [paciente]="paciente" [elementoRUP]="elementosRUPService.buscarElemento(elemento.concepto, elemento.esSolicitud)" [prestacion]="prestacion" [registro]="elemento" [soloValores]="true">
                                                                    </rup>
                                                                    <div *ngIf="elemento.esSolicitud && prestacion.estados[prestacion.estados.length-1].tipo === 'validada'">
                                                                        <plex-button label="Asignar turno" type="primary" (click)="darTurno(elemento.prestacionSolicitud)"></plex-button>
                                                                    </div>
                                                                    <ng-container *ngIf="(elemento.concepto.semanticTag === 'hallazgo' || elemento.concepto.semanticTag ==='situación' || elemento.concepto.semanticTag === 'trastorno')">
                                                                        <!-- <ng-container *ngIf="prestacion.estados[prestacion.estados.length - 1].tipo !== 'validada'">
                                                                            <small *ngIf="elemento.esDiagnosticoPrincipal" class="badge badge-info">Diagnóstico principal</small>
                                                                        </ng-container> -->
                                                                        <ng-container *ngIf="codigosCie10 && codigosCie10[elemento.id] && codigosCie10[elemento.id].c2">
                                                                            <small *ngIf="elemento.esPrimeraVez" class="badge badge-info">Es primera vez</small>
                                                                        </ng-container>
                                                                    </ng-container>
                                                                </div>
                                                                <!-- <div class="col-1 m-0 p-0 text-center">
                                                                    <div class="text-info hover mdi mdi-24px mdi-arrow-{{ elemento.icon || 'left' }}-drop-circle-outline" (click)="elemento.icon = elemento.icon === 'down' ? 'left' : 'down'"></div>
                                                                </div> -->
                                                            </div>
                                                            <div class="row">
                                                                <div class="col-12">
                                                                    <div *ngIf="elemento?.valor?.evolucion" class="text-secondary">
                                                                        <b>Evolución: </b>{{ elemento.valor.evolucion }}
                                                                    </div>
                                                                    <div *ngIf="elemento?.valor?.motivo" class="text-secondary">
                                                                        <b>Motivo:</b> {{ elemento.valor.motivo || '(no definido)' }}
                                                                    </div>
                                                                    <div *ngIf="elemento?.valor?.indicaciones" class="text-secondary">
                                                                        <b>Indicaciones: </b> {{ elemento.valor.indicaciones || '(ninguna)' }}
                                                                    </div>
                                                                    <div *ngIf="elemento?.relacionadoCon && elemento?.relacionadoCon?.length > 0" class="text-secondary">
                                                                        <b>Relacionado con:</b> {{ elemento.relacionadoCon[0].concepto.term[0].toUpperCase() + elemento.relacionadoCon[0].concepto.term.slice(1)}}
                                                                    </div>
                                                                    <div *ngIf="(elemento.concepto.semanticTag === 'hallazgo' || elemento.concepto.semanticTag ==='situación' || elemento.concepto.semanticTag === 'trastorno')" class="text-secondary">
                                                                        <b>Inicio aproximado: </b>
                                                                        <ng-container *ngIf="!elemento?.evoluciones">{{ elemento.valor.fechaInicio | fromNow }}</ng-container>
                                                                        <ng-container *ngIf="elemento?.evoluciones">{{ elemento.evoluciones[0].fechaCarga | fromNow }}
                                                                        </ng-container>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <!-- <div class="rup-footer">
                                                                    <div class="row" *ngIf="(elemento.concepto.semanticTag === 'hallazgo' || elemento.concepto.semanticTag ==='situación' || elemento.concepto.semanticTag === 'trastorno')">
                                                                        <div class="col-6">
                                                                            <div *ngIf="!diagnosticoReadonly">
                                                                                <plex-bool [readonly]="diagnosticoReadonly" [(ngModel)]="elemento.esDiagnosticoPrincipal" type="slide" label="Diagnostico principal"
                                                                                    name="Diagnóstico principal" (click)="diagnosticoPrestacion(i)"></plex-bool>
                                                                            </div>
                                                                        </div>
                                                                        <div class="col-6" *ngIf="codigosCie10 && codigosCie10[elemento.id]">
                                                                            <plex-bool *ngIf="codigosCie10[elemento.id].c2" [(ngModel)]="elemento.esPrimeraVez" type="slide" label="Es primera vez" name="primeraVez"></plex-bool>
                                                                        </div>
                                                                    </div>
                                                                </div> -->
                                                    </div>
                                                </div>
                                            </ng-container>
                                        </div>
                                    </div>

                                </tab>
                            </ng-container>
                        </ng-container>
                    </tabs>

                </plex-box>
            </div>

            <!-- Panel Buscador SNOMED + HUDS -->
            <div class="col-4" *ngIf="prestacion">
                <plex-box>
                    <plex-tabs [activeIndex]="panelIndex">
                        <plex-tab label="Historia de Salud" (click)="panelIndex = 0">
                            <!-- HUDS [hudsBusqueda.component.ts] -->
                            <rup-hudsBusqueda [paciente]="prestacion?.paciente" [prestacionActual]="prestacion.id" [_dragScope]="'registros-rup'" (evtData)="ejecutarConceptoHuds($event)" (evtHuds)="agregarListadoHuds($event)" (_onDragStart)="arrastrandoConcepto(true)" (_onDragEnd)="arrastrandoConcepto(false)"></rup-hudsBusqueda>
                        </plex-tab>
                        <plex-tab label="Buscador" (click)="panelIndex = 1">
                            <!-- SNOMED [buscador.component.ts] -->
                            <rup-buscador (evtData)="ejecutarConcepto($event)" (_tipoDeBusqueda)="recibeTipoBusqueda($event)" (_onDragStart)="arrastrandoConcepto(true)" (_onDragEnd)="arrastrandoConcepto(false)"></rup-buscador>
                            <!-- Apunta a components/snomed/snomed-buscar.component.ts -->
                            <!-- <snomed-buscar [tipoBusqueda]="tipoBusqueda" [_dragScope]="['registros-rup', 'vincular-registros-rup']" (evtData)="ejecutarConcepto($event)" [arrayFrecuentes]="masFrecuentes" (_tipoDeBusqueda)="recibeTipoBusqueda($event)" (_onDragStart)="arrastrandoConcepto(true)"
                                (_onDragEnd)="arrastrandoConcepto(false)" (tagBusqueda)="recibeTipoBusqueda($event)"></snomed-buscar> -->
                        </plex-tab>
                    </plex-tabs>
                </plex-box>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer *ngIf="!showCambioPaciente">
        <div class="row">
            <div class="col-6 offset-3 text-center">
                <div droppable [dropScope]="'borrar-registros-rup'" (onDrop)="confirmarEliminarRegistro($event, 'footer')" [dragOverClass]="'drop-posicion-hover'" [hidden]="!isDraggingRegistro" class="drop-posicion" *ngIf="registros && registros.length">
                    <i class="mdi mdi-delete"></i> Quitar de la consulta
                </div>
                <div *ngIf="confirmarEliminar && scopeEliminar == 'footer'" class="confirmarDesvincular">
                    ¿Quitar de la consulta?

                    <div class="float-right">
                        <span (click)="confirmarEliminar = false;" class="hover">
                            Cancelar
                        </span> |
                        <span (click)="eliminarRegistro()" class="confirm hover">
                            Quitar
                        </span>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col" *ngIf="!showCambioPaciente">
                <plex-button label="Punto de Inicio" (click)="volver()" type="info"></plex-button>
                <plex-button label="Guardar {{prestacion?.solicitud?.tipoPrestacion?.term}}" (click)="guardarPrestacion()" type="success" class="float-right"></plex-button>
            </div>
        </div>

    </footer>
</form>
<!-- Búsqueda de pacientes -->
<pacientesSearch [bloquearCreate]="true" (selected)="cambiarElPaciente($event)" *ngIf="showCambioPaciente" [modoCompleto]="false" [mostrarCancelar]="true" (cancel)="showCambioPaciente = false"></pacientesSearch>
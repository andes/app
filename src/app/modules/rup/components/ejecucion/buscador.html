<!-- Apunta a components/snomed/snomed-buscar.component.ts -->
<snomed-buscar (loading)="Loader($event)" (_resultados)="recibeResultados($event)"></snomed-buscar>



<!-- MAESTRO DE PROBLEMAS - BD:tipoProblema -->
<div class="menu-buscador" *ngIf="!showRefSets">
    <plex-loader class="float-right" *ngIf="loading" type="ball-pulse"></plex-loader>
    <div class="filtros d-flex">
        <small class="pr-1">Filtros:</small>
        <small class="text-secondary ml-1">{{ reemplazar(filtroActual, ', ') }}</small>
        <small class="ml-3" *ngIf="searchTerm && resultados && resultados.length === 0 && !loading">
            No se han encontrado resultados
        </small>
    </div>
    <!-- Botones filtros -->
    <div class="row m-0 mt-3 mb-3 pb-3 d-flex botones-filtros">
        <div class="col m-0 p-0">
            <small *ngIf="(contadorSemanticTags['hallazgo'] + contadorSemanticTags['situacion']) > 0" class="badge badge-hallazgo ml-1 float-right">
                {{ contadorSemanticTags['hallazgo'] + contadorSemanticTags['situacion']}}</small>

            <button *ngIf="!showFrecuentes" (click)="filtroBuscadorSnomed(['hallazgo', 'situación'])" [ngClass]="{'active': getFiltroActual(['hallazgo', 'situación'])}" [disabled]="(contadorSemanticTags['hallazgo'] + contadorSemanticTags['situacion']) === 0" class="btn btn-block btn-hallazgo">
                HALLAZGOS
            </button>

            <button *ngIf="arrayFrecuentes && showFrecuentes" (click)="filtroFrecuentes(['hallazgo', 'situación'])" [ngClass]="{'active': getFiltroActual(['hallazgo', 'situación'])}" [disabled]="(contadorSemanticTags['hallazgo'] + contadorSemanticTags['situacion']) === 0"
                class="btn btn-block btn-hallazgo">
                HALLAZGOS
            </button>
        </div>

        <div class="col m-0 p-0">
            <small *ngIf="contadorSemanticTags['trastorno'] > 0" class="badge badge-trastorno ml-1 float-right"> {{ contadorSemanticTags['trastorno'] }}</small>

            <button *ngIf="!showFrecuentes" (click)="filtroBuscadorSnomed(['trastorno'])" [ngClass]="{'active': getFiltroActual(['trastorno'])}" [disabled]="contadorSemanticTags['trastorno'] === 0" class="btn btn-block btn-trastorno">
                TRASTORNOS
            </button>

            <button *ngIf="arrayFrecuentes && showFrecuentes" (click)="filtroFrecuentes(['trastorno'])" [ngClass]="{'active': getFiltroActual(['trastorno'])}" [disabled]="contadorSemanticTags['trastorno'] === 0" class="btn btn-block btn-trastorno">
                TRASTORNOS
            </button>
        </div>

        <div class="col m-0 p-0">
            <small *ngIf="(contadorSemanticTags['procedimiento'] + contadorSemanticTags['entidadObservable']) > 0" class="badge badge-procedimiento ml-1 float-right">
                {{ contadorSemanticTags['procedimiento'] + contadorSemanticTags['entidadObservable'] + contadorSemanticTags['regimenTratamiento']}}</small>

            <button *ngIf="!showFrecuentes" (click)="filtroBuscadorSnomed(['procedimiento', 'entidad observable', 'régimen/tratamiento'])" [ngClass]="{'active': getFiltroActual(['procedimiento', 'entidad observable', 'régimen/tratamiento'])}" [disabled]="(contadorSemanticTags['procedimiento'] + contadorSemanticTags['entidadObservable']) === 0"
                class="btn btn-block btn-procedimiento">
                PROCEDIMIENTOS
            </button>

            <button *ngIf="arrayFrecuentes && showFrecuentes" (click)="filtroFrecuentes(['procedimiento', 'entidad observable'])" class="btn btn-block btn-procedimiento" [ngClass]="{'active': getFiltroActual(['procedimiento', 'entidad observable'])}" [disabled]="(contadorSemanticTags['procedimiento'] + contadorSemanticTags['entidadObservable']) === 0">
                PROCEDIMIENTOS
            </button>
        </div>

        <div class="col m-0 p-0">
            <small *ngIf="contadorSemanticTags['procedimiento'] > 0" class="badge badge-plan ml-1 float-right"> {{ contadorSemanticTags['procedimiento'] + contadorSemanticTags['regimenTratamiento'] }}</small>

            <button *ngIf="!showFrecuentes" (click)="filtroBuscadorSnomed(['procedimiento'], 'planes')" class="btn btn-block btn-plan" [ngClass]="{'active': getFiltroActual(['planes'])}" [disabled]="contadorSemanticTags['procedimiento'] === 0">
                PLANES
            </button>

            <button *ngIf="arrayFrecuentes && showFrecuentes" (click)="filtroFrecuentes(['procedimiento'], 'planes')" class="btn btn-block btn-plan" [ngClass]="{'active': getFiltroActual(['planes'])}" [disabled]="contadorSemanticTags['procedimiento'] === 0">
                PLANES
            </button>

        </div>
        <div class="col m-0 p-0">
            <small *ngIf="contadorSemanticTags['producto'] > 0" class="badge badge-producto ml-1 float-right">
                {{ contadorSemanticTags['producto'] }}</small>
            <button *ngIf="!showFrecuentes" (click)="filtroBuscadorSnomed(['producto'])" class="btn btn-block btn-producto" [ngClass]="{'active': getFiltroActual(['producto'])}" [disabled]="contadorSemanticTags['producto'] === 0">
                PRODUCTOS
            </button>

            <button *ngIf="arrayFrecuentes && showFrecuentes" (click)="filtroFrecuentes(['producto'])" class="btn btn-block btn-producto" [ngClass]="{'active': getFiltroActual(['producto'])}" [disabled]="contadorSemanticTags['producto'] === 0">
                PRODUCTOS
            </button>
        </div>
    </div>
</div>

<div class="row" *ngIf="resultados && resultados.length > 0 && !loading">
    <div class="col-12">
        <b *ngIf="showFrecuentes">Frecuentes</b>
        <b *ngIf="showRefSets && !showGuiada">Búsqueda guiada</b>
    </div>
</div>
<div class="row" *ngIf="resultados && resultados.length > 0 && !loading">
    <div class="col-12">
        <button class="btn btn-primary btn-sm float-right m-1" (click)="showRefSets = true; showFrecuentes = false; showGuiada = false" *ngIf="!showRefSets || showFrecuentes">BÚSQUEDA GUIADA</button>
        <button class="btn btn-primary btn-sm float-right m-1" (click)="showRefSets = false; showFrecuentes = false; contarSemanticTags(resultadosAux);" *ngIf="showFrecuentes || showRefSets">BUSCADOR BASICO</button>
        <button class="btn btn-primary btn-sm float-right m-1" (click)="showRefSets = false; showFrecuentes = true; contarSemanticTags(arrayFrecuentes);" *ngIf="!showFrecuentes">MÁS FRECUENTES</button>
    </div>
</div>

<!-- RESULTADOS PRINCIPALES -->
<ul *ngIf="!showFrecuentes && !showRefSets && resultados && resultados.length > 0 && showFrecuentesTipoPrestacion" class="conceptos list-unstyled">
    <ng-container *ngFor="let item of resultados">
        <li draggable class="" *ngIf="!hideLista" [dragHandle]="'.drag-bar'" [dragScope]="_dragScope" [dragOverClass]="_dragOverClass" [dragData]="item" (onDragStart)="dragStart($e)" (onDragEnd)="dragEnd($e)">
            <div class="rup-card mini {{ ((tipoBusqueda === 'planes' || esTurneable(item)) ? 'planes' : ((item.semanticTag === 'régimen/tratamiento') ? 'regimen' : item.semanticTag)) }}">
                <div *ngIf="_dragScope" class=" type">
                    <i #dragHandle class="drag-bar drag-handle mdi mdi-drag-vertical"></i>
                </div>

                <div class="rup-content">
                    <div class="header row m-0 pl-0" [ngClass]="{'actions-left': tipoBusqueda === 'equipamientos'}">
                        <div class="title col-6">
                            {{ item.term }}
                        </div>
                        <div class="col pr-1" [ngClass]="{'float-right text-right': _dragScope, 'd-flex': tipoBusqueda === 'equipamientos'}">

                            <small class="badge badge-{{ ((tipoBusqueda === 'planes' || esTurneable(item)) ? 'plan' : ((item.semanticTag === 'régimen/tratamiento') ? 'regimen' : item.semanticTag)) }} text-default">{{ (tipoBusqueda === 'planes' || esTurneable(item)) ? 'plan' : item.semanticTag }}
                            </small>
                            <a href="javascript: void(0)" (click)="seleccionarConcepto(item)">
                                <i class="mdi mdi-plus-box"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

        </li>
    </ng-container>
</ul>

<div *ngIf="arrayFrecuentes && arrayFrecuentes.length > 0 && showFrecuentes">
    <ul class="conceptos list-unstyled">
        <ng-container *ngFor="let item of arrayFrecuentes">

            <li draggable [dragScope]="'registros-rup'" [dragData]="item" (onDragStart)="dragStart($e)" (onDragEnd)="dragEnd($e)">
                <div class="rup-card mini {{ ((tipoBusqueda === 'planes' || esTurneable(item)) ? 'planes' : ((item.semanticTag === 'régimen/tratamiento') ? 'regimen' : item.semanticTag)) }}">
                    <div class="type">
                        <i #dragHandle class="drag-bar mdi mdi-drag-vertical"></i>
                    </div>
                    <div class="rup-content">
                        <div class="header">
                            <div class="title">
                                {{item.term}}
                            </div>
                            <div class="actions">
                                <small class="badge badge-{{ ((tipoBusqueda === 'planes' || esTurneable(item)) ? 'plan' : ((item.semanticTag === 'régimen/tratamiento') ? 'regimen' : item.semanticTag)) }} text-default">{{ (tipoBusqueda === 'planes' || esTurneable(item)) ? 'plan' : item.semanticTag }}
                                </small>
                                <a href="javascript: void(0)" (click)="seleccionarConcepto(item)">
                                    <i class="mdi mdi-plus-box-outline"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </li>
        </ng-container>
    </ul>
</div>

<!-- refsetids -->
<div *ngIf="showRefSets && !showFrecuentes">

    <ul class="conceptos list-unstyled">
        <!-- <plex-accordion> -->
        <ng-container *ngFor="let items of arrayPorRefsets, let i = index;">
            <li>
                <div class="rup-card mini">
                    <div class="container rup-content">
                        <div class="row header">
                            <div class="col-10">
                                <b>{{items.nombre}}</b>
                            </div>
                            <div class="col-1">
                                <span class="badge-warning">
                                    {{ items.valor.length }}
                                </span>
                            </div>
                            <div class="col-1">
                                <a href="javascript: void(0)" class="btn btn-sm btn-primary" (click)='desplegar(i , items.nombre)'>
                                    <i class="mdi mdi-chevron-down"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>


                <div *ngIf="showContent === items.nombre">
                    <ng-container *ngIf="items.valor.length === 0">
                        <p>No hay resultados</p>
                    </ng-container>
                    <ul class="conceptos list-unstyled">
                        <ng-container *ngFor="let item of items.valor">
                            <li draggable class="" *ngIf="!hideLista" [dragHandle]="'.drag-bar'" [dragScope]="_dragScope" [dragOverClass]="_dragOverClass" [dragData]="item" (onDragStart)="dragStart($e)" (onDragEnd)="dragEnd($e)">
                                <div class="rup-card mini {{ ((tipoBusqueda === 'planes' || esTurneable(item)) ? 'planes' : ((item.semanticTag === 'régimen/tratamiento') ? 'regimen' : item.semanticTag)) }}">
                                    <div *ngIf="_dragScope" class=" type">
                                        <i #dragHandle class="drag-bar drag-handle mdi mdi-drag-vertical"></i>
                                    </div>
                                    <div class="rup-content">
                                        <div class="header" [ngClass]="{'actions-left': tipoBusqueda === 'equipamientos'}">
                                            <div class="title">
                                                {{ item.term }}
                                            </div>
                                            <div [ngClass]="{'actions': _dragScope, 'actions-left': tipoBusqueda === 'equipamientos'}">
                                                <small class="badge badge-{{ ((tipoBusqueda === 'planes' || esTurneable(item)) ? 'plan' : ((item.semanticTag === 'régimen/tratamiento') ? 'regimen' : item.semanticTag)) }} text-default">{{ item.semanticTag }}</small>
                                                <a href="javascript: void(0)" (click)="seleccionarConcepto(item)">
                                                    <i class="mdi mdi-plus-box-outline"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </ng-container>
                    </ul>
                </div>
            </li>
        </ng-container>
    </ul>
</div>

<div *ngIf="frecuentesTipoPrestacion && frecuentesTipoPrestacion.length > 0 && conceptosTurneables && conceptosTurneables.length && !showFrecuentesTipoPrestacion && !showRefSets">
    <p> Más frecuentes de {{conceptoFrecuente.term}} </p>
    <ul class="conceptos list-unstyled">
        <ng-container *ngFor="let item of frecuentesTipoPrestacion">
            <li draggable [dragScope]="'registros-rup'" [dragData]="item" (onDragStart)="dragStart($e)" (onDragEnd)="dragEnd($e)">
                <div class="rup-card mini {{ ((tipoBusqueda === 'planes' || esTurneable(item)) ? 'planes' : ((item.semanticTag === 'régimen/tratamiento') ? 'regimen' : item.semanticTag)) }}">
                    <div class="type">
                        <i #dragHandle class="drag-bar mdi mdi-drag-vertical"></i>
                    </div>
                    <div class="rup-content">
                        <div class="header">
                            <div class="title">
                                {{item.term}}
                            </div>
                            <div class="actions">
                                <small class="badge badge-{{ ((tipoBusqueda === 'planes' || esTurneable(item)) ? 'plan' : ((item.semanticTag === 'régimen/tratamiento') ? 'regimen' : item.semanticTag)) }} text-default">{{ (tipoBusqueda === 'planes' || esTurneable(item)) ? 'plan' : item.semanticTag }}
                                </small>
                                <a href="javascript: void(0)" (click)="seleccionarConcepto(item)">
                                    <i class="mdi mdi-plus-box-outline"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </li>
        </ng-container>
    </ul>
</div>
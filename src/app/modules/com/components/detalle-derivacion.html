<plex-title main titulo="Detalle de Derivación">
    <plex-button size="sm" type="danger" [icon]="'close'" (click)="cerrar()">
    </plex-button>
</plex-title>
<plex-options [items]="items" (activated)="cambiarOption($event)"></plex-options>
<div *ngIf="mostrar === 'derivacion'">
    <paciente-detalle [paciente]="derivacion.paciente" reload="true" orientacion="horizontal" [fields]="pacienteFields">
    </paciente-detalle>

    <plex-title size="sm" titulo="Datos de derivación">
        <plex-badge type="warning mr-1">
            {{derivacion.fecha | fecha}} {{derivacion.fecha | hora}}
        </plex-badge>
        <plex-badge *ngIf="derivacion.estado === 'solicitada' || derivacion.estado === 'asignada' || derivacion.estado === 'finalizada' "
                    type="info">
            {{derivacion.estado}}
        </plex-badge>
        <plex-badge *ngIf="derivacion.estado === 'habilitada'|| derivacion.estado === 'aceptada' || derivacion.estado === 'encomendada'"
                    type="success">
            {{derivacion.estado}}
        </plex-badge>
        <plex-badge *ngIf="derivacion.estado === 'inhabilitada' || derivacion.estado === 'rechazada'" type="danger">
            {{derivacion.estado}}
        </plex-badge>
    </plex-title>
    <plex-grid type="full" cols="2">
        <plex-label titulo="Organización origen" subtitulo="{{derivacion.organizacionOrigen.nombre}}">
        </plex-label>
        <plex-label titulo="Organización destino" subtitulo="{{derivacion.organizacionDestino.nombre}}">
        </plex-label>
        <plex-label titulo="Creada por" subtitulo="{{derivacion.createdBy | nombre}}">
        </plex-label>
        <plex-label titulo="Ultima actualización" subtitulo="{{derivacion.updatedAt
                                    | fecha}}  {{derivacion.updatedAt
                            | hora}}">
        </plex-label>
    </plex-grid>
    <plex-title size="sm" titulo="Nota"></plex-title>
    <plex-grid type="full" cols="1">
        {{derivacion.detalle}}
    </plex-grid>
    <plex-grid type="full" *ngIf="this.derivacion.adjuntos.length > 0" cols="1">
        <plex-title size="sm" titulo="Adjuntos"></plex-title>
        <div class="image-container hr-inline-group" *ngIf="fotos && fileToken">
            <ng-container *ngFor="let doc of this.derivacion.adjuntos; let i = index">
                <plex-visualizador [files]="documentos" #visualizador></plex-visualizador>
                <div class="image hover">
                    <img [src]="createUrl(doc)" alt="" *ngIf="esImagen(doc.ext)" (click)="visualizador.open(i)">
                    <a [href]="createUrl(doc)" target="_blank" *ngIf="!esImagen(doc.ext)" class="adjunto"
                       (click)="visualizador.open(i)">
                        {{ doc.ext }}
                    </a>
                </div>
            </ng-container>
        </div>
    </plex-grid>
    <div *ngIf="reglasDerivacionFiltradas.length > 0">
        <form #formEstado="ngForm">
            <plex-title size="sm" titulo="Actualizar estado">
            </plex-title>
            <plex-wrapper>
                <plex-select [(ngModel)]="reglaSeleccionada" label="Nuevo estado" name="estado"
                             placeholder="Seleccione un nuevo estado" idField="_id" labelField="estadoFinal"
                             [data]="reglasDerivacionFiltradas" [required]="true" grow="full">
                </plex-select>
                <plex-select *ngIf="reglaSeleccionada?.modificaDestino" [(ngModel)]="nuevoEstado.organizacionDestino"
                             name="organizacionOrigen" [data]="organizacionesDestino" label="Organización destino"
                             placeholder="Seleccione la organización destino" labelField="nombre" grow="full"
                             [required]="true">
                </plex-select>
                <plex-radio *ngIf="reglaSeleccionada?.definePrioridad" [(ngModel)]="prioridad" label="Prioridad"
                            type="horizontal" name="prioridad" [data]="opcionesPrioridad" [required]="true" grow="full">
                </plex-radio>
                <plex-text [(ngModel)]="nuevoEstado.observacion" label="Observacion" name="observacion" multiline="true"
                           grow="full">
                </plex-text>
                <input type="file" (change)="changeListener($event)" style="display:none;" #upload>
                <plex-button class="mt-2" *ngIf="!waiting" type="primary" size="sm" label="Subir archivo"
                             (click)="upload.click()">
                </plex-button>
            </plex-wrapper>
            <plex-wrapper *ngIf="adjuntosEstado.length > 0">
                <span *ngIf="!waiting">
                    <span *ngIf="errorExt">
                        <plex-badge type="danger"> Archivo inválido </plex-badge>
                    </span>
                </span>
                <span *ngIf="waiting">
                    <plex-loader class="app-waiting" type="ball-pulse-sync"></plex-loader>
                    <plex-button type="danger" class="btn-sm" label="Cancelar" (click)="cancelarAdjunto()">
                    </plex-button>
                </span>
                <div class="image-container hr-inline-group" *ngIf="adjuntosEstado && fileToken">
                    <ng-container *ngFor="let doc of adjuntosEstado; let i = index">
                        <plex-visualizador [files]="documentosUrl" #visualizador></plex-visualizador>
                        <div class="image hover">
                            <img [src]="createUrl(doc)" alt="" *ngIf="esImagen(doc.ext)" (click)="visualizador.open(i)">
                            <a [href]="createUrl(doc)" target="_blank" *ngIf="!esImagen(doc.ext)" class="adjunto"
                               (click)="visualizador.open(i)">
                                {{ doc.ext }}
                            </a>
                            <div class="x-mark" (click)="removeFile(doc)">
                                <span class="close"></span>
                            </div>
                        </div>
                    </ng-container>
                </div>
            </plex-wrapper>
            <div class="w-100" justify>
                <plex-button type="danger" (click)="cerrar()">
                    Cancelar
                </plex-button>
                <plex-button type="success" (click)="actualizarEstado($event)" [validateForm]="formEstado">
                    Guardar
                </plex-button>
            </div>
        </form>
    </div>
</div>
<div *ngIf="mostrar === 'historial'">
    <historial-derivacion *ngIf="derivacion && derivacion.historial.length > 0" [derivacion]="derivacion">
    </historial-derivacion>
</div>
